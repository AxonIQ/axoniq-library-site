<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Consuming Events from Kafka</title>
    <link rel="prev" href="publishing.html">
    <link rel="next" href="message-format.html">
    <meta name="generator" content="Antora 3.1.1">
    <link rel="stylesheet" href="../_/css/site.css">
    <link rel="stylesheet" href="../_/css/vendor/tabs.css">
    <link rel="icon" href="../_/img/favicon.ico" sizes="32x32">
    <link rel="icon" href="../_/img/icon.svg" type="image/svg+xml" media="(prefers-color-scheme: light)">
    <link rel="icon" href="../_/img/icon-light.svg" type="image/svg+xml" media="(prefers-color-scheme: dark)">
    <link rel="apple-touch-icon" href="../_/img/apple-touch-icon.png"><!-- 180Ã—180 -->
    <link rel="manifest" href="../_/static/manifest.webmanifest">
        <!-- Google Tag Manager -->
        <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer','GTM-5QD58ZB');</script>
        <!-- End Google Tag Manager -->

    <script>var uiRootPath = '../_'</script>


  </head>
  <body class="article">

    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5QD58ZB"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://library.axoniq.io"><img src="../_/img/logo-dark.png" class="header_logo" /></a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="../home/basics.html">Basics</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link">Guides</a>
          <div class="navbar-dropdown card">
              <a class="navbar-item" href="../home/guides/axon-framework.html">Axon Framework</a>
              <a class="navbar-item" href="../home/guides/axon-server.html">Axon Server</a>
              <a class="navbar-item" href="../home/guides/migration.html">Migration</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link">Reference</a>
          <div class="navbar-dropdown card">
                <a class="navbar-item" href="../axon_framework_ref/introduction.html">Axon Framework</a>
                <a class="navbar-item" href="../axon_server_ref/v2024.1/index.html">Axon Server</a>
                <a class="navbar-item" href="../synapse_ref/latest/index.html">Axon Synapse</a>
                <a class="navbar-item" href="../axoniq_console_ref/main/index.html">AxonIQ Console</a>
          </div>
        </div>
      </div>
      <div class="navbar-end">
        <div class="navbar-item search hide-for-print">
          <div id="search-field" class="field">
            <input id="search-input" type="text" placeholder="Search AxonIQ Docs">
          </div>
        </div>
        <a class="navbar-item navbar-button" href="https://academy.axoniq.io" target="_blank">AxonIQ Academy</a>
        <a class="navbar-item navbar-button" href="https://discuss.axoniq.io" target="_blank">AxonIQ Discuss</a>
      </div>
    </div>
  </nav>
</header>
<div class="toolbar card" role="navigation">
<button class="nav-toggle"></button>
  <a href="../home/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Kafka Extension Guide</a></li>
    <li><a href="consuming.html">Consuming Events From Kafka</a></li>
  </ul>
</nav>
<div class="page-actions">
  <button class="actions-menu-toggle" title="Show actions related to this page">Actions</button>
  <div class="actions-menu toolbar_dropdown_menu card">
      <a class="action item" href="https://github.com/AxonFramework/extension-kafka/edit/master/docs/extension-guide/modules/ROOT/pages/consuming.adoc">Edit this Page</a>
    
    <a class="action item" href="https://discuss.axoniq.io/search?q&#x3D;https%3A%2F%2Flibrary.axoniq.io%2Fkafka_extension_guide%2Fconsuming.html%20%23library" target="discuss_search">View Discussions</a>
    <a class="action item" href="https://discuss.axoniq.io/new-topic?category&#x3D;library&amp;title&#x3D;%22Consuming%20Events%20from%20Kafka%22%20library%20page%20...&amp;body&#x3D;%3C!--%20Replace%20this%20comment%20with%20your%20comment%2Fsuggestion%2Fquestion%2F...%20--%3E%0A%0A%0A%3C!--%0AKeep%20the%20section%20below!%0ALinking%20back%20to%20the%20documentation%20URL%20not%20only%20helps%20people%20go%20to%20the%20page%0Abut%20also%20helps%20find%20relevant%20discussions%20from%20the%20documentation%20page%20via%20the%20%22View%20Discussion%22%20menu.%0A--%3E%0A%5Bdetails%3D%22Related%20library%20page%22%5D%0A%5BConsuming%20Events%20from%20Kafka%5D(https%3A%2F%2Flibrary.axoniq.io%2Fkafka_extension_guide%2Fconsuming.html)%0A%5B%2Fdetails%5D%0A" target="discuss_add">Start new discussion</a>
  </div>
</div>


</div>
<div class="body">
<div class="nav-container" data-component="kafka_extension_guide" data-version="master">
  <aside class="nav card">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">Kafka Extension Guide</a></h3>

<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">Kafka Extension Guide</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="publishing.html">Publishing Events to Kafka</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="consuming.html">Consuming Events From Kafka</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="message-format.html">Customizing Event Message Format</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="springboot-configuration.html">Configuration in SpringBoot</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
    <div class="content">
        <aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
          <article class="doc">
            <h1 class="page">Consuming Events from Kafka</h1>
            <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Event messages in an Axon application can be consumed through either a Subscribing or a Tracking <a href="../axon_framework_ref/events/event-processors/README.html" class="xref page">Event Processor</a>. Both options are maintained when it comes to consuming events from a Kafka topic, which from a set-up perspective translates to a <a href="#subscribable-message-source">SubscribableMessageSource</a> or a <a href="#streamable-messasge-source">StreamableKafkaMessageSource</a> respectively, Both will be described in more detail later on, as we first shed light on the general requirements for event consumption in Axon through Kafka.</p>
</div>
<div class="paragraph">
<p>Both approaches use a similar mechanism to poll events with a Kafka <code>Consumer</code>, which breaks down to a combination of a <code>ConsumerFactory</code> and a <code>Fetcher</code>. The extension provides a <code>DefaultConsumerFactory</code>, whose sole requirement is a <code>Map</code> of configuration properties. The <code>Map</code> contains the settings to use for the Kafka <code>Consumer</code> client, such as the Kafka instance locations. Please check the <a href="https://kafka.apache.org/" class="external" target="_blank" rel="noopener">Kafka documentation</a> for the possible settings and their values.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class KafkaEventConsumptionConfiguration {
    // ...
    public ConsumerFactory&lt;String, byte[]&gt; consumerFactory(Map&lt;String, Object&gt; consumerConfiguration) {
        return new DefaultConsumerFactory&lt;&gt;(consumerConfiguration);
    }
    // ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is the <code>Fetcher</code> instance&#8217;s job to retrieve the actual messages from Kafka by directing a <code>Consumer</code> instance it receives from the message source. You can draft up your own implementation or use the provided <code>AsyncFetcher</code> to this end. The <code>AsyncFetcher</code> doesn&#8217;t need to be explicitly started, as it will react on the message source starting it. It does need to be shut down, to ensure any thread pool or active connections are properly closed.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class KafkaEventConsumptionConfiguration {
    // ...
    public Fetcher&lt;?, ?, ?&gt; fetcher(long timeoutMillis,
                                    ExecutorService executorService) {
        return AsyncFetcher.builder()
                           .pollTimeout(timeoutMillis)          // Defaults to "5000" milliseconds
                           .executorService(executorService)    // Defaults to a cached thread pool executor
                           .build();
    }
    // ...
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="subscribable-message-source"><a class="anchor" href="#subscribable-message-source"></a>Consuming Events with a subscribable message source</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Using the <code>SubscribableKafkaMessageSource</code> means you are inclined to use a <code>SubscribingEventProcessor</code> to consume the events in your event handlers.</p>
</div>
<div class="paragraph">
<p>When using this source, Kafka&#8217;s idea of pairing <code>Consumer</code> instances into "Consumer Groups" is used. This is strengthened by making the <code>groupId</code> upon source construction a <em>hard requirement</em>. To use a common <code>groupId</code> essentially means that the event-stream-workload can be shared on Kafka&#8217;s terms, whereas a <code>SubscribingEventProcessor</code> typically works on its own accord regardless of the number of instances. The workload sharing can be achieved by having several application instances with the same <code>groupId</code> or by adjusting the consumer count through the <code>SubscribableKafkaMessageSource</code> builder. The same benefit holds for <a href="../axon_framework_ref/events/event-processors/streaming.html#replaying-events" class="xref page">resetting</a> an event stream, which in Axon is reserved to the <code>TrackingEventProcessor</code>, but is now opened up through Kafka&#8217;s own API&#8217;s.</p>
</div>
<div class="paragraph">
<p>Although the <code>SubscribableKafkaMessageSource</code> thus provides the niceties the tracking event processor normally provides, it does come with two catches:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Axon&#8217;s approach of the <code>SequencingPolicy</code> to deduce which thread receives which events is entirely lost. It is thus dependent on which topic-partition pairs are given to a <code>Consumer</code> for the events your handlers receives.
From a usage perspective this means event message ordering is no longer guaranteed by Axon.
It is thus the user&#8217;s job to ensure events are published in the right topic-partition pair.</p>
</li>
<li>
<p>The API Axon provides for resets is entirely lost, since this API can only be correctly triggered through the <code>TrackingEventProcessor#resetTokens</code> operation</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Due to the above it is recommended the user is knowledgeable about Kafka&#8217;s specifics on message consumption.</p>
</div>
<div class="paragraph">
<p>When it comes to configuring a <code>SubscribableKafkaMessageSource</code> as a message source for a <code>SubscribingEventProcessor</code>, there is one additional requirement beside source creation and registration. The source should only start with polling for events as soon as all interested subscribing event processors have been subscribed to it. To ensure the <code>SubscribableKafkaMessageSource#start()</code> operation is called at the right point in the configuration lifecycle, the <code>KafkaMessageSourceConfigurer</code> should be utilized:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class KafkaEventConsumptionConfiguration {
    // ...
    public KafkaMessageSourceConfigurer kafkaMessageSourceConfigurer(Configurer configurer) {
        KafkaMessageSourceConfigurer kafkaMessageSourceConfigurer = new KafkaMessageSourceConfigurer();
        configurer.registerModule(kafkaMessageSourceConfigurer);
        return kafkaMessageSourceConfigurer;
    }

    public SubscribableKafkaMessageSource&lt;String, byte[]&gt; subscribableKafkaMessageSource(List&lt;String&gt; topics,
                                                                                         String groupId,
                                                                                         ConsumerFactory&lt;String, byte[]&gt; consumerFactory,
                                                                                         Fetcher&lt;String, byte[], EventMessage&lt;?&gt;&gt; fetcher,
                                                                                         KafkaMessageConverter&lt;String, byte[]&gt; messageConverter,
                                                                                         int consumerCount,
                                                                                         KafkaMessageSourceConfigurer kafkaMessageSourceConfigurer) {
        SubscribableKafkaMessageSource&lt;String, byte[]&gt; subscribableKafkaMessageSource = SubscribableKafkaMessageSource.&lt;String, byte[]&gt;builder()
                .topics(topics)                     // Defaults to a collection of "Axon.Events"
                .groupId(groupId)                   // Hard requirement
                .consumerFactory(consumerFactory)   // Hard requirement
                .fetcher(fetcher)                   // Hard requirement
                .messageConverter(messageConverter) // Defaults to a "DefaultKafkaMessageConverter"
                .consumerCount(consumerCount)       // Defaults to a single Consumer
                .build();
        // Registering the source is required to tie into the Configurers lifecycle to start the source at the right stage
        kafkaMessageSourceConfigurer.registerSubscribableSource(configuration -&gt; subscribableKafkaMessageSource);
        return subscribableKafkaMessageSource;
    }

    public void configureSubscribableKafkaSource(EventProcessingConfigurer eventProcessingConfigurer,
                                                 String processorName,
                                                 SubscribableKafkaMessageSource&lt;String, byte[]&gt; subscribableKafkaMessageSource) {
        eventProcessingConfigurer.registerSubscribingEventProcessor(
                processorName,
                configuration -&gt; subscribableKafkaMessageSource
        );
    }
    // ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The <code>KafkaMessageSourceConfigurer</code> is an Axon <code>ModuleConfiguration</code> which ties in to the start and end lifecycle of the application. It should receive the <code>SubscribableKafkaMessageSource</code> as a source which should start and stop. The <code>KafkaMessageSourceConfigurer</code> instance itself should be registered as a module to the main <code>Configurer</code>.</p>
</div>
<div class="paragraph">
<p>If only a single subscribing event processor will be subscribed to the Kafka message source, <code>SubscribableKafkaMessageSource.Builder#autoStart()</code> can be toggled on. This will start the <code>SubscribableKafkaMessageSource</code> upon the first subscription.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="streamable-messasge-source"><a class="anchor" href="#streamable-messasge-source"></a>Consuming Events with a streamable message source</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Using the <code>StreamableKafkaMessageSource</code> means you are inclined to use a <code>TrackingEventProcessor</code> to consume the events in your event handlers.</p>
</div>
<div class="paragraph">
<p>Whereas the <a href="#subscribable-message-source">subscribable Kafka message</a> source uses Kafka&#8217;s idea of sharing the workload through multiple <code>Consumer</code> instances in the same "Consumer Group", the streamable approach doesn&#8217;t use a consumer group, and assigns all available partitions.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class KafkaEventConsumptionConfiguration {
    // ...
    public StreamableKafkaMessageSource&lt;String, byte[]&gt; streamableKafkaMessageSource(List&lt;String&gt; topics,
                                                                                     ConsumerFactory&lt;String, byte[]&gt; consumerFactory,
                                                                                     Fetcher&lt;String, byte[], KafkaEventMessage&gt; fetcher,
                                                                                     KafkaMessageConverter&lt;String, byte[]&gt; messageConverter,
                                                                                     int bufferCapacity) {
        return StreamableKafkaMessageSource.&lt;String, byte[]&gt;builder()
                .topics(topics)                                                 // Defaults to a collection of "Axon.Events"
                .consumerFactory(consumerFactory)                               // Hard requirement
                .fetcher(fetcher)                                               // Hard requirement
                .messageConverter(messageConverter)                             // Defaults to a "DefaultKafkaMessageConverter"
                .bufferFactory(
                        () -&gt; new SortedKafkaMessageBuffer&lt;&gt;(bufferCapacity))   // Defaults to a "SortedKafkaMessageBuffer" with a buffer capacity of "1000"
                .build();
    }

    public void configureStreamableKafkaSource(EventProcessingConfigurer eventProcessingConfigurer,
                                               String processorName,
                                               StreamableKafkaMessageSource&lt;String, byte[]&gt; streamableKafkaMessageSource) {
        eventProcessingConfigurer.registerTrackingEventProcessor(
                processorName,
                configuration -&gt; streamableKafkaMessageSource
        );
    }
    // ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that as with any tracking event processor, the progress on the event stream is stored in a <code>TrackingToken</code>. Using the <code>StreamableKafkaMessageSource</code> means a <code>KafkaTrackingToken</code> containing topic-partition to offset pairs is stored in the <code>TokenStore</code>. If no other <code>TokenStore</code> is provided, and auto-configuration is used, a <code>KafkaTokenStore</code> will be set instead of an <code>InMemoryTokenStore</code>. The <code>KafkaTokenStore</code> by default uses the <code>__axon_token_store_updates</code> topic. This should be a compacted topic, which should be created and configured automatically.</p>
</div>
</div>
</div>
        <nav class="pagination">
  <span class="prev"><a href="publishing.html">Publishing Events to Kafka</a></span>
  <span class="next"><a href="message-format.html">Customizing Event Message Format</a></span>
</nav>
    </article>
  </div>
</main>
</div>
<footer class="footer">
  <div class="primary-footer">
    <div class="footer-logo ">
      <a href="https://axoniq.io/">
        <img src="https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=90&amp;height=20&amp;name=Logo%20AxonIQ%20(2).png" alt="Logo AxonIQ" loading="lazy" srcset="https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=45&amp;height=10&amp;name=Logo%20AxonIQ%20(2).png 45w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=90&amp;height=20&amp;name=Logo%20AxonIQ%20(2).png 90w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=135&amp;height=30&amp;name=Logo%20AxonIQ%20(2).png 135w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=180&amp;height=40&amp;name=Logo%20AxonIQ%20(2).png 180w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=225&amp;height=50&amp;name=Logo%20AxonIQ%20(2).png 225w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=270&amp;height=60&amp;name=Logo%20AxonIQ%20(2).png 270w" sizes="(max-width: 90px) 100vw, 90px" width="90" height="20">
      </a>
    </div>

    <div class="footer-menu">
	    <h3>Products</h3>
	    <div>
        <ul role="menu">
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/products/axon-framework">Axon Framework</a></li>
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/products/axon-server">Axon Server</a></li>
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/products/axoniq-cloud">AxonIQ Cloud</a></li>
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/products/axoniq-console">AxonIQ Console</a></li>
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/products/axon-synapse">Axon Synapse</a></li>
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/blog/protect-sensitive-data-in-an-event-sourced-application">AxonIQ Data Protection</a></li>
        </ul>
      </div>
    </div>

    <div class="footer-menu">
	    <h3>Sites</h3>
	    <div>
        <ul role="menu">
          <li><a class="ext" target="_blank" href="http://support.axoniq.io/">Customer Support Portal</a></li>
          <li><a class="ext" target="_blank" href="https://academy.axoniq.io/">AxonIQ Academy</a></li>
          <li><a class="ext" target="_blank" href="https://console.axoniq.io/">AxonIQ Console</a></li>
          <li><a class="ext" target="_blank" href="https://discuss.axoniq.io/">AxonIQ Discuss</a></li>
          <li><a class="ext" target="_blank" href="https://console.cloud.axoniq.io">AxonIQ Cloud</a></li>
        </ul>
      </div>
    </div>

    <div class="footer-menu">
	    <h3>Follow us</h3>
	    <div>
        <ul role="menu">
          <li><a class="ext" target="_blank" href="https://www.youtube.com/axoniq">YouTube</a></li>
          <li><a class="ext" target="_blank" href="https://www.linkedin.com/company/axoniq">LinkedIn</a></li>
          <li><a class="ext" target="_blank" href="https://www.facebook.com/AxonIQ.io">Facebook</a></li>
          <li><a class="ext" target="_blank" href="https://twitter.com/axon_iq">Twitter</a></li>
          <li><a class="ext" target="_blank" href="https://github.com/AxonIQ">GitHub</a></li>
          <li><a class="ext" target="_blank" href="https://medium.com/axoniq">Medium</a></li>
        </ul>
      </div>
    </div>
  </div>
</footer>
<script id="site-script" src="../_/js/site.js" data-ui-root-path="../_"></script>
<script async src="../_/js/vendor/highlight.js"></script>
<script async src="../_/js/vendor/page-actions.js"></script>
<script async src="../_/js/vendor/tabs.js" data-sync-storage-key="preferred-tab" data-sync-storage-scope="session"></script>
<script src="../_/js/vendor/lunr.js"></script>
<script src="../_/js/search-ui.js" id="search-ui-script" data-site-root-path=".." data-snippet-length="100" data-stylesheet="../_/css/search.css"></script>
<script async src="../search-index.js"></script>
  </body>
</html>
