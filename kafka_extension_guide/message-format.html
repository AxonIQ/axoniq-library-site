<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Customizing Event Message Format</title>
    <link rel="prev" href="consuming.html">
    <link rel="next" href="springboot-configuration.html">
    <meta name="generator" content="Antora 3.1.1">
    <link rel="stylesheet" href="../_/css/site.css">
    <link rel="stylesheet" href="../_/css/vendor/tabs.css">

        <!-- Google Tag Manager -->
        <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer','GTM-5QD58ZB');</script>
        <!-- End Google Tag Manager -->

    <script>var uiRootPath = '../_'</script>


  </head>
  <body class="article">

    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5QD58ZB"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://library.axoniq.io">Docs</a>
      <div class="navbar-item search hide-for-print">
        <div id="search-field" class="field">
          <input id="search-input" type="text" placeholder="Search the docs">
        </div>
      </div>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="../home/basics.html">Basics</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link">Guides</a>
          <div class="navbar-dropdown">
              <a class="navbar-item" href="../home/guides/axon-framework.html">Axon Framework</a>
              <a class="navbar-item" href="../home/guides/axon-server.html">Axon Server</a>
              <a class="navbar-item" href="../home/guides/migration.html">Migration</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link">Reference</a>
          <div class="navbar-dropdown">
                <a class="navbar-item" href="../axon_framework_ref/introduction.html">Axon Framework</a>
                <a class="navbar-item" href="../axon_server_ref/index.html">Axon Server</a>
                <a class="navbar-item" href="../synapse_ref/latest/index.html">Axon Synapse</a>
                <a class="navbar-item" href="../axoniq_console_ref/main/index.html">AxonIQ Console</a>
          </div>
        </div>
        <a class="navbar-item" href="https://academy.axoniq.io" target="_blank">AxonIQ Academy</a>
        <a class="navbar-item" href="https://discuss.axoniq.io" target="_blank">AxonIQ Discuss</a>
      </div>
    </div>
  </nav>
</header>
<div class="body">
<div class="nav-container" data-component="kafka_extension_guide" data-version="master">
  <aside class="nav">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">Kafka Extension Guide</a></h3>

<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="index.html">Kafka Extension Guide</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="publishing.html">Publishing Events to Kafka</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="consuming.html">Consuming Events From Kafka</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="message-format.html">Customizing Event Message Format</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="springboot-configuration.html">Configuration in SpringBoot</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
  <div class="toolbar" role="navigation">
<button class="nav-toggle"></button>
  <a href="../home/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Kafka Extension Guide</a></li>
    <li><a href="message-format.html">Customizing Event Message Format</a></li>
  </ul>
</nav>
<div class="page-actions">
  <button class="actions-menu-toggle" title="Show actions related to this page">Actions</button>
  <div class="actions-menu">
      <a class="action" href="https://github.com/AxonFramework/extension-kafka/edit/master/docs/extension-guide/modules/ROOT/pages/message-format.adoc">Edit this Page</a>
    
    <a class="action" href="https://discuss.axoniq.io/search?q&#x3D;https%3A%2F%2Flibrary.axoniq.io%2Fkafka_extension_guide%2Fmessage-format.html%20%23library" target="discuss_search">View Discussions</a>
    <a class="action" href="https://discuss.axoniq.io/new-topic?category&#x3D;library&amp;title&#x3D;%22Customizing%20Event%20Message%20Format%22%20library%20page%20...&amp;body&#x3D;%3C!--%20Replace%20this%20comment%20with%20your%20comment%2Fsuggestion%2Fquestion%2F...%20--%3E%0A%0A%0A%3C!--%0AKeep%20the%20section%20below!%0ALinking%20back%20to%20the%20documentation%20URL%20not%20only%20helps%20people%20go%20to%20the%20page%0Abut%20also%20helps%20find%20relevant%20discussions%20from%20the%20documentation%20page%20via%20the%20%22View%20Discussion%22%20menu.%0A--%3E%0A%5Bdetails%3D%22Related%20library%20page%22%5D%0A%5BCustomizing%20Event%20Message%20Format%5D(https%3A%2F%2Flibrary.axoniq.io%2Fkafka_extension_guide%2Fmessage-format.html)%0A%5B%2Fdetails%5D%0A" target="discuss_add">Start new discussion</a>
  </div>
</div>


</div>
    <div class="content">
        <aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
          <article class="doc">
            <h1 class="page">Customizing Event Message Format</h1>
            <div class="paragraph">
<p>In the previous sections the <code>KafkaMessageConverter&lt;K, V&gt;</code> has been shown as a requirement for event production and consumption. The <code>K</code> is the format of the message&#8217;s key, where the <code>V</code> stand for the message&#8217;s value. The extension provides a <code>DefaultKafkaMessageConverter</code> which converts an axon <code>EventMessage</code> to a Kafka <code>ProducerRecord</code>, and an <code>ConsumerRecord</code> back into an <code>EventMessage</code>. This <code>DefaultKafkaMessageConverter</code> uses <code>String</code> as the key and <code>byte[]</code> as the value of the message to de-/serialize.</p>
</div>
<div class="paragraph">
<p>Albeit the default, this implementation allows for some customization, such as how the <code>EventMessage</code> <code>MetaData</code> is mapped to Kafka headers. This is achieved by adjusting the "header value mapper" in the <code>DefaultKafkaMessageConverter</code> builder.</p>
</div>
<div class="paragraph">
<p>The <code>SequencingPolicy</code> can be adjusted to change the behaviour of the record key being used. The default sequencing policy is the <code>SequentialPerAggregatePolicy</code>, which leads to the aggregate identifier of an event being the key of a <code>ProducerRecord</code> and <code>ConsumerRecord</code>.</p>
</div>
<div class="paragraph">
<p>The format of an event message defines an API between the producer and the consumer of the message. This API may change over time, leading to incompatibility between the event class' structure on the receiving side and the event structure of a message containing the old format. Axon addresses the topic of <a href="../axon_framework_ref/events/event-versioning.html" class="xref page">Event Versioning</a> by introducing Event Upcasters. The <code>DefaultKafkaMessageConverter</code> supports this by provisioning an <code>EventUpcasterChain</code> and run the upcasting process on the <code>MetaData</code> and <code>Payload</code> of individual messages converted from <code>ConsumerRecord</code> before those are passed to the <code>Serializer</code> and converted into <code>Event</code> instances.</p>
</div>
<div class="paragraph">
<p>Note that the <code>KafkaMessageConverter</code> feeds the upcasters with messages one-by-one, limiting it to one-to-one or one-to-many upcasting only. Upcasters performing a many-to-one or many-to-many operation thus won&#8217;t be able to operate inside the extension (yet).</p>
</div>
<div class="paragraph">
<p>Lastly, the <code>Serializer</code> used by the converter can be adjusted. See the <a href="../axon_framework_ref/serialization.html" class="xref page">Serializer</a> section for more details on this.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class KafkaMessageConversationConfiguration {
    // ...
    public KafkaMessageConverter&lt;String, byte[]&gt; kafkaMessageConverter(Serializer serializer,
                                                                       SequencingPolicy&lt;? super EventMessage&lt;?&gt;&gt; sequencingPolicy,
                                                                       BiFunction&lt;String, Object, RecordHeader&gt; headerValueMapper,
                                                                       EventUpcasterChain upcasterChain) {
        return DefaultKafkaMessageConverter.builder()
                                           .serializer(serializer)                  // Hard requirement
                                           .sequencingPolicy(sequencingPolicy)      // Defaults to a "SequentialPerAggregatePolicy"
                                           .upcasterChain(upcasterChain)            // Defaults to empty upcaster chain
                                           .headerValueMapper(headerValueMapper)    // Defaults to "HeaderUtils#byteMapper()"
                                           .build();
    }
    // ...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Make sure to use an identical <code>KafkaMessageConverter</code> on both the producing and consuming end, as otherwise exception upon deserialization should be expected. A <code>CloudEventKafkaMessageConverter</code> is also available using the <a href="https://cloudevents.io/" class="external" target="_blank" rel="noopener">Cloud Events spec</a>.</p>
</div>
        <nav class="pagination">
  <span class="prev"><a href="consuming.html">Consuming Events From Kafka</a></span>
  <span class="next"><a href="springboot-configuration.html">Configuration in SpringBoot</a></span>
</nav>
    </article>
  </div>
</main>
</div>
<footer class="footer">
  <div class="primary-footer">
    <div class="footer-logo ">
      <a href="https://axoniq.io/">
        <img src="https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=90&amp;height=20&amp;name=Logo%20AxonIQ%20(2).png" alt="Logo AxonIQ" loading="lazy" srcset="https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=45&amp;height=10&amp;name=Logo%20AxonIQ%20(2).png 45w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=90&amp;height=20&amp;name=Logo%20AxonIQ%20(2).png 90w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=135&amp;height=30&amp;name=Logo%20AxonIQ%20(2).png 135w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=180&amp;height=40&amp;name=Logo%20AxonIQ%20(2).png 180w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=225&amp;height=50&amp;name=Logo%20AxonIQ%20(2).png 225w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=270&amp;height=60&amp;name=Logo%20AxonIQ%20(2).png 270w" sizes="(max-width: 90px) 100vw, 90px" width="90" height="20">
      </a>
    </div>

    <div class="footer-menu">
	    <h3>Products</h3>
	    <div>
        <ul role="menu">
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/products/axon-framework">Axon Framework</a></li>
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/products/axon-server">Axon Server</a></li>
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/products/axoniq-cloud">AxonIQ Cloud</a></li>
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/products/axoniq-console">AxonIQ Console</a></li>
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/products/axon-synapse">Axon Synapse</a></li>
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/blog/protect-sensitive-data-in-an-event-sourced-application">AxonIQ Data Protection</a></li>
        </ul>
      </div>
    </div>

    <div class="footer-menu">
	    <h3>Sites</h3>
	    <div>
        <ul role="menu">
          <li><a class="ext" target="_blank" href="http://support.axoniq.io/">Customer Support Portal</a></li>
          <li><a class="ext" target="_blank" href="https://academy.axoniq.io/">AxonIQ Academy</a></li>
          <li><a class="ext" target="_blank" href="https://console.axoniq.io/">AxonIQ Console</a></li>
          <li><a class="ext" target="_blank" href="https://discuss.axoniq.io/">AxonIQ Discuss</a></li>
          <li><a class="ext" target="_blank" href="https://console.cloud.axoniq.io">AxonIQ Cloud</a></li>
        </ul>
      </div>
    </div>

    <div class="footer-menu">
	    <h3>Follow us</h3>
	    <div>
        <ul role="menu">
          <li><a class="ext" target="_blank" href="https://www.youtube.com/axoniq">YouTube</a></li>
          <li><a class="ext" target="_blank" href="https://www.linkedin.com/company/axoniq">LinkedIn</a></li>
          <li><a class="ext" target="_blank" href="https://www.facebook.com/AxonIQ.io">Facebook</a></li>
          <li><a class="ext" target="_blank" href="https://twitter.com/axon_iq">Twitter</a></li>
          <li><a class="ext" target="_blank" href="https://github.com/AxonIQ">GitHub</a></li>
          <li><a class="ext" target="_blank" href="https://medium.com/axoniq">Medium</a></li>
        </ul>
      </div>
    </div>
  </div>
</footer>
<script id="site-script" src="../_/js/site.js" data-ui-root-path="../_"></script>
<script async src="../_/js/vendor/highlight.js"></script>
<script async src="../_/js/vendor/page-actions.js"></script>
<script async src="../_/js/vendor/tabs.js" data-sync-storage-key="preferred-tab" data-sync-storage-scope="session"></script>
<script src="../_/js/vendor/lunr.js"></script>
<script src="../_/js/search-ui.js" id="search-ui-script" data-site-root-path=".." data-snippet-length="100" data-stylesheet="../_/css/search.css"></script>
<script async src="../search-index.js"></script>
  </body>
</html>
