<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Implementation</title>
    <link rel="prev" href="../">
    <link rel="next" href="../associations/">
    <meta name="generator" content="Antora 3.1.9">
    <link rel="stylesheet" href="../../../../_/css/site.css">
    <link rel="stylesheet" href="../../../../_/css/vendor/tabs.css">
    <link rel="icon" href="../../../../_/img/favicon.ico" sizes="32x32">
    <link rel="icon" href="../../../../_/img/icon.svg" type="image/svg+xml" media="(prefers-color-scheme: light)">
    <link rel="icon" href="../../../../_/img/icon-light.svg" type="image/svg+xml" media="(prefers-color-scheme: dark)">
    <link rel="apple-touch-icon" href="../../../../_/img/apple-touch-icon.png"><!-- 180Ã—180 -->
    <link rel="manifest" href="../../../../_/static/manifest.webmanifest">
        <!-- Google Tag Manager -->
        <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer','GTM-5QD58ZB');</script>
        <!-- End Google Tag Manager -->

    <script>var uiRootPath = '../../../../_'</script>


  </head>
  <body class="article">

    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5QD58ZB"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://docs.axoniq.io"><img src="../../../../_/img/logo-dark4x.png" class="header_logo" /></a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="../../../../home/basics/">Basics</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="../../../../home/guides/">Guides</a>
          <div class="navbar-dropdown card">
            <a class="navbar-item" href="../../../../home/guides/axon-framework">Axon Framework</a>
            <a class="navbar-item" href="../../../../home/guides/axon-server">Axon Server</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="../../../../home/reference/">Reference</a>
          <div class="navbar-dropdown card">
                <a class="navbar-item" href="../../">Axon Framework</a>
                <a class="navbar-item" href="../../../../axon-framework-extensions/">Axon Framework Extensions</a>
                <a class="navbar-item" href="../../../../axon-server-reference/v2024.1/">Axon Server</a>
                <a class="navbar-item" href="../../../../synapse-reference/v0.11/">Axon Synapse</a>
                <a class="navbar-item" href="../../../../axoniq-console-reference/">AxonIQ Console</a>
          </div>
        </div>
      </div>
      <div class="navbar-end">
        <div class="navbar-item search hide-for-print">
          <div id="search-field" class="field">
            <input id="search-input" type="text" placeholder="Search AxonIQ Docs">
          </div>
        </div>
        <a class="navbar-item navbar-button" href="https://academy.axoniq.io" target="_blank">AxonIQ Academy</a>
        <a class="navbar-item navbar-button" href="https://discuss.axoniq.io" target="_blank">AxonIQ Discuss</a>
        <a class="navbar-item navbar-button" href="https://console.axoniq.io" target="_blank">AxonIQ Console</a>
      </div>
    </div>
  </nav>
</header>
<div class="toolbar card" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../../home/" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../">Axon Framework Reference</a></li>
    <li><a href="../">Sagas</a></li>
    <li><a href="./">Implementation</a></li>
  </ul>
</nav>
<div class="page-actions">
  <button class="actions-menu-toggle" title="Show actions related to this page">Actions</button>
  <div class="actions-menu toolbar_dropdown_menu card">
      <a class="action item" href="https://github.com/AxonFramework/AxonFramework/edit/master/docs/old-reference-guide/modules/sagas/pages/implementation.adoc">Edit this Page</a>
    
    <a class="action item" href="https://discuss.axoniq.io/search?q&#x3D;Implementation" target="discuss_search">View Discussions</a>
    <a class="action item" href="https://discuss.axoniq.io/new-topic?category&#x3D;library&amp;title&#x3D;%22Implementation%22%20Discussion&amp;body&#x3D;%3C!--%20Replace%20this%20comment%20with%20your%20comment%2Fsuggestion%2Fquestion%2F...%20--%3E%0A%0A%0A%3C!--%0AKeep%20the%20section%20below!%0ALinking%20back%20to%20the%20documentation%20URL%20not%20only%20helps%20people%20go%20to%20the%20page%0Abut%20also%20helps%20find%20relevant%20discussions%20from%20the%20documentation%20page%20via%20the%20%22View%20Discussion%22%20menu.%0A--%3E%0A%5Bdetails%3D%22Related%20library%20page%22%5D%0A%5BImplementation%5D(https%3A%2F%2Fdocs.axoniq.io%2Faxon-framework-reference%2Fdevelopment%2Fsagas%2Fimplementation%2F)%0A%5B%2Fdetails%5D%0A" target="discuss_add">Start new discussion</a>
  </div>
</div>


<div class="page-versions">
  <button class="version-menu-toggle" title="Show other versions of page">development</button>
  <div class="version-menu toolbar_dropdown_menu card">
    <a class="version item is-current" href="./">development</a>
    <a class="version item" href="../../../4.10/sagas/implementation/">4.10</a>
    <a class="version item is-missing" href="../../../0/">older releases</a>
  </div>
</div>
</div>
<div class="body">
<div class="nav-container" data-component="axon-framework-reference" data-version="development">
  <aside class="nav card">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../../">Axon Framework</a></h3>

<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../">Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../upgrading-to-4-7/">Upgrading to Axon Framework 4.7</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../messaging-concepts/">Messaging Concepts</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../messaging-concepts/anatomy-message/">Anatomy of a Message</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../messaging-concepts/message-correlation/">Message Correlation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../messaging-concepts/message-intercepting/">Message Intercepting</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../messaging-concepts/supported-parameters-annotated-handlers/">Supported Parameters for Annotated Handlers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../messaging-concepts/exception-handling/">Exception Handling</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../messaging-concepts/unit-of-work/">Unit of Work</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../axon-framework-commands/">Commands</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../axon-framework-commands/command-handlers/">Handling</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../axon-framework-commands/command-dispatchers/">Dispatching</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../axon-framework-commands/modeling/aggregate/">Aggregates</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../axon-framework-commands/modeling/multi-entity-aggregates/">Multi-Entity Aggregates</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../axon-framework-commands/modeling/state-stored-aggregates/">State Stored Aggregates</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../axon-framework-commands/modeling/aggregate-creation-from-another-aggregate/">Aggregate Creation from another Aggregate</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../axon-framework-commands/modeling/aggregate-polymorphism/">Aggregate Polymorphism</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../axon-framework-commands/modeling/conflict-resolution/">Conflict Resolution</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../axon-framework-commands/infrastructure/">Infrastructure</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../axon-framework-commands/configuration/">Configuration</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../events/">Events</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../events/event-handlers/">Handling</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../events/event-dispatchers/">Dispatching</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../events/event-processors/">Event Processors</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../events/event-processors/subscribing/">Subscribing Event Processor</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../events/event-processors/streaming/">Streaming Event Processor</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../events/event-processors/dead-letter-queue/">Dead-Letter Queue</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../events/infrastructure/">Infrastructure</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../events/event-versioning/">Event Versioning</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../queries/">Queries</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../queries/query-handlers/">Handling</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../queries/query-dispatchers/">Dispatching</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../queries/implementations/">Implementations</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../queries/configuration/">Configuration</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../">Sagas</a>
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="./">Implementation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../associations/">Associations</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../infrastructure/">Infrastructure</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../deadlines/">Deadlines</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../deadlines/deadline-managers/">Deadline Managers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../deadlines/event-schedulers/">Event Schedulers</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../testing/">Testing</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../testing/commands-events/">Commands / Events</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../testing/sagas-1/">Sagas</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../serialization/">Serialization</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../tuning/">Tuning</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../tuning/event-snapshots/">Event Snapshots</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../tuning/event-processing/">Event Processing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../tuning/command-processing/">Command Processing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../tuning/rdbms-tuning/">Relational Databases</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../monitoring/">Monitoring</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../monitoring/tracing/">Distributed Tracing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../monitoring/metrics/">Metrics</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../monitoring/health/">Health Indicators</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../monitoring/processors/">Event Processor Monitoring</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../monitoring/message-tracking/">Message Tracking</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../spring-boot-integration/">Spring Boot Integration</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../modules/">Modules</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../release-notes/">Release Notes</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../release-notes/major-releases/">Major Releases</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../release-notes/minor-releases/">Minor Releases</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../known-issues-and-workarounds/">Known Issues and Workarounds</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
    <div class="content">
        <aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
          <article class="doc">
            <h1 class="page">Implementation</h1>
            <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>A Saga is a special type of event listener: one that manages a business transaction. Some transactions could be running for days or even weeks, while others are completed within a few milliseconds. In Axon, each instance of a Saga is responsible for managing a single business transaction. That means a Saga maintains state necessary to manage that transaction, continuing it or taking compensating actions to roll back any actions already taken. Typically, and contrary to regular event listeners, a saga has a starting point and an end, both triggered by events. While the starting point of a saga is usually clear, there could be many ways for a saga to end.</p>
</div>
<div class="paragraph">
<p>In Axon, sagas are classes that define one or more <code>@SagaEventHandler</code> methods. Unlike regular event handlers, multiple instances of a saga may exist at any time. Sagas are managed by a single event processor (Tracking or Subscribing), which is dedicated to dealing with events for that specific saga type.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_life_cycle"><a class="anchor" href="#_life_cycle"></a>Life cycle</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A single Saga instance is responsible for managing a single transaction. That means you need to be able to indicate the start and end of a saga&#8217;s life cycle.</p>
</div>
<div class="paragraph">
<p>In a saga, event handlers are annotated with <code>@SagaEventHandler</code>. If a specific event signifies the start of a transaction, add another annotation to that same method: <code>@StartSaga</code>. This annotation will create a new saga and invoke its event handler method when a matching event is published.</p>
</div>
<div class="paragraph">
<p>By default, a new saga is only started if no suitable existing saga (of the same type) can be found. You can also force the creation of a new saga instance by setting the <code>forceNew</code> property on the <code>@StartSaga</code> annotation to <code>true</code>.</p>
</div>
<div class="paragraph">
<p>Ending a saga can be done in two ways. If a certain event always indicates the end of a saga its life cycle, annotate that event handler on the saga with <code>@EndSaga</code>. The saga its life cycle will be ended after the invocation of the handler. Alternatively, you can call <code>SagaLifecycle.end()</code> from inside the saga to end the life cycle. This allows you to conditionally end the saga.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_event_handling"><a class="anchor" href="#_event_handling"></a>Event handling</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Event handling in a saga is quite comparable to that of a regular event listener. The same rules for method and parameter resolution are valid here. There is one major difference, though. While there is a single instance of an event listener that deals with all incoming events, multiple instances of a saga may exist, each interested in different events. For example, a saga that manages a transaction around an Order with Id "1" will not be interested in events regarding Order "2", and vice versa.</p>
</div>
<div class="paragraph">
<p>Instead of publishing all events to all saga instances (which would be a complete waste of resources), Axon will only publish events containing properties that the saga has been associated with. This is done using <code>AssociationValue`s. An `AssociationValue</code> consists of a key and a value. The key represents the type of identifier used, for example "orderId" or "order". The value represents the corresponding value, "1" or "2" in the previous example.</p>
</div>
<div class="paragraph">
<p>The order in which <code>@SagaEventHandler</code> annotated methods are evaluated is identical to that of <code>@EventHandler</code> methods (see <a href="../../events/event-handlers/" class="xref page">Annotated event handler</a>). A method matches if the parameters of the handler method match the incoming event, and if the saga has an association with the property defined on the handler method.</p>
</div>
<div class="paragraph">
<p>The <code>@SagaEventHandler</code> annotation has two attributes, of which <code>associationProperty</code> is the most important one. This is the name of the property on the incoming event that should be used to find associated sagas. The key of the association value is the name of the property. The value is the value returned by property its getter method.</p>
</div>
<div class="paragraph">
<p>For example, consider an incoming Event with a method <code>String getOrderId()</code>, which returns "123". If a method accepting this event is annotated with <code>@SagaEventHandler(associationProperty=&quot;orderId&quot;)</code>, this Event is routed to all Sagas that have been associated with an <code>AssociationValue</code> with key "orderId" and value "123". This may either be exactly one, more than one, or even none at all.</p>
</div>
<div class="paragraph">
<p>Sometimes, the name of the property you want to associate with is not the name of the association you want to use. For example, you have a Saga that matches "Sell orders" against "Buy orders", you could have a transaction object that contains the "buyOrderId" and a "sellOrderId". If you want the saga to associate the "sellOrderId" value as "orderId", you can define a different <code>keyName</code> in the <code>@SagaEventHandler</code> annotation. It would then become <code>@SagaEventHandler(associationProperty=&quot;sellOrderId&quot;, keyName=&quot;orderId&quot;)</code></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_injecting_resources"><a class="anchor" href="#_injecting_resources"></a>Injecting resources</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Sagas generally do more than just maintaining state based on events. They interact with external components. To do so, they need access to the resources necessary to address to components. Usually, these resources aren&#8217;t really part of the saga and its state and these resources should not be persisted as such. However, once a saga is reconstructed, these resources must be injected before an event is routed to that instance.</p>
</div>
<div class="paragraph">
<p>For that purpose, there is the <code>ResourceInjector</code>. It is used by the <code>SagaRepository</code> to inject resources into a saga. Axon provides a <code>SpringResourceInjector</code>, which injects annotated fields and methods with resources from the Application Context. Axon also provides a <code>SimpleResourceInjector</code>, which injects resources that have been registered with it into <code>@Inject</code> annotated methods and fields.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><strong>Tip</strong></p>
</div>
<div class="paragraph">
<p>Since resources should not be persisted with the saga, make sure to add the <code>transient</code> keyword to those fields. This will prevent the serialization mechanism to attempt to write the contents of these fields to the repository. The repository will automatically re-inject the required resources after a saga has been deserialized.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>The <code>SimpleResourceInjector</code> allows for a pre-specified collection of resources to be injected. It scans the (setter) methods and fields of a Saga to find ones that are annotated with <code>@Inject</code>.</p>
</div>
<div class="paragraph">
<p>When using the Configuration API, Axon will default to the <code>ConfigurationResourceInjector</code>. It will inject any resource available in the configuration. Components like the <code>EventBus</code>, <code>EventStore</code>, <code>CommandBus</code> and <code>CommandGateway</code> are available by default. You can also register your own components using <code>configurer.registerComponent()</code>.</p>
</div>
<div class="paragraph">
<p>The <code>SpringResourceInjector</code> uses Spring&#8217;s dependency injection mechanism to inject resources into a Saga. This means you can use setter injection or direct field injection if you require. The method or field to be injected needs to be annotated in order for Spring to recognize it as a dependency, for example with <code>@Autowired</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_saga_infrastructure"><a class="anchor" href="#_saga_infrastructure"></a>Saga infrastructure</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Events need to be redirected to the appropriate saga instances. To do so, some infrastructure classes are required. The most important components are the <code>SagaManager</code> and the <code>SagaRepository</code>.</p>
</div>
<div class="sect2">
<h3 id="saga-manager"><a class="anchor" href="#saga-manager"></a>Saga manager</h3>
<div class="paragraph">
<p>Like any component that handles events, the processing is done by an <a href="../../events/event-processors/" class="xref page">Event Processor</a>.
However, Sagas are not singleton instances handling events.
They have individual life cycles that need to be managed.</p>
</div>
<div class="paragraph">
<p>Axon supports life cycle management through the <code>AnnotatedSagaManager</code>, which is provided to an Event Processor to perform the actual invocation of handlers.
It is initialized using the type of the Saga to manage, as well as a <a href="#saga-repository-and-saga-store"><code>SagaRepository</code></a> where Sagas of that type can be stored and retrieved.
A single <code>AnnotatedSagaManager</code> can only manage a single Saga type.</p>
</div>
</div>
<div class="sect2">
<h3 id="saga-repository-and-saga-store"><a class="anchor" href="#saga-repository-and-saga-store"></a>Saga repository and saga store</h3>
<div class="paragraph">
<p>The <code>SagaRepository</code> is responsible for storing and retrieving sagas, for use by the <code>SagaManager</code>. It is capable of retrieving specific saga instances by their identifier as well as by their association values.</p>
</div>
<div class="paragraph">
<p>There are some special requirements, however. Since concurrency handling in sagas is a delicate procedure, the repository must ensure that for each conceptual saga instance (with an equal identifier) only a single instance exists in the JVM.</p>
</div>
<div class="paragraph">
<p>Axon provides the <code>AnnotatedSagaRepository</code> implementation, which allows the lookup of saga instances while guaranteeing that only a single instance of the saga may be accessed at the same time. It uses a <code>SagaStore</code> to perform the actual persistence of saga instances.</p>
</div>
<div class="paragraph">
<p>The choice for the implementation to use depends mainly on the storage engine used by the application. Axon provides the <code>JdbcSagaStore</code>, <code>InMemorySagaStore</code>, <code>JpaSagaStore</code> and <code>MongoSagaStore</code>.</p>
</div>
<div class="paragraph">
<p>In some cases, applications benefit from caching saga instances. In that case, there is a <code>CachingSagaStore</code> which wraps another implementation to add caching behavior. Note that the <code>CachingSagaStore</code> is a write-through cache, which means save operations are always immediately forwarded to the backing Store, to ensure data safety.</p>
</div>
<div class="sect3">
<h4 id="JpaSagaStore"><a class="anchor" href="#JpaSagaStore"></a><code>JpaSagaStore</code></h4>
<div class="paragraph">
<p>The <code>JpaSagaStore</code> uses JPA to store the state and association values of sagas. Sagas themselves do not need any JPA annotations; Axon will serialize the sagas using a <code>Serializer</code> (similar to event serialization, you can choose between an <code>XStreamSerializer</code> or <code>JacksonSerializer</code>, which can be set by configuring the default <code>Serializer</code> in your application. For more details, see <a href="../../serialization/" class="xref page">Serializers</a>.</p>
</div>
<div class="paragraph">
<p>The <code>JpaSagaStore</code> is configured with an <code>EntityManagerProvider</code>, which provides access to an <code>EntityManager</code> instance to use. This abstraction allows for the use of both application managed and container managed <code>EntityManager`s. Optionally, you can define the serializer to serialize the Saga instances with. Axon defaults to the `XStreamSerializer</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="JdbcSagaStore"><a class="anchor" href="#JdbcSagaStore"></a><code>JdbcSagaStore</code></h4>
<div class="paragraph">
<p>The <code>JdbcSagaStore</code> uses plain JDBC to store stage instances and their association values. Similar to the <code>JpaSagaStore</code>, saga instances do not need to be aware of how they are stored. They are serialized using a serializer.</p>
</div>
<div class="paragraph">
<p>The <code>JdbcSagaStore</code> is initialized with either a <code>DataSource</code> or a <code>ConnectionProvider</code>. While not required, when initializing with a <code>ConnectionProvider</code>, it is recommended to wrap the implementation in a <code>UnitOfWorkAwareConnectionProviderWrapper</code>. It will check the current Unit of Work for an already open database connection, to ensure that all activity within a unit of work is done on a single connection.</p>
</div>
<div class="paragraph">
<p>Unlike JPA, the <code>JdbcSagaRepository</code> uses plain SQL statements to store and retrieve information. This may mean that some operations depend on the database specific SQL dialect. It may also be the case that certain database vendors provide non-standard features that you would like to use. To allow for this, you can provide your own <code>SagaSqlSchema</code>. The <code>SagaSqlSchema</code> is an interface that defines all the operations the repository needs to perform on the underlying database. It allows you to customize the SQL statement executed for each operation. The default is the <code>GenericSagaSqlSchema</code>. Other implementations available are <code>PostgresSagaSqlSchema</code>, <code>Oracle11SagaSqlSchema</code> and <code>HsqlSagaSchema</code>.</p>
</div>
</div>
<div class="sect3">
<h4 id="MongoSagaStore"><a class="anchor" href="#MongoSagaStore"></a><code>MongoSagaStore</code></h4>
<div class="paragraph">
<p>The <code>MongoSagaStore</code> stores the saga instances and their associations in a MongoDB database. The <code>MongoSagaStore</code> stores all sagas in a single collection in a MongoDB database. For each saga instance, a single document is created.</p>
</div>
<div class="paragraph">
<p>The <code>MongoSagaStore</code> also ensures that at any time, only a single Saga instance exists for any unique Saga in a single JVM. This ensures that no state changes are lost due to concurrency issues.</p>
</div>
<div class="paragraph">
<p>The <code>MongoSagaStore</code> is initialized using a <code>MongoTemplate</code> and optionally a <code>Serializer</code>. The <code>MongoTemplate</code> provides a reference to the collection to store the sagas in. Axon provides the <code>DefaultMongoTemplate</code>, which takes a <code>MongoClient</code> instance as well as the database name and name of the collection to store the sagas in. The database name and collection name may be omitted. In that case, they default to <code>&quot;axonframework&quot;</code> and <code>&quot;sagas&quot;</code>, respectively.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_caching"><a class="anchor" href="#_caching"></a>Caching</h3>
<div class="paragraph">
<p>If a database backed saga storage is used, saving and loading saga instances may be a relatively expensive operation. In situations where the same saga instance is invoked multiple times within a short time span, a cache can be especially beneficial to the application&#8217;s performance.</p>
</div>
<div class="paragraph">
<p>Axon provides the <code>CachingSagaStore</code> implementation. It is a <code>SagaStore</code> that wraps another one, which does the actual storage. When loading sagas or association values, the <code>CachingSagaStore</code> will first consult its caches, before delegating to the wrapped repository. When storing information, all calls are always delegated to ensure that the backing storage always has a consistent view on the saga&#8217;s state.</p>
</div>
<div class="paragraph">
<p>To configure caching, simply wrap any <code>SagaStore</code> in a <code>CachingSagaStore</code>. The constructor of the <code>CachingSagaStore</code> takes three parameters: 1. The <code>SagaStore</code> to wrap 2. The cache to use for association values 3. The cache to use for saga instances</p>
</div>
<div class="paragraph">
<p>The latter two arguments may refer to the same cache, or to different ones. This depends on the eviction requirements of your specific application.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="configuring-a-saga"><a class="anchor" href="#configuring-a-saga"></a>Configuring a Saga</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Although a Saga requires a <a href="#saga-manager">manager</a>, <a href="#saga-repository-and-saga-store">repository / store</a> and wiring to the right message busses, configuring a Saga is straightforward.
When using the Configuration API, Axon will use sensible defaults for most components.</p>
</div>
<div class="paragraph">
<p>As a specific type of <a href="../../events/event-handlers/" class="xref page">Event Handling Component</a>, configuration of a Saga is closely related to the configuration of <a href="../../events/event-processors/" class="xref page">Event Processors</a>.
Due to this, configuring a processor will impact the behaviour of a Saga, albeit on a non-functional level.
The configuration of <a href="../../events/event-processors/#error-handling" class="xref page">error handling</a> or <a href="../../events/event-processors/#_assigning_handlers_to_processors" class="xref page">processor assignment rules</a>, for example, are thus equally valid for Sagas as long as the right processor name is used during configuration.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><strong>Default Saga Processor name</strong></p>
</div>
<div class="paragraph">
<p>As a Saga is a type of event handler, it is part of an Event Processor.
Without defining any <a href="../../events/event-processors/#_assigning_handlers_to_processors" class="xref page">assignment rules</a>, a Saga&#8217;s processor name equals the Saga name appended with "Processor",</p>
</div>
<div class="paragraph">
<p>With a Saga called <code>MySaga</code>, that would mean the processor is called <code>MySagaProcessor</code>.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Internally, Axon uses a <code>SagaConfigurer</code> to construct the Saga, Saga Manager, Saga Repository and Saga Store.
A default configuration for a Saga called <code>MySaga</code> would look as follows:</p>
</div>
<div class="sect3">
<h4 id="_axon_configuration_api"><a class="anchor" href="#_axon_configuration_api"></a>Axon Configuration API</h4>
<div class="paragraph">
<p>As a specific type of event handler, registering a Saga is done through the <code>EventProcessingConfigurer</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class AxonConfig {
    // omitting other configuration methods...
    void configureMySaga(EventProcessingConfigurer eventProcessingConfigurer) {
        eventProcessingConfigurer.registerSaga(MySaga.class);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_spring_boot_auto_configuration"><a class="anchor" href="#_spring_boot_auto_configuration"></a>Spring Boot auto configuration</h3>
<div class="paragraph">
<p>In a Spring environment, the Saga implementation should be annotated with <code>@Saga</code> to MongoSagaStoreto-configure it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.axonframework.spring.stereotype.Saga;

@Saga
class MySaga {
    // saga implementation left out...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Although the defaults lead us to a working Saga environment, it is recommended to define the <a href="#saga-repository-and-saga-store"><code>SagaStore</code></a> to use.
The <code>SagaStore</code> represents the mechanism that 'physically' stores the Saga instances, for which it uses the <code>AnnotatedSagaRepository</code> (the default) to store and retrieve Saga instances.
If no <code>SagaStore</code> is configured Axon defaults an <code>InMemorySagaStore</code>, thus not persisting the Saga on shutdown.
To configure a <code>SagaStore</code> for <code>MySaga</code> consider the following snippet:</p>
</div>
<div class="sect3">
<h4 id="_axon_configuration_api_2"><a class="anchor" href="#_axon_configuration_api_2"></a>Axon Configuration API</h4>
<div class="paragraph">
<p>To define a custom <code>SagaStore</code>, the <code>SagaConfigurer</code> should be used through the <code>EventProcessingConfigurer#registerSaga(Class&lt;T&gt;, Consumer&lt;SagaConfigurer&lt;T&gt;&gt;)</code> method:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class AxonConfig {
    // omitting other configuration methods...
    void configureMySaga(EventProcessingConfigurer eventProcessingConfigurer,
                         EntityManagerProvider entityManagerProvider) {
        eventProcessingConfigurer.registerSaga(
                MySaga.class,
                sagaConfigurer -&gt; sagaConfigurer.configureSagaStore(
                        c -&gt; JpaSagaStore.builder()
                                         .entityManagerProvider(entityManagerProvider)
                                         .build()
                )
        );
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Alternatively, a default store can be defined through <code>EventProcessingConfigurer#registerSagaStore(Function&lt;Configuration, SagaStore&gt;)</code> method.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_spring_boot_auto_configuration_2"><a class="anchor" href="#_spring_boot_auto_configuration_2"></a>Spring Boot auto configuration</h3>
<div class="paragraph">
<p>When Spring Boot is used and JPA or JDBC is on the classpath, then Axon auto-configures a <code>JpaSagaStore</code> or <code>JdbcSagaStore</code> respectively.
To provide a custom <code>SagaStore</code>, providing a bean to the application context and defining the bean name on the <code>@Saga</code> annotation suffices:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.axonframework.spring.stereotype.Saga;

@Saga(sagaStore = "mySagaStore")
public class MySaga {
    // saga implementation left out...
}

@Configuration
public class AxonConfig {
    // omitting other configuration methods...
    @Bean
    public SagaStore mySagaStore(DataSource dataSource) {
        return JdbcSagaStore.builder()
                            .dataSource(dataSource)
                            .build();
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
        <nav class="pagination">
  <span class="prev"><a href="../">Sagas</a></span>
  <span class="next"><a href="../associations/">Associations</a></span>
</nav>
    </article>
  </div>
</main>
</div>
<footer class="footer">
  <div class="primary-footer">
    <div class="footer-logo ">
      <a href="https://axoniq.io/">
        <img src="https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=90&amp;height=20&amp;name=Logo%20AxonIQ%20(2).png" alt="Logo AxonIQ" loading="lazy" srcset="https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=45&amp;height=10&amp;name=Logo%20AxonIQ%20(2).png 45w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=90&amp;height=20&amp;name=Logo%20AxonIQ%20(2).png 90w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=135&amp;height=30&amp;name=Logo%20AxonIQ%20(2).png 135w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=180&amp;height=40&amp;name=Logo%20AxonIQ%20(2).png 180w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=225&amp;height=50&amp;name=Logo%20AxonIQ%20(2).png 225w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=270&amp;height=60&amp;name=Logo%20AxonIQ%20(2).png 270w" sizes="(max-width: 90px) 100vw, 90px" width="90" height="20">
      </a>
    </div>

    <div class="footer-menu">
	    <h3>Products</h3>
	    <div>
        <ul role="menu">
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/products/axon-framework">Axon Framework</a></li>
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/products/axon-server">Axon Server</a></li>
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/products/axoniq-cloud">AxonIQ Cloud</a></li>
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/products/axoniq-console">AxonIQ Console</a></li>
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/products/axon-synapse">Axon Synapse</a></li>
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/blog/protect-sensitive-data-in-an-event-sourced-application">AxonIQ Data Protection</a></li>
        </ul>
      </div>
    </div>

    <div class="footer-menu">
	    <h3>Sites</h3>
	    <div>
        <ul role="menu">
          <li><a class="ext" target="_blank" href="http://support.axoniq.io/">Customer Support Portal</a></li>
          <li><a class="ext" target="_blank" href="https://academy.axoniq.io/">AxonIQ Academy</a></li>
          <li><a class="ext" target="_blank" href="https://console.axoniq.io/">AxonIQ Console</a></li>
          <li><a class="ext" target="_blank" href="https://discuss.axoniq.io/">AxonIQ Discuss</a></li>
          <li><a class="ext" target="_blank" href="https://console.cloud.axoniq.io">AxonIQ Cloud</a></li>
        </ul>
      </div>
    </div>

    <div class="footer-menu">
	    <h3>Follow us</h3>
	    <div>
        <ul role="menu">
          <li><a class="ext" target="_blank" href="https://www.youtube.com/axoniq">YouTube</a></li>
          <li><a class="ext" target="_blank" href="https://www.linkedin.com/company/axoniq">LinkedIn</a></li>
          <li><a class="ext" target="_blank" href="https://www.facebook.com/AxonIQ.io">Facebook</a></li>
          <li><a class="ext" target="_blank" href="https://twitter.com/axon_iq">Twitter</a></li>
          <li><a class="ext" target="_blank" href="https://github.com/AxonIQ">GitHub</a></li>
          <li><a class="ext" target="_blank" href="https://medium.com/axoniq">Medium</a></li>
        </ul>
      </div>
    </div>
  </div>
</footer>
<script id="site-script" src="../../../../_/js/site.js" data-ui-root-path="../../../../_"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
<script async src="../../../../_/js/vendor/page-actions.js"></script>
<script async src="../../../../_/js/vendor/tabs.js" data-sync-storage-key="preferred-tab" data-sync-storage-scope="session"></script>
<script src="../../../../_/js/vendor/lunr.js"></script>
<script src="../../../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../../../.." data-snippet-length="100" data-stylesheet="../../../../_/css/search.css"></script>
<script async src="../../../../search-index.js"></script>
  </body>
</html>
