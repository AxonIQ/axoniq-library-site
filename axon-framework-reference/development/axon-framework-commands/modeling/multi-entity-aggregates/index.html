<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Multi-Entity Aggregates</title>
    <link rel="canonical" href="https://docs.axoniq.io/axon-framework-reference/4.10/axon-framework-commands/modeling/multi-entity-aggregates/">
    <link rel="prev" href="../aggregate/">
    <link rel="next" href="../state-stored-aggregates/">
    <meta name="generator" content="Antora 3.1.1">
    <link rel="stylesheet" href="../../../../../_/css/site.css">
    <link rel="stylesheet" href="../../../../../_/css/vendor/tabs.css">
    <link rel="icon" href="../../../../../_/img/favicon.ico" sizes="32x32">
    <link rel="icon" href="../../../../../_/img/icon.svg" type="image/svg+xml" media="(prefers-color-scheme: light)">
    <link rel="icon" href="../../../../../_/img/icon-light.svg" type="image/svg+xml" media="(prefers-color-scheme: dark)">
    <link rel="apple-touch-icon" href="../../../../../_/img/apple-touch-icon.png"><!-- 180Ã—180 -->
    <link rel="manifest" href="../../../../../_/static/manifest.webmanifest">
        <!-- Google Tag Manager -->
        <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer','GTM-5QD58ZB');</script>
        <!-- End Google Tag Manager -->

    <script>var uiRootPath = '../../../../../_'</script>


  </head>
  <body class="article">

    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5QD58ZB"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://docs.axoniq.io"><img src="../../../../../_/img/logo-dark4x.png" class="header_logo" /></a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="../../../../../home/basics/">Basics</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link">Guides</a>
          <div class="navbar-dropdown card">
              <a class="navbar-item" href="../../../../../home/guides/axon-framework/">Axon Framework</a>
              <a class="navbar-item" href="../../../../../home/guides/axon-server/">Axon Server</a>
              <a class="navbar-item" href="../../../../../home/guides/migration/">Migration</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link">Reference</a>
          <div class="navbar-dropdown card">
                <a class="navbar-item" href="../../../../4.10/">Axon Framework</a>
                <a class="navbar-item" href="../../../../../axon-framework-extensions/">Axon Framework Extensions</a>
                <a class="navbar-item" href="../../../../../axon-server-reference/v2024.1/">Axon Server</a>
                <a class="navbar-item" href="../../../../../synapse-reference/v0.11/">Axon Synapse</a>
                <a class="navbar-item" href="../../../../../axoniq-console-reference/main/">AxonIQ Console</a>
          </div>
        </div>
      </div>
      <div class="navbar-end">
        <div class="navbar-item search hide-for-print">
          <div id="search-field" class="field">
            <input id="search-input" type="text" placeholder="Search AxonIQ Docs">
          </div>
        </div>
        <a class="navbar-item navbar-button" href="https://academy.axoniq.io" target="_blank">AxonIQ Academy</a>
        <a class="navbar-item navbar-button" href="https://discuss.axoniq.io" target="_blank">AxonIQ Discuss</a>
        <a class="navbar-item navbar-button" href="https://console.axoniq.io" target="_blank">AxonIQ Console</a>
      </div>
    </div>
  </nav>
</header>
<div class="toolbar card" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../../../home/" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../../">Axon Framework Reference</a></li>
    <li><a href="../../">Commands</a></li>
    <li>Modelling</li>
    <li><a href="./">Multi-Entity Aggregates</a></li>
  </ul>
</nav>
<div class="page-actions">
  <button class="actions-menu-toggle" title="Show actions related to this page">Actions</button>
  <div class="actions-menu toolbar_dropdown_menu card">
      <a class="action item" href="https://github.com/AxonFramework/AxonFramework/edit/master/docs/old-reference-guide/modules/axon-framework-commands/pages/modeling/multi-entity-aggregates.adoc">Edit this Page</a>
    
    <a class="action item" href="https://discuss.axoniq.io/search?q&#x3D;https%3A%2F%2Fdocs.axoniq.io%2Faxon-framework-reference%2Fdevelopment%2Faxon-framework-commands%2Fmodeling%2Fmulti-entity-aggregates%2F%20%23library" target="discuss_search">View Discussions</a>
    <a class="action item" href="https://discuss.axoniq.io/new-topic?category&#x3D;library&amp;title&#x3D;%22Multi-Entity%20Aggregates%22%20library%20page%20...&amp;body&#x3D;%3C!--%20Replace%20this%20comment%20with%20your%20comment%2Fsuggestion%2Fquestion%2F...%20--%3E%0A%0A%0A%3C!--%0AKeep%20the%20section%20below!%0ALinking%20back%20to%20the%20documentation%20URL%20not%20only%20helps%20people%20go%20to%20the%20page%0Abut%20also%20helps%20find%20relevant%20discussions%20from%20the%20documentation%20page%20via%20the%20%22View%20Discussion%22%20menu.%0A--%3E%0A%5Bdetails%3D%22Related%20library%20page%22%5D%0A%5BMulti-Entity%20Aggregates%5D(https%3A%2F%2Fdocs.axoniq.io%2Faxon-framework-reference%2Fdevelopment%2Faxon-framework-commands%2Fmodeling%2Fmulti-entity-aggregates%2F)%0A%5B%2Fdetails%5D%0A" target="discuss_add">Start new discussion</a>
  </div>
</div>


<div class="page-versions">
  <button class="version-menu-toggle" title="Show other versions of page">development</button>
  <div class="version-menu toolbar_dropdown_menu card">
    <a class="version item is-current" href="./">development</a>
    <a class="version item" href="../../../../4.10/axon-framework-commands/modeling/multi-entity-aggregates/">4.10</a>
    <a class="version item is-missing" href="../../../../0/">older releases</a>
  </div>
</div>
</div>
<div class="body">
<div class="nav-container" data-component="axon-framework-reference" data-version="development">
  <aside class="nav card">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../../../">Axon Framework</a></h3>

<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../">Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../upgrading-to-4-7/">Upgrading to Axon Framework 4.7</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../../messaging-concepts/">Messaging Concepts</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../messaging-concepts/anatomy-message/">Anatomy of a Message</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../messaging-concepts/message-correlation/">Message Correlation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../messaging-concepts/message-intercepting/">Message Intercepting</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../messaging-concepts/supported-parameters-annotated-handlers/">Supported Parameters for Annotated Handlers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../messaging-concepts/exception-handling/">Exception Handling</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../messaging-concepts/unit-of-work/">Unit of Work</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../">Commands</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <span class="nav-text">Modelling</span>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../aggregate/">Aggregate</a>
  </li>
  <li class="nav-item is-current-page" data-depth="3">
    <a class="nav-link" href="./">Multi-Entity Aggregates</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../state-stored-aggregates/">State Stored Aggregates</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../aggregate-creation-from-another-aggregate/">Aggregate Creation from another Aggregate</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../aggregate-polymorphism/">Aggregate Polymorphism</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../conflict-resolution/">Conflict Resolution</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../command-dispatchers/">Command Dispatchers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../command-handlers/">Command Handlers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../infrastructure/">Infrastructure</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../configuration/">Configuration</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../../events/">Events</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../events/event-dispatchers/">Event Dispatchers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../events/event-handlers/">Event Handlers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../../events/event-processors/">Event Processors</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../events/event-processors/subscribing/">Subscribing Event Processor</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../../events/event-processors/streaming/">Streaming Event Processor</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../events/event-bus-and-event-store/">Event Bus &amp; Event Store</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../events/event-versioning/">Event Versioning</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../../queries/">Queries</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../queries/query-processing/">Query Processing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../queries/query-dispatchers/">Query Dispatchers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../queries/query-handlers/">Query Handlers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../queries/implementations/">Implementations</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../queries/configuration/">Configuration</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../../sagas/">Sagas</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../sagas/implementation/">Implementation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../sagas/associations/">Associations</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../sagas/infrastructure/">Infrastructure</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../../deadlines/">Deadlines</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../deadlines/deadline-managers/">Deadline Managers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../deadlines/event-schedulers/">Event Schedulers</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../../testing/">Testing</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../testing/commands-events/">Commands / Events</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../testing/sagas-1/">Sagas</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../serialization/">Serialization</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../../tuning/">Tuning</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../tuning/event-snapshots/">Event Snapshots</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../tuning/event-processing/">Event Processing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../tuning/command-processing/">Command Processing</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../../monitoring/">Monitoring</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../monitoring/tracing/">Distributed Tracing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../monitoring/metrics/">Metrics</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../monitoring/health/">Health Indicators</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../monitoring/processors/">Event Processor Monitoring</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../monitoring/message-tracking/">Message Tracking</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../spring-boot-integration/">Spring Boot Integration</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../modules/">Modules</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../../release-notes/">Release Notes</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../release-notes/major-releases/">Major Releases</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../release-notes/minor-releases/">Minor Releases</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
    <div class="content">
        <aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
          <article class="doc">
            <h1 class="page">Multi-Entity Aggregates</h1>
            <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>Complex business logic often requires more than what an Aggregate with only an Aggregate Root can provide. In that case, it is important that the complexity is spread over a number of 'Entities' within the aggregate. In this chapter we will discuss the specifics around creating entities in your aggregates and how they can handle message.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">State among Entities</div>
<div class="paragraph">
<p>A common misinterpretation of the rule that aggregates should not expose state, is that none of the entities should contain any property accessor methods. This is not the case. In fact, an aggregate will probably benefit a lot if the entities <em>within</em> the aggregate expose state to the other entities in that same aggregate. However, is is recommended not to expose the state <em>outside</em> the aggregate.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Within the 'Gift Card' domain, the <code>GiftCard</code> aggregate root was defined in <a href="../aggregate/" class="xref page">this</a> section. Let&#8217;s leverage this domain to introduce entities:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.axonframework.modelling.command.AggregateIdentifier;
import org.axonframework.modelling.command.AggregateMember;
import org.axonframework.modelling.command.EntityId;

public class GiftCard {

    @AggregateIdentifier
    private String id;

    @AggregateMember // 1.
    private List&lt;GiftCardTransaction&gt; transactions = new ArrayList&lt;&gt;();

    private int remainingValue;

    // omitted constructors, command and event sourcing handlers
}

public class GiftCardTransaction {

    @EntityId // 2.
    private String transactionId;

    private int transactionValue;
    private boolean reimbursed = false;

    public GiftCardTransaction(String transactionId, int transactionValue) {
        this.transactionId = transactionId;
        this.transactionValue = transactionValue;
    }

    public String getTransactionId() {
        return transactionId;
    }

    // omitted command handlers, event sourcing handlers and equals/hashCode
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Entities are, just like the aggregate root, simple objects, as is shown with the new <code>GiftCardTransaction</code> entity. The snippet above shows two important concepts of multi-entity aggregates:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The field that declares the child entity/entities must be annotated with <code>@AggregateMember</code>.
This annotation tells Axon that the annotated field contains a class that should be inspected for message handlers.
This example shows the annotation on an implementation of <code>Iterable</code>, but it can also be placed on a single Object or a <code>Map</code>.
In the latter case, the values of the <code>Map</code> are expected to contain the entities, while the key contains a value that is used as their reference.
Note that this annotation can be placed on a field and a method.</p>
</li>
<li>
<p>The <code>@EntityId</code> annotation specifying the identifying field of an Entity.
Required to be able to route a command (or <a href="#_event_sourcing_handlers_in_entities">event</a>) message to the correct entity instance.
The property on the payload that will be used to find the entity that the message should be routed to, defaults to the name of the <code>@EntityId</code> annotated field.
For example, when annotating the field <code>transactionId</code>, the command must define a property with that same name, which means either a <code>transactionId</code> or a <code>getTransactionId()</code> method must be present.
If the name of the field and the routing property differ, you may provide a value explicitly using <code>@EntityId(routingKey = &quot;customRoutingProperty&quot;)</code>.
This annotation is <strong>mandatory</strong> on the Entity implementation if it will be part of a <code>Collection</code> or <code>Map</code> of child entities.
Note that this annotation can be placed on a field and a method.</p>
</li>
</ol>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Defining the Entity type</div>
<div class="paragraph">
<p>The field declaration for both the <code>Collection</code> or <code>Map</code> should contain proper generics to allow Axon to identify the type of Entity contained in the collection or map. If it is not possible to add the generics in the declaration (for example, because you&#8217;re using a custom implementation which already defines generic types), you must specify the entity type by specifying the <code>type</code> field in the <code>@AggregateMember</code> annotation:</p>
</div>
<div class="paragraph">
<p><code>@AggregateMember(type = GiftCardTransaction.class)</code></p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_command_handling_in_entities"><a class="anchor" href="#_command_handling_in_entities"></a>Command handling in entities</h2>
<div class="sectionbody">
<div class="paragraph">
<p><code>@CommandHandler</code> annotations are not limited to the aggregate root. Placing all command handlers in the root will sometimes lead to a large number of methods on the aggregate root, while many of them simply forward the invocation to one of the underlying entities. If that is the case, you may place the <code>@CommandHandler</code> annotation on one of the underlying entities' methods. For Axon to find these annotated methods, the field declaring the entity in the aggregate root must be marked with <code>@AggregateMember</code>:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.axonframework.commandhandling.CommandHandler;
import org.axonframework.modelling.command.AggregateIdentifier;
import org.axonframework.modelling.command.AggregateMember;
import org.axonframework.modelling.command.EntityId;

import static org.axonframework.modelling.command.AggregateLifecycle.apply;

public class GiftCard {

    @AggregateIdentifier
    private String id;

    @AggregateMember
    private List&lt;GiftCardTransaction&gt; transactions = new ArrayList&lt;&gt;();

    private int remainingValue;

    // omitted constructors, command and event sourcing handlers

}

public class GiftCardTransaction {

    @EntityId
    private String transactionId;

    private int transactionValue;
    private boolean reimbursed = false;

    public GiftCardTransaction(String transactionId, int transactionValue) {
        this.transactionId = transactionId;
        this.transactionValue = transactionValue;
    }

    @CommandHandler
    public void handle(ReimburseCardCommand cmd) {
        if (reimbursed) {
            throw new IllegalStateException("Transaction already reimbursed");
        }
        apply(new CardReimbursedEvent(cmd.getCardId(), transactionId, transactionValue));
    }

    // omitted getter, event sourcing handler and equals/hashCode
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that only the declared type of the annotated field is inspected for command handlers. If a field value is null at the time an incoming command arrives for that entity, an exception is thrown. If there is a <code>Collection</code> or <code>Map</code> of child entities and none entity can be found which matches the routing key of the command, Axon throws an <code>IllegalStateException</code> as apparently the aggregate is not capable of processing the command at that point in time.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Command Handler considerations</div>
<div class="paragraph">
<p>Each command must have exactly one handler in the aggregate. This means that you cannot annotate multiple entities (either root nor not) with <code>@CommandHandler</code> which handle the same command type. In case you need to conditionally route a command to an entity, the parent of these entities should handle the command, and forward it based on the conditions that apply.</p>
</div>
<div class="paragraph">
<p>The runtime type of the field does not have to be exactly the declared type. However, only the declared type of the <code>@AggregateMember</code> annotated field is inspected for <code>@CommandHandler</code> methods.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_event_sourcing_handlers_in_entities"><a class="anchor" href="#_event_sourcing_handlers_in_entities"></a>Event Sourcing handlers in entities</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When using event sourcing as the mechanism to store the aggregates, not only the aggregate root needs to use events to trigger state transitions, but so does each of the entities within that aggregate. Axon provides support for event sourcing complex aggregate structures like these out of the box.</p>
</div>
<div class="paragraph">
<p>When an entity (including the aggregate root) applies an event, it is handled by the aggregate root first, and then bubbles down through every <code>@AggregateMember</code> annotated field to <strong>all</strong> its containing child entities:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.axonframework.commandhandling.CommandHandler;
import org.axonframework.modelling.command.AggregateIdentifier;
import org.axonframework.modelling.command.AggregateMember;
import org.axonframework.modelling.command.EntityId;

import static org.axonframework.modelling.command.AggregateLifecycle.apply;

public class GiftCard {

    @AggregateIdentifier
    private String id;
    @AggregateMember
    private List&lt;GiftCardTransaction&gt; transactions = new ArrayList&lt;&gt;();

    @CommandHandler
    public void handle(RedeemCardCommand cmd) {
        // Some decision making logic
        apply(new CardRedeemedEvent(id, cmd.getTransactionId(), cmd.getAmount()));
    }

    @EventSourcingHandler
    public void on(CardRedeemedEvent evt) {
        // 1.
        transactions.add(new GiftCardTransaction(evt.getTransactionId(), evt.getAmount()));
    }

    // omitted constructors, command and event sourcing handlers
}

public class GiftCardTransaction {

    @EntityId
    private String transactionId;

    private int transactionValue;
    private boolean reimbursed = false;

    public GiftCardTransaction(String transactionId, int transactionValue) {
        this.transactionId = transactionId;
        this.transactionValue = transactionValue;
    }

    @CommandHandler
    public void handle(ReimburseCardCommand cmd) {
        if (reimbursed) {
            throw new IllegalStateException("Transaction already reimbursed");
        }
        apply(new CardReimbursedEvent(cmd.getCardId(), transactionId, transactionValue));
    }

    @EventSourcingHandler
    public void on(CardReimbursedEvent event) {
        // 2.
        if (transactionId.equals(event.getTransactionId())) {
            reimbursed = true;
        }
    }

    // omitted getter and equals/hashCode
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Two specifics are worth mentioning from the above snippet, pointed out with numbered Java comments:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The creation of the Entity takes place in an event sourcing handler of its parent.
It is thus not possible to have a 'command handling constructor' on the entity class as with the aggregate root.</p>
</li>
<li>
<p>The event sourcing handler in the entity performs a validation check whether the received event actually belongs to the entity.
This is necessary as events applied by one entity instance will also be handled by any other entity instance of the same type.
The situation described in bullet point two is customizable, by changing the <code>eventForwardingMode</code> on the <code>@AggregateMember</code> annotation:</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.axonframework.modelling.command.AggregateIdentifier;
import org.axonframework.modelling.command.AggregateMember;
import org.axonframework.modelling.command.ForwardMatchingInstances;

public class GiftCard {

    @AggregateIdentifier
    private String id;
    @AggregateMember(eventForwardingMode = ForwardMatchingInstances.class)
    private List&lt;GiftCardTransaction&gt; transactions = new ArrayList&lt;&gt;();

    // omitted constructors, command and event sourcing handlers
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>By setting the <code>eventForwardingMode</code> to <code>ForwardMatchingInstances</code> an Event Message will only be forwarded if it contains a field/getter which matches the name of the <code>@EntityId</code> annotated field on the entity. This routing behaviour can be further specified with the <code>routingKey</code> field on the <code>@EntityId</code> annotation, mirroring that of <a href="#_command_handling_in_entities">routing commands in entities</a>. Other forwarding modes which can be used are <code>ForwardAll</code> (the default) and <code>ForwardNone</code>, which respectively forward all events to all entities or no events at all.</p>
</div>
</div>
</div>
        <nav class="pagination">
  <span class="prev"><a href="../aggregate/">Aggregate</a></span>
  <span class="next"><a href="../state-stored-aggregates/">State Stored Aggregates</a></span>
</nav>
    </article>
  </div>
</main>
</div>
<footer class="footer">
  <div class="primary-footer">
    <div class="footer-logo ">
      <a href="https://axoniq.io/">
        <img src="https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=90&amp;height=20&amp;name=Logo%20AxonIQ%20(2).png" alt="Logo AxonIQ" loading="lazy" srcset="https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=45&amp;height=10&amp;name=Logo%20AxonIQ%20(2).png 45w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=90&amp;height=20&amp;name=Logo%20AxonIQ%20(2).png 90w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=135&amp;height=30&amp;name=Logo%20AxonIQ%20(2).png 135w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=180&amp;height=40&amp;name=Logo%20AxonIQ%20(2).png 180w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=225&amp;height=50&amp;name=Logo%20AxonIQ%20(2).png 225w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=270&amp;height=60&amp;name=Logo%20AxonIQ%20(2).png 270w" sizes="(max-width: 90px) 100vw, 90px" width="90" height="20">
      </a>
    </div>

    <div class="footer-menu">
	    <h3>Products</h3>
	    <div>
        <ul role="menu">
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/products/axon-framework">Axon Framework</a></li>
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/products/axon-server">Axon Server</a></li>
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/products/axoniq-cloud">AxonIQ Cloud</a></li>
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/products/axoniq-console">AxonIQ Console</a></li>
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/products/axon-synapse">Axon Synapse</a></li>
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/blog/protect-sensitive-data-in-an-event-sourced-application">AxonIQ Data Protection</a></li>
        </ul>
      </div>
    </div>

    <div class="footer-menu">
	    <h3>Sites</h3>
	    <div>
        <ul role="menu">
          <li><a class="ext" target="_blank" href="http://support.axoniq.io/">Customer Support Portal</a></li>
          <li><a class="ext" target="_blank" href="https://academy.axoniq.io/">AxonIQ Academy</a></li>
          <li><a class="ext" target="_blank" href="https://console.axoniq.io/">AxonIQ Console</a></li>
          <li><a class="ext" target="_blank" href="https://discuss.axoniq.io/">AxonIQ Discuss</a></li>
          <li><a class="ext" target="_blank" href="https://console.cloud.axoniq.io">AxonIQ Cloud</a></li>
        </ul>
      </div>
    </div>

    <div class="footer-menu">
	    <h3>Follow us</h3>
	    <div>
        <ul role="menu">
          <li><a class="ext" target="_blank" href="https://www.youtube.com/axoniq">YouTube</a></li>
          <li><a class="ext" target="_blank" href="https://www.linkedin.com/company/axoniq">LinkedIn</a></li>
          <li><a class="ext" target="_blank" href="https://www.facebook.com/AxonIQ.io">Facebook</a></li>
          <li><a class="ext" target="_blank" href="https://twitter.com/axon_iq">Twitter</a></li>
          <li><a class="ext" target="_blank" href="https://github.com/AxonIQ">GitHub</a></li>
          <li><a class="ext" target="_blank" href="https://medium.com/axoniq">Medium</a></li>
        </ul>
      </div>
    </div>
  </div>
</footer>
<script id="site-script" src="../../../../../_/js/site.js" data-ui-root-path="../../../../../_"></script>
<script async src="../../../../../_/js/vendor/highlight.js"></script>
<script async src="../../../../../_/js/vendor/page-actions.js"></script>
<script async src="../../../../../_/js/vendor/tabs.js" data-sync-storage-key="preferred-tab" data-sync-storage-scope="session"></script>
<script src="../../../../../_/js/vendor/lunr.js"></script>
<script src="../../../../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../../../../.." data-snippet-length="100" data-stylesheet="../../../../../_/css/search.css"></script>
<script async src="../../../../../search-index.js"></script>
  </body>
</html>
