<!DOCTYPE html>
<html lang="en">
  <head>
        <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Relational Database Tuning</title>
    <link rel="canonical" href="https://docs.axoniq.io/axon-framework-reference/4.11/tuning/rdbms-tuning/">
    <link rel="prev" href="../command-processing/">
    <link rel="next" href="../../monitoring/">
    <meta name="generator" content="Antora 3.1.10">
    <link rel="stylesheet" href="../../../../_/css/site.css">
    <link rel="stylesheet" href="../../../../_/css/vendor/tabs.css">
    <link rel="icon" href="../../../../_/img/favicon.ico" sizes="32x32">
    <link rel="icon" href="../../../../_/img/icon.svg" type="image/svg+xml" media="(prefers-color-scheme: light)">
    <link rel="icon" href="../../../../_/img/icon-light.svg" type="image/svg+xml" media="(prefers-color-scheme: dark)">
    <link rel="apple-touch-icon" href="../../../../_/img/apple-touch-icon.png"><!-- 180Ã—180 -->
    <link rel="manifest" href="../../../../_/static/manifest.webmanifest">
        <!-- Google Tag Manager -->
        <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer','GTM-5QD58ZB');</script>
        <!-- End Google Tag Manager -->

    <script>var uiRootPath = '../../../../_'</script>


  </head>
  <body class="article">
    <div class="header_container">
      <div class="banner">
    <a href="https://console.axoniq.io">Manage and monitor your Axon Framework applications and Axon Server environments. <span class="banner_button" target="_blank">Try AxonIQ Console</span></a>
</div>      
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5QD58ZB"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://docs.axoniq.io"><img src="../../../../_/img/logo-dark4x.png" class="header_logo" /></a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="../../../../home/basics/">Basics</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="../../../../home/guides/">Guides</a>
          <div class="navbar-dropdown card">
            <a class="navbar-item" href="../../../../home/guides/axon-framework">Axon Framework</a>
            <a class="navbar-item" href="../../../../home/guides/axon-server">Axon Server</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="../../../../home/reference/">Reference</a>
          <div class="navbar-dropdown card">
                <a class="navbar-item" href="../../">Axon Framework</a>
                <a class="navbar-item" href="../../../../axon-framework-extensions/">Axon Framework Extensions</a>
                <a class="navbar-item" href="../../../../axon-server-reference/v2025.1/">Axon Server</a>
                <a class="navbar-item" href="../../../../synapse-reference/v0.12/">Axon Synapse</a>
                <a class="navbar-item" href="../../../../axoniq-console-reference/">AxonIQ Console</a>
          </div>
        </div>
      </div>
      <div class="navbar-end">
        <div class="navbar-item search hide-for-print">
          <div id="search-field" class="field">
            <input id="search-input" type="text" placeholder="Search AxonIQ Docs">
          </div>
        </div>
        <a class="navbar-item navbar-button" href="https://academy.axoniq.io" target="_blank">AxonIQ Academy</a>
        <a class="navbar-item navbar-button" href="https://discuss.axoniq.io" target="_blank">AxonIQ Discuss</a>
        <a class="navbar-item navbar-button" href="https://axoniq.io/contact" target="_blank">Get in touch</a>
      </div>
    </div>
  </nav>
</header>
      <div class="toolbar card" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../../home/" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../">Axon Framework Reference</a></li>
    <li><a href="../">Tuning</a></li>
    <li><a href="./">Relational Databases</a></li>
  </ul>
</nav>
<div class="page-actions">
  <button class="actions-menu-toggle" title="Show actions related to this page">Actions</button>
  <div class="actions-menu toolbar_dropdown_menu card">
      <a class="action item" href="https://github.com/AxonFramework/AxonFramework/edit/axon-4.11.x/docs/old-reference-guide/modules/tuning/pages/rdbms-tuning.adoc">Edit this Page</a>
    
    <a class="action item" href="https://discuss.axoniq.io/search?q&#x3D;Relational%20Database%20Tuning" target="discuss_search">View Discussions</a>
    <a class="action item" href="https://discuss.axoniq.io/new-topic?category&#x3D;library&amp;title&#x3D;%22Relational%20Database%20Tuning%22%20Discussion&amp;body&#x3D;%3C!--%20Replace%20this%20comment%20with%20your%20comment%2Fsuggestion%2Fquestion%2F...%20--%3E%0A%0A%0A%3C!--%0AKeep%20the%20section%20below!%0ALinking%20back%20to%20the%20documentation%20URL%20not%20only%20helps%20people%20go%20to%20the%20page%0Abut%20also%20helps%20find%20relevant%20discussions%20from%20the%20documentation%20page%20via%20the%20%22View%20Discussion%22%20menu.%0A--%3E%0A%5Bdetails%3D%22Related%20library%20page%22%5D%0A%5BRelational%20Database%20Tuning%5D(https%3A%2F%2Fdocs.axoniq.io%2Faxon-framework-reference%2F4.11%2Ftuning%2Frdbms-tuning%2F)%0A%5B%2Fdetails%5D%0A" target="discuss_add">Start new discussion</a>
  </div>
</div>


<div class="page-versions">
  <button class="version-menu-toggle" title="Show other versions of page">4.11</button>
  <div class="version-menu toolbar_dropdown_menu card">
    <a class="version item" href="../../../4.12/tuning/rdbms-tuning/">4.12</a>
    <a class="version item is-current" href="./">4.11</a>
    <a class="version item" href="../../../4.10/tuning/rdbms-tuning/">4.10</a>
    <a class="version item is-missing" href="../../../0/">older releases</a>
  </div>
</div>
</div>
    </div>
    <div class="content_container">
      <div class="body">
<div class="nav-container" data-component="axon-framework-reference" data-version="4.11">
    <aside class="nav card">
      <div class="panels">
        <div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../../">Axon Framework</a></h3>

<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../">Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../upgrading-to-4-7/">Upgrading to Axon Framework 4.7</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../messaging-concepts/">Messaging Concepts</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../messaging-concepts/anatomy-message/">Anatomy of a Message</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../messaging-concepts/message-correlation/">Message Correlation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../messaging-concepts/message-intercepting/">Message Intercepting</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../messaging-concepts/supported-parameters-annotated-handlers/">Supported Parameters for Annotated Handlers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../messaging-concepts/exception-handling/">Exception Handling</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../messaging-concepts/unit-of-work/">Unit of Work</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../messaging-concepts/timeouts/">Timeouts</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../axon-framework-commands/">Commands</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../axon-framework-commands/command-handlers/">Handling</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../axon-framework-commands/command-dispatchers/">Dispatching</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../axon-framework-commands/modeling/aggregate/">Aggregates</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../axon-framework-commands/modeling/multi-entity-aggregates/">Multi-Entity Aggregates</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../axon-framework-commands/modeling/state-stored-aggregates/">State Stored Aggregates</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../axon-framework-commands/modeling/aggregate-creation-from-another-aggregate/">Aggregate Creation from another Aggregate</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../axon-framework-commands/modeling/aggregate-polymorphism/">Aggregate Polymorphism</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../axon-framework-commands/modeling/conflict-resolution/">Conflict Resolution</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../axon-framework-commands/infrastructure/">Infrastructure</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../axon-framework-commands/configuration/">Configuration</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../events/">Events</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../events/event-handlers/">Handling</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../events/event-dispatchers/">Dispatching</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../events/event-processors/">Event Processors</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../events/event-processors/subscribing/">Subscribing Event Processor</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../events/event-processors/streaming/">Streaming Event Processor</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../events/event-processors/dead-letter-queue/">Dead-Letter Queue</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../events/infrastructure/">Infrastructure</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../events/event-versioning/">Event Versioning</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../queries/">Queries</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../queries/query-handlers/">Handling</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../queries/query-dispatchers/">Dispatching</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../queries/implementations/">Implementations</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../queries/configuration/">Configuration</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../sagas/">Sagas</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../sagas/implementation/">Implementation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../sagas/associations/">Associations</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../sagas/infrastructure/">Infrastructure</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../deadlines/">Deadlines</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../deadlines/deadline-managers/">Deadline Managers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../deadlines/event-schedulers/">Event Schedulers</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../testing/">Testing</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../testing/commands-events/">Commands / Events</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../testing/sagas-1/">Sagas</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../serialization/">Serialization</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../">Tuning</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../event-snapshots/">Event Snapshots</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../event-processing/">Event Processing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../command-processing/">Command Processing</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="./">Relational Databases</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../monitoring/">Monitoring</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../monitoring/tracing/">Distributed Tracing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../monitoring/metrics/">Metrics</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../monitoring/health/">Health Indicators</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../monitoring/processors/">Event Processor Monitoring</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../monitoring/message-tracking/">Message Tracking</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../spring-boot-integration/">Spring Boot Integration</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../modules/">Modules</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../release-notes/">Release Notes</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../release-notes/major-releases/">Major Releases</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../release-notes/minor-releases/">Minor Releases</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../known-issues-and-workarounds/">Known Issues and Workarounds</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
      </div>
    </aside>
</div>
<main class="article">
    <div class="page_content">
        <aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
          <article class="doc">
                <h1 class="page">Relational Database Tuning</h1>
            <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>When using Axon Framework with a relational database, there are several considerations to take into account when tuning the database for optimal performance:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Using the <a href="#important_indices">correct indices</a> for the different types of queries used.</p>
</li>
<li>
<p>Configuring the <a href="#auto_increment_and_sequences">right auto-increment configuration</a> when using JPA.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_important_indices"><a class="anchor" href="#_important_indices"></a>Important indices</h2>
<div class="sectionbody">
<div id="important_indices" class="paragraph">
<p>If you have generated the tables automatically using your JPA implementation (for example, Hibernate), you probably do not have all the right indexes set on your tables.
Different usages of the event store require different indexes to be set for optimal performance.
This list suggests the indexes that should be added for the different types of queries used by the default <code>EventStorageEngine</code> implementation:</p>
</div>
<details open>
<summary class="title"><strong>Normal operational use (storing and loading events)</strong></summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Table <code>DomainEventEntry</code>, columns <code>aggregateIdentifier</code> and <code>sequenceNumber</code> (unique index)</p>
</li>
<li>
<p>Table <code>DomainEventEntry</code>, <code>eventIdentifier</code> (unique index)</p>
</li>
</ul>
</div>
</div>
</details>
<details open>
<summary class="title"><strong>Snapshotting</strong></summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Table <code>SnapshotEventEntry</code>, <code>aggregateIdentifier</code> column.</p>
</li>
<li>
<p>Table <code>SnapshotEventEntry</code>, <code>eventIdentifier</code> (unique index)</p>
</li>
</ul>
</div>
</div>
</details>
<details open>
<summary class="title"><strong>Sagas</strong></summary>
<div class="content">
<div class="ulist">
<ul>
<li>
<p>Table <code>AssociationValueEntry</code>, columns <code>sagaType</code>, <code>associationKey</code> and <code>associationValue</code>,</p>
</li>
<li>
<p>Table <code>AssociationValueEntry</code>, columns <code>sagaId</code> and <code>sagaType</code>,</p>
</li>
</ul>
</div>
</div>
</details>
<div class="paragraph">
<p>The default column lengths generated by, for example, Hibernate may work, but won&#8217;t be optimal.
A UUID, for example, will always have the same length.
Instead of a variable length column of 255 characters, you could use a fixed length column of 36 characters for the aggregate identifier.</p>
</div>
<div class="paragraph">
<p>The <code>timestamp</code> column in the <code>DomainEventEntry</code> table only stores ISO 8601 timestamps.
If all times are stored in the UTC timezone, they need a column length of 24 characters.
If you use another timezone, this may be up to 28. Using variable length columns is generally not necessary, since time stamps always have the same length.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>It is highly recommended to store all timestamps in UTC format.
In countries with daylight saving time, storing timestamps in local time may result in sorting errors for events generated around and during the timezone switch.
This does not occur when UTC is used.
Some servers are configured to always use UTC.
Alternatively, you should configure the event store to convert timestamps to UTC before storing them.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The <code>type</code> column in the <code>DomainEventEntry</code> stores the type identifiers of aggregates.
Generally, these are the <code>'simple name'</code> of the aggregate.
Even the infamous <code>AbstractDependencyInjectionSpringContextTests</code> in Spring only counts 45 characters.
Here, again, a shorter (but variable) length field should suffice.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_auto_increment_and_sequences"><a class="anchor" href="#_auto_increment_and_sequences"></a>Auto-increment and sequences</h2>
<div class="sectionbody">
<div id="auto_increment_and_sequences" class="paragraph">
<p>When using a relational database as an event store, Axon Framework relies on an auto-increment value to allow <a href="../../events/event-processors/streaming/" class="xref page">streaming event processors</a> to read all events roughly in the order they were inserted.
We say "roughly", because "insert-order" and "commit-order" are different things.</p>
</div>
<div class="paragraph">
<p>While auto-increment values are (generally) generated at insert-time, these values only become visible at commit-time.
This means another process may observe these sequence numbers arriving in a different order.
While Axon Framework has mechanisms to ensure that eventually all events are handled, even when they become visible in a different order, there are limitations and performance aspects to consider.</p>
</div>
<div class="paragraph">
<p>When a <a href="../../events/event-processors/streaming/" class="xref page">streaming event processor</a> reads events, it uses the "global sequence" to track its progress.
When events become available in a different order than they were inserted, Axon Framework will encounter a "gap." Axon Framework will remember these "gaps" to verify that data has become available since the last read.
These gaps may be the result of events becoming visible in a different order, but also because a transaction was rolled back.
It is highly recommended to ensure that no gaps exist because of over eagerly increasing the sequence number.
The mechanism for checking gaps is convenient, but comes with a performance impact.</p>
</div>
<div class="paragraph">
<p>When using a <code>JpaEventStorageEngine</code>, Axon Framework relies on the JPA implementation to create the table structure.
While this will work, it is unlikely to provide the configuration that has the best performance for the database engine in use.
That is because Axon Framework uses default settings for the <code>@GeneratedValue</code> annotation.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When using the <code>@GeneratedValue</code> annotation as-is in Hibernate 6, the default increment value jumped to 50.
This change, in combination with, for example, the <a href="../../../../multitenancy-extension-reference/4.11/" class="xref page">multitenancy</a> extension, may lead to uniqueness issues.
Hence, it is strongly recommended to define a custom sequence generator, as described below.</p>
</div>
<div class="paragraph">
<p>Furthermore, if you use Hibernate&#8217;s <a href="#https://vladmihalcea.com/hibernate-hidden-gem-the-pooled-lo-optimizer/">pooled optimizer</a>, we suggest to set the <code>allocation-size</code> to <strong>1</strong>.
If this setting is left unchanged, Hibernate will prepare 50 (as per the default) sequences, increasing the change of <code>globalIndex</code> gaps when running several application instances.
Note that this does not resolve the chance of gaps entirely! However, it does make the window of opportunity a lot smaller.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To override these settings, create a file called <code>/META-INF/orm.xml</code> on the classpath, which looks as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;entity-mappings version="1.0" xmlns="http://java.sun.com/xml/ns/persistence/orm"&gt;
    &lt;mapped-superclass access="FIELD" metadata-complete="false" class="org.axonframework.eventhandling.AbstractSequencedDomainEventEntry"&gt;
        &lt;attributes&gt;
            &lt;id name="globalIndex"&gt;
                &lt;generated-value strategy="SEQUENCE" generator="myGenerator"/&gt;
                &lt;sequence-generator name="myGenerator" sequence-name="mySequence" allocation-size="1"/&gt;
            &lt;/id&gt;
        &lt;/attributes&gt;
    &lt;/mapped-superclass&gt;
&lt;/entity-mappings&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>It is important to specify <code>metadata-complete="false"</code>.
This indicates this file should be used to override existing annotations, instead of replacing them.
For the best results, ensure that the <code>DomainEventEntry</code>  table uses its own sequence.
This can be ensured by specifying a different sequence generator for that entity only.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_postgresql_lob_annotated_columns_and_default_hibernate_mapping"><a class="anchor" href="#_postgresql_lob_annotated_columns_and_default_hibernate_mapping"></a>PostgreSQL, <code>@LOB</code>-annotated columns, and default Hibernate mapping</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Specific to <a href="https://www.postgresql.org/">PostgreSQL</a> is its <a href="https://www.postgresql.org/docs/current/storage-toast.html">TOAST</a> and <a href="https://www.postgresql.org/docs/current/largeobjects.html">Large Object Storage</a> functionality.
TOAST stands for "the oversized attribute storage technique," ensuring columns that are (by default) larger than 8KB are:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Compressed <strong>if</strong> possible. If this is insufficient,</p>
</li>
<li>
<p>the wide columns is broken into chunks and moved to another table.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Any field that is moved out of line to this <em>other</em> "TOAST-table" will transparently be replaced by out-of-line identifiers.
Furthermore, TOASTing is only supported for PostgreSQL data types like <code>BYTEA</code> or <code>TEXT</code>.</p>
</div>
<div class="paragraph">
<p>Large Object Storage takes a slightly different route, as instead, it uses a fixed <code>OID</code> column type.
This "object identifier" will allow the main table to point to the actual data in a "large object storage table."
The Large Object Storage route will be traversed whenever a column type is a <code>LOB</code>, <code>BLOB</code>, or <code>CLOB</code>.</p>
</div>
<div class="paragraph">
<p>Although the Large Object Storage is a useful feature from PostgreSQL to help with large objects, it has some impact too, being:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>There is some added overhead when reading data, as the original and the large object table should be read.</p>
</li>
<li>
<p>Removing an object that has an OID column <strong>does not</strong> automatically remove it from the large object table.</p>
</li>
<li>
<p>Manually querying the table will result in an OID column instead of the actual data being shown.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Let us look how this behavior from PostgreSQL combines with Axon Framework when combined with JPA and Hibernate.</p>
</div>
<div class="paragraph">
<p>Axon Framework uses the <code>@Lob</code> in several columns and tables for its JPA-based support, being:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The <code>payload</code> and <code>meta_data</code> columns in the <code>domain_event_entry</code> table.</p>
</li>
<li>
<p>The <code>payload</code> and <code>meta_data</code> columns in the <code>snapshot_event_entry</code> table.</p>
</li>
<li>
<p>The <code>token</code> column in the <code>token_entry</code> table.</p>
</li>
<li>
<p>The <code>serialized_saga</code> column in the <code>saga_entry</code> table.</p>
</li>
<li>
<p>The <code>diagnostics</code>, <code>payload</code>, <code>metadata</code>, and <code>token</code> column in the <code>dead_letter_entry</code> table.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Furthermore, Hibernate will by default use the aforementioned <code>OID</code> type whenever an <code>@Lob</code> annotation is found.
Thus, the dedicate large object storage solution will be used if you are using PostgreSQL to store events, snapshots, tokens, sagas, and dead letters.</p>
</div>
<div class="paragraph">
<p>As events and snapshots are frequently read, the overhead predicament discussed earlier will be hit.
Arguably more problematic is issue two, especially for the <code>token_entry</code> table.</p>
</div>
<div class="paragraph">
<p>The "claim" on a token is frequently updated to allow correct collaboration in a distributed Axon setup (please read our <a href="../../events/event-processors/streaming/#tracking-tokens" class="xref page">Tracking Tokens</a> section for more details).
As the large object table is <strong>not</strong> automatically cleared, it will eventually overflow through all the updates.</p>
</div>
<div class="paragraph">
<p>Hence, it would be best to avoid the Large Object Storage behavior and instead opt for the transparent TOAST feature.
We can achieve this by adjusting Hibernate&#8217;s settings, to map the <code>@Lob</code> annotated fields to the <code>BYTEA</code> type.
Since Axon Framework stores a byte array in each of the <code>@Lob</code> annotated columns, changing it to the <code>BYTEA</code> type makes sense.</p>
</div>
<div class="paragraph">
<p>Luckily, changing these settings can be done with three easy steps:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Adjust the Hibernate dialect.</p>
</li>
<li>
<p>Override the Hibernate mapping.</p>
</li>
<li>
<p>[Optional] Migrate existing columns from OID to BYTEA.</p>
</li>
</ol>
</div>
<div class="sect2">
<h3 id="_hibernate_dialect_changes"><a class="anchor" href="#_hibernate_dialect_changes"></a>Hibernate dialect changes</h3>
<div class="paragraph">
<p>To adjust the dialect to <strong>not</strong> go for OID, we can enforce the type to <code>BYTEA</code> by providing a custom dialect.</p>
</div>
<div class="paragraph">
<p>Down below is a <code>PostgreSQLDialect</code> implementation that would get the trick done:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class ByteaEnforcedPostgresSQLDialect extends PostgreSQLDialect {

    public ByteaEnforcedPostgresSQLDialect(){
        super(DatabaseVersion.make(9, 5));
    }

    @Override
    protected String columnType(int sqlTypeCode) {
        return sqlTypeCode == SqlTypes.BLOB ? "bytea" : super.columnType(sqlTypeCode);
    }

    @Override
    protected String castType(int sqlTypeCode) {
        return sqlTypeCode == SqlTypes.BLOB ? "bytea" : super.castType(sqlTypeCode);
    }

    @Override
    public void contributeTypes(TypeContributions typeContributions,
                                ServiceRegistry serviceRegistry) {
        super.contributeTypes(typeContributions, serviceRegistry);
        JdbcTypeRegistry jdbcTypeRegistry = typeContributions.getTypeConfiguration()
                                                             .getJdbcTypeRegistry();
        jdbcTypeRegistry.addDescriptor(Types.BLOB, BinaryJdbcType.INSTANCE);
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>With the dialect in your application, your next step is to configure it to be used.
This can for example be done by setting the <code>jpa.database-platform</code> property when using Spring:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-properties hljs" data-lang="properties">jpa.database-platform=fully.qualified.classname.ByteaEnforcedPostgresSQLDialect</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_hibernate_mapping_override"><a class="anchor" href="#_hibernate_mapping_override"></a>Hibernate mapping override</h3>
<div class="paragraph">
<p>We use the Hibernate metadata override mechanism to tell which columns need to be of the BYTEA type instead of OID.
To that end, add a file named <code>orm.xml</code> (ORM stands for object-relational mapping) under <code>src/main/java/resources/META-INF</code> directory containing the overrides.</p>
</div>
<div class="paragraph">
<p>Below is an example of overriding the <code>serializedSaga</code> and <code>token</code> columns from the <code>SagaEntry</code> and <code>TokenEntry</code> respectively:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-xml hljs" data-lang="xml">&lt;entity-mappings xmlns="http://java.sun.com/xml/ns/persistence/orm" version="2.0"&gt;
    &lt;entity class="org.axonframework.modelling.saga.repository.jpa.SagaEntry"&gt;
        &lt;attribute-override name="serializedSaga"&gt;
            &lt;column name="serializedSaga" column-definition="BYTEA"&gt;&lt;/column&gt;
        &lt;/attribute-override&gt;
    &lt;/entity&gt;
    &lt;entity class="org.axonframework.eventhandling.tokenstore.jpa.TokenEntry"&gt;
        &lt;attribute-override name="token"&gt;
            &lt;column name="token" column-definition="BYTEA"&gt;&lt;/column&gt;
        &lt;/attribute-override&gt;
    &lt;/entity&gt;
 &lt;/entity-mappings&gt;</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_oid_to_bytea_column_migration"><a class="anchor" href="#_oid_to_bytea_column_migration"></a>OID to BYTEA column migration</h3>
<div class="paragraph">
<p>If you already have Axon-specific tables using the OID type, you need to migrate them to BYTEA.
The following SQL script can get the job done for the <code>token_entry</code> table:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-sql hljs" data-lang="sql">ALTER TABLE token_entry ADD COLUMN token_bytea BYTEA;
UPDATE token_entry SET token_bytea = lo_get(token);
ALTER TABLE token_entry  DROP COLUMN token;
ALTER TABLE token_entry  RENAME COLUMN token_bytea to token;</code></pre>
</div>
</div>
<div class="paragraph">
<p>After making all the changes and running the SQL script, the data-affected columns should now all be readable.</p>
</div>
</div>
</div>
</div>
        <nav class="pagination">
  <span class="prev"><a href="../command-processing/">Command Processing</a></span>
  <span class="next"><a href="../../monitoring/">Monitoring</a></span>
</nav>
    </article>
  </div>
</main>
</div>
      <footer class="footer">
  <div class="primary-footer">
    <div class="footer-logo ">
      <a href="https://axoniq.io/">
        <img src="https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=90&amp;height=20&amp;name=Logo%20AxonIQ%20(2).png" alt="Logo AxonIQ" loading="lazy" srcset="https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=45&amp;height=10&amp;name=Logo%20AxonIQ%20(2).png 45w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=90&amp;height=20&amp;name=Logo%20AxonIQ%20(2).png 90w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=135&amp;height=30&amp;name=Logo%20AxonIQ%20(2).png 135w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=180&amp;height=40&amp;name=Logo%20AxonIQ%20(2).png 180w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=225&amp;height=50&amp;name=Logo%20AxonIQ%20(2).png 225w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=270&amp;height=60&amp;name=Logo%20AxonIQ%20(2).png 270w" sizes="(max-width: 90px) 100vw, 90px" width="90" height="20">
      </a>
    </div>

    <div class="footer-menu">
	    <h3>Products</h3>
	    <div>
        <ul role="menu">
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/products/axon-framework">Axon Framework</a></li>
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/products/axon-server">Axon Server</a></li>
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/products/axoniq-console">AxonIQ Console</a></li>
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/blog/protect-sensitive-data-in-an-event-sourced-application">AxonIQ Data Protection</a></li>
        </ul>
      </div>
    </div>

    <div class="footer-menu">
	    <h3>Sites</h3>
	    <div>
        <ul role="menu">
          <li><a class="ext" target="_blank" href="http://support.axoniq.io/">Customer Support Portal</a></li>
          <li><a class="ext" target="_blank" href="https://academy.axoniq.io/">AxonIQ Academy</a></li>
          <li><a class="ext" target="_blank" href="https://console.axoniq.io/">AxonIQ Console</a></li>
          <li><a class="ext" target="_blank" href="https://discuss.axoniq.io/">AxonIQ Discuss</a></li>
        </ul>
      </div>
    </div>

    <div class="footer-menu">
	    <h3>Follow us</h3>
	    <div>
        <ul role="menu">
          <li><a class="ext" target="_blank" href="https://www.youtube.com/axoniq">YouTube</a></li>
          <li><a class="ext" target="_blank" href="https://www.linkedin.com/company/axoniq">LinkedIn</a></li>
          <li><a class="ext" target="_blank" href="https://github.com/AxonIQ">GitHub</a></li>
          <li><a class="ext" target="_blank" href="https://axoniq.bsky.social/">Bluesky</a></li>
        </ul>
      </div>
    </div>

    <div class="footer-menu">
	    <h3>&nbsp;</h3>
	    <div>
        <ul role="menu">
          <li><a class="ext" target="_blank" href="https://www.instagram.com/axoniq/">Instagram</a></li>
          <li><a class="ext" target="_blank" href="https://www.facebook.com/AxonIQ.io">Facebook</a></li>
          <li><a class="ext" target="_blank" href="https://twitter.com/axon_iq">Twitter</a></li>
          <li><a class="ext" target="_blank" href="https://medium.com/axoniq">Medium</a></li>
        </ul>
      </div>
    </div>

  </div>
</footer>
<script id="site-script" src="../../../../_/js/site.js" data-ui-root-path="../../../../_"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
<script async src="../../../../_/js/vendor/page-actions.js"></script>
<script async src="../../../../_/js/vendor/tabs.js" data-sync-storage-key="preferred-tab" data-sync-storage-scope="session"></script>
<script src="../../../../_/js/vendor/lunr.js"></script>
<script src="../../../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../../../.." data-snippet-length="100" data-stylesheet="../../../../_/css/search.css"></script>
<script async src="../../../../search-index.js"></script>
    </div>
  </body>
</html>
