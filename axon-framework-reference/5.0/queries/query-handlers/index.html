<!DOCTYPE html>
<html lang="en">
  <head>
        <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Query Handlers</title>
    <link rel="canonical" href="https://docs.axoniq.io/axon-framework-reference/5.0/queries/query-handlers/">
    <link rel="prev" href="../">
    <link rel="next" href="../query-dispatchers/">
    <meta name="generator" content="Antora 3.1.10">
    <link rel="stylesheet" href="../../../../_/css/site.css">
    <link rel="stylesheet" href="../../../../_/css/vendor/tabs.css">
    <link rel="icon" href="../../../../_/img/favicon.png" sizes="32x32">
    <link rel="apple-touch-icon" href="../../../../_/img/favicon.png"><!-- 180×180 -->
    <link rel="manifest" href="../../../../_/static/manifest.webmanifest">

        <!-- Google Tag Manager -->
        <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer','GTM-5QD58ZB');</script>
        <!-- End Google Tag Manager -->

    <script>var uiRootPath = '../../../../_'</script>


<link rel="icon" href="../../../../_/img/favicon.png" type="image/png">
  </head>
  <body class="article">
    <div class="header_container">
      
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5QD58ZB"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://docs.axoniq.io">
        <img src="../../../../_/img/docs-logo.png" class="header_logo"/>
      </a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-center">
        <a class="navbar-item" href="../../../../home/basics/">Basics</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="../../../../home/guides/">Guides</a>
          <div class="navbar-dropdown card">
            <a class="navbar-item" href="../../../../home/guides/axon-framework">Axon Framework</a>
            <a class="navbar-item" href="../../../../home/guides/axon-server">Axon Server</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="../../../../home/reference/">Reference</a>
          <div class="navbar-dropdown card">
                <a class="navbar-item" href="../../">Axon Framework</a>
                <a class="navbar-item" href="../../../../axon-framework-extensions/">Axon Framework Extensions</a>
                <a class="navbar-item" href="../../../../axon-server-reference/development/">Axon Server</a>
                <a class="navbar-item" href="../../../../synapse-reference/v0.12/">Axon Synapse</a>
                <a class="navbar-item" href="../../../../axoniq-platform-reference/">Axoniq Platform</a>
          </div>
        </div>
      </div>
      <div class="navbar-end">
          <div class="navbar-item search hide-for-print">
            <div id="search-field" class="field">
              <input id="search-input" type="text" placeholder="Search AxonIQ Docs">
            </div>
          </div>
        <a class="navbar-item navbar-button" href="https://platform.axoniq.io" target="_blank">Axoniq Platform</a>
      </div>
    </div>
  </nav>
</header>
      <div class="toolbar card" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../../home/" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../">Axon Framework Reference</a></li>
    <li><a href="../">Queries</a></li>
    <li><a href="./">Handling</a></li>
  </ul>
</nav>
<div class="page-actions">
  <button class="actions-menu-toggle" title="Show actions related to this page">Actions</button>
  <div class="actions-menu toolbar_dropdown_menu card">
      <a class="action item" href="https://github.com/AxonFramework/AxonFramework/edit/axon-5.0.x/docs/reference-guide/modules/queries/pages/query-handlers.adoc">Edit this Page</a>
    
    <a class="action item" href="https://discuss.axoniq.io/search?q&#x3D;Query%20Handlers" target="discuss_search">View Discussions</a>
    <a class="action item" href="https://discuss.axoniq.io/new-topic?category&#x3D;library&amp;title&#x3D;%22Query%20Handlers%22%20Discussion&amp;body&#x3D;%3C!--%20Replace%20this%20comment%20with%20your%20comment%2Fsuggestion%2Fquestion%2F...%20--%3E%0A%0A%0A%3C!--%0AKeep%20the%20section%20below!%0ALinking%20back%20to%20the%20documentation%20URL%20not%20only%20helps%20people%20go%20to%20the%20page%0Abut%20also%20helps%20find%20relevant%20discussions%20from%20the%20documentation%20page%20via%20the%20%22View%20Discussion%22%20menu.%0A--%3E%0A%5Bdetails%3D%22Related%20library%20page%22%5D%0A%5BQuery%20Handlers%5D(https%3A%2F%2Fdocs.axoniq.io%2Faxon-framework-reference%2F5.0%2Fqueries%2Fquery-handlers%2F)%0A%5B%2Fdetails%5D%0A" target="discuss_add">Start new discussion</a>
  </div>
</div>


<div class="page-versions">
  <button class="version-menu-toggle" title="Show other versions of page">5.0</button>
  <div class="version-menu toolbar_dropdown_menu card">
    <a class="version item" href="../../../development/queries/query-handlers/">development</a>
    <a class="version item is-current" href="./">5.0</a>
    <a class="version item" href="../../../4.12/queries/query-handlers/">4.12</a>
    <a class="version item" href="../../../4.11/queries/query-handlers/">4.11</a>
    <a class="version item" href="../../../4.10/queries/query-handlers/">4.10</a>
    <a class="version item is-missing" href="../../../0/">older releases</a>
  </div>
</div>
</div>
    </div>
    <div class="content_container">
      <div class="body">
<div class="nav-container" data-component="axon-framework-reference" data-version="5.0">
    <aside class="nav card">
      <div class="panels">
        <div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../../">Axon Framework</a></h3>

<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../">Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../migration/">Migration Guide</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../migration/why-upgrade/">Why Upgrade?</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../migration/prerequisites/">Prerequisites</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../migration/solved-architecture-choices/">Resolved Problems</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../migration/understanding-architecture-principles/">Understanding Choices</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../messaging-concepts/">Messaging Concepts</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../messaging-concepts/anatomy-message/">Anatomy of a Message</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../messaging-concepts/message-intercepting/">Message Intercepting</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../messaging-concepts/supported-parameters-annotated-handlers/">Supported Parameters for Annotated Handlers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../messaging-concepts/message-correlation/">Message Correlation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../messaging-concepts/exception-handling/">Exception Handling</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../messaging-concepts/processing-context/">Processing Context</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../commands/">Commands</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../commands/command-handlers/">Handling</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../commands/command-dispatchers/">Dispatching</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../commands/infrastructure/">Infrastructure</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../commands/configuration/">Configuration</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../events/">Events</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../events/event-handlers/">Handling</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../events/event-publishing/">Publishing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../events/event-processors/">Event Processors</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../events/event-processors/subscribing/">Subscribing Event Processor</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../events/event-processors/streaming/">Streaming Event Processor</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../events/event-processors/dead-letter-queue/">Dead-Letter Queue</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../events/infrastructure/">Infrastructure</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../events/event-store-internals/">Event Store Internals</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../events/event-versioning/">Versioning</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../">Queries</a>
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="./">Handling</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../query-dispatchers/">Dispatching</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../infrastructure/">Infrastructure</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../configuration/">Configuration</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../testing/">Testing</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../testing/basic-testing/">Basic Testing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../testing/matchers-and-field-filters/">Matchers and Field Filters</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../testing/advanced-testing/">Advanced Testing</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../conversion/">Conversion</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../tuning/">Tuning</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../tuning/event-snapshots/">Event Snapshots</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../tuning/event-processing/">Event Processing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../tuning/command-processing/">Command Processing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../tuning/rdbms-tuning/">Relational Databases</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../monitoring/">Monitoring</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../monitoring/tracing/">Tracing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../monitoring/metrics/">Metrics</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../monitoring/health/">Health Indicators</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../monitoring/processors/">Event Processor Monitoring</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../monitoring/message-tracking/">Message Tracking</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../spring-boot-integration/">Spring Boot Integration</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../modules/">Modules</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../release-notes/">Release Notes</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../release-notes/major-releases/">Major Releases</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../release-notes/minor-releases/">Minor Releases</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../known-issues-and-workarounds/">Known Issues and Workarounds</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
      </div>
    </aside>
</div>
<main class="article">
    <div class="page_content">
        <aside class="toc sidebar" data-title="Page content" data-levels="2">
  <div class="toc-menu"></div>
</aside>
          <article class="doc">
                <h1 class="page">Query Handlers</h1>
            <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>The handling of a query comes down to a query handler returning the query&#8217;s response. The goal of this chapter is to describe what such a query handler method looks like, as well as describing the call order and response type options. For configuration of query handlers and the <code>QueryBus</code>, it is recommended to read the <a href="../configuration/" class="xref page">Configuration</a> section.</p>
</div>
<div class="paragraph">
<p>Query handlers are fully async-native and can return <code>CompletableFuture</code>, <code>Publisher</code>, or synchronous results. The framework handles correlation data propagation automatically through the <code>ProcessingContext</code>.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="writing-query-handler"><a class="anchor" href="#writing-query-handler"></a>Writing a query handler</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In Axon, an object may declare a number of query handler methods, by for example annotating them with the <code>@QueryHandler</code> annotation. The object in question is what you would refer to as the Query Handler, or Query Handling Component. For a query handling method, the first declared parameter defines which query message object it will receive.</p>
</div>
<div class="paragraph">
<p>Taking the 'Gift Card' domain which contains a <code>CardSummary</code> Query Model, we can assume there is a query message to fetch a single <code>CardSummary</code> instance. Let us define the format of the query message as follows:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.axonframework.messaging.queryhandling.annotation.Query;

@Query(namespace = "giftcard", name = "FetchCardSummary", version = "1.0")
public class FetchCardSummaryQuery {

    private final String cardSummaryId;

    public FetchCardSummaryQuery(String cardSummaryId) {
        this.cardSummaryId = cardSummaryId;
    }
    // omitted getters, equals/hashCode, toString functions
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The query message is annotated with <code>@Query</code> to define its message type. The annotation specifies:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>namespace</code>: The bounded context or namespace for the query (defaults to the package name if omitted)</p>
</li>
<li>
<p><code>name</code>: The business/domain name of the query (defaults to the simple class name if omitted)</p>
</li>
<li>
<p><code>version</code>: The version of the query message (defaults to "1.0" if omitted)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Together, the namespace and name form a <code>QualifiedName</code>, which combined with the version creates the <code>MessageType</code>. This is how Axon identifies and routes the query, independent of the Java class name.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Annotating query messages</div>
<div class="paragraph">
<p>It&#8217;s recommended to annotate all query message classes with <code>@Query</code>. This allows you to:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Define an explicit message type independent of the Java class name.</p>
</li>
<li>
<p>Version your queries for evolution over time.</p>
</li>
<li>
<p>Organize queries by bounded context using namespaces.</p>
</li>
<li>
<p>Leverage payload conversion at handling time for different representations.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>If the <code>@Query</code> annotation is omitted, Axon will default to using the fully qualified class name as the query name, which tightly couples your message identity to your Java package structure.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This <code>FetchCardSummaryQuery</code> will be <a href="../query-dispatchers/" class="xref page">dispatched</a> to a handler that defines the given message as its first declared parameter. The handler will likely be contained in an object which is in charge of or has access to the <code>CardSummary</code> model in question:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.axonframework.messaging.queryhandling.QueryHandler;

public class CardSummaryProjection {

    private Map&lt;String, CardSummary&gt; cardSummaryStorage;

    @QueryHandler <i class="conum" data-value="1"></i><b>(1)</b>
    public CardSummary handle(FetchCardSummaryQuery query) { <i class="conum" data-value="2"></i><b>(2)</b>
        return cardSummaryStorage.get(query.getCardSummaryId());
    }
    // omitted CardSummary event handlers which update the model
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>@QueryHandler</code> annotation marks this method as a query handler.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The method signature defines the query payload (<code>FetchCardSummaryQuery</code>) as the first parameter and the return type (<code>CardSummary</code>) as the query response type.</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">Storing a query model</div>
<div class="paragraph">
<p>For the purpose of the example we have chosen to use a regular <code>Map</code> as the storage approach. In a real life system, this would be replaced by a form of database or repository layer, for example.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_query_name_resolution_and_message_types"><a class="anchor" href="#_query_name_resolution_and_message_types"></a>Query name resolution and message types</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Queries are identified by their <code>MessageType</code>, which consists of a <code>QualifiedName</code> (namespace + local name) and a version. This allows the message identity to be independent of the Java class structure.</p>
</div>
<div class="sect2">
<h3 id="_defining_the_query_name"><a class="anchor" href="#_defining_the_query_name"></a>Defining the query name</h3>
<div class="paragraph">
<p>The <code>MessageTypeResolver</code> determines how query names are resolved from query payload classes. By default, the query name is resolved as follows:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>If the <code>@Query</code> annotation is present on the query payload class, the annotation&#8217;s <code>namespace</code> and <code>localName</code> attributes define the qualified name, and the <code>version</code> attribute defines the version.</p>
</li>
<li>
<p>If the <code>@Query</code> annotation is absent, the fully qualified class name of the query payload class is used as the query name (with a default version).</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_matching_handlers_to_queries"><a class="anchor" href="#_matching_handlers_to_queries"></a>Matching handlers to queries</h3>
<div class="paragraph">
<p>Query handlers are matched to queries based on the query name. The <code>@QueryHandler</code> annotation can optionally specify a <code>queryName</code> attribute to explicitly declare which query name the handler wants to handle. If not specified, the handler matches queries whose name corresponds to the fully qualified class name of the handler&#8217;s first parameter type.</p>
</div>
<div class="paragraph">
<p>Example using the <code>@Query</code> annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.axonframework.messaging.queryhandling.annotation.Query;

@Query(namespace = "giftcard", name = "FetchCardSummary", version = "1.0")
public class FetchCardSummaryQuery {
    private final String cardSummaryId;

    public FetchCardSummaryQuery(String cardSummaryId) {
        this.cardSummaryId = cardSummaryId;
    }

    public String getCardSummaryId() {
        return cardSummaryId;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The query handler can then be written to handle this specific query type:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@QueryHandler
public CardSummary handle(FetchCardSummaryQuery query) {
    return cardSummaryStorage.get(query.getCardSummaryId());
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Since the handler&#8217;s first parameter is <code>FetchCardSummaryQuery</code>, and that class is annotated with <code>@Query(namespace = "giftcard", name = "FetchCardSummary")</code>, the handler will match queries with the qualified name <code>giftcard.FetchCardSummary</code>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_using_queryname_for_different_representations"><a class="anchor" href="#_using_queryname_for_different_representations"></a>Using queryName for different representations</h3>
<div class="paragraph">
<p>If you want the handler to receive the query in a different representation (not the <code>@Query</code> annotated class), you <strong>must</strong> explicitly specify the query name in the <code>@QueryHandler</code> annotation:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@QueryHandler(queryName = "giftcard.FetchCardSummary") <i class="conum" data-value="1"></i><b>(1)</b>
public CardSummary handle(Map&lt;String, Object&gt; queryData) { <i class="conum" data-value="2"></i><b>(2)</b>
    String cardId = (String) queryData.get("cardSummaryId");
    return cardSummaryStorage.get(cardId);
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>queryName</code> attribute is <strong>required</strong> when the first parameter is not the <code>@Query</code> annotated payload class. Without it, Axon would resolve the query handler above to handle queries with the name <code>java.util.Map</code>. As such, it wouldn&#8217;t know which query this handler should handle.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The handler receives the query as a <code>Map</code>, allowing flexible access to the query data.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>This approach allows the same query to be handled with different representations, as long as each handler explicitly declares which query name it handles. Furthermore, thes query handlers should belong to different applications, as the <code>QueryBus</code> will throw a <code>DuplicateQueryHandlerSubscriptionException</code> if a query handler for the same name is registered twice within a given JVM.</p>
</div>
</div>
<div class="sect2">
<h3 id="_payload_conversion_at_handling_time"><a class="anchor" href="#_payload_conversion_at_handling_time"></a>Payload conversion at handling time</h3>
<div class="paragraph">
<p>The query payload is automatically converted to the handler&#8217;s expected type at handling time. This means different handlers can receive the same query message in different Java representations, as long as the message types match.</p>
</div>
<div class="paragraph">
<p>This reduces the need for upcasters in many scenarios. The framework converts the payload when invoking the handler, so upcasters are primarily needed for structural changes to the message format rather than simple type conversions.</p>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// Handler expecting the query as a specific type
@QueryHandler
public CardSummary handle(FetchCardSummaryQuery query) {
    return cardSummaryStorage.get(query.getCardSummaryId());
}

// Another handler in another application could receive the same query in a different representation
@QueryHandler(queryName = "giftcard.FetchCardSummary") // Must specify queryName!
public CardDetails handle(Map&lt;String, Object&gt; query) {
    String cardId = (String) query.get("cardSummaryId");
    return detailedCardStorage.get(cardId);
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Both handlers can be invoked for queries with the same <code>MessageType</code>, but they receive the payload in their preferred format.</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="title">Single handler per query</div>
<div class="paragraph">
<p>Each query name can have only one registered handler. Attempting to register multiple handlers for the same query name will result in a <code>DuplicateQueryHandlerSubscriptionException</code>.</p>
</div>
<div class="paragraph">
<p>As such, the example above expects both queries to reside in different application instances.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_query_handler_chaining"><a class="anchor" href="#_query_handler_chaining"></a>Query handler chaining</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When you need information from another query to complete your query,
you might call the <code>QueryGateway</code> or <code>QueryBus</code> from your query handler.
This needs to be done with caution, as we create a dependency between two query handlers.</p>
</div>
<div class="sect2">
<h3 id="chaining-local"><a class="anchor" href="#chaining-local"></a>Local query handler</h3>
<div class="paragraph">
<p>When the secondary query handler is located in the same application,
you can still use
the <code>QueryGateway</code> or <code>QueryBus</code> to retrieve the information you need and keep the two components decoupled.
This gives you the freedom to move the other query handler to a different application in the future.</p>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">Projection dependency</div>
<div class="paragraph">
<p>When a query handler depends on another query in the same application, this can indicate a design issue.
Each projection processes events at their own pace, so two projections might not have the data in sync.
This can lead to unexpected behavior.</p>
</div>
<div class="paragraph">
<p>The proper solution is to create independent projections that contain all the data needed
to function correctly.
By duplicating data to the event processor locally,
you are guaranteed to have up-to-date data when handling a query, as well as the flexibility to change it.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When using the <code>DistributedQueryBus</code>, with for example the <code>AxonServerQueryBusConnector</code>, this secondary query will use a second thread to process in. If both queries block the thread, this could potentially lead to a deadlock.</p>
</div>
<div class="paragraph">
<p>Example: You have configured the <code>AxonServerQueryBusConnector</code> to have 1 thread, and you have query A and B in the same application.
Query A calls query B. Because query A is waiting on a response of query B, and query B is waiting for a thread to free up, this has now caused a deadlock.</p>
</div>
<div class="paragraph">
<p>You can take different routes to remedy this:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Not chaining queries in this way, and instead duplicating the data locally based on the events.</p>
</li>
<li>
<p>Returning a <code>CompletableFuture</code> from your query handlers, and using <code>thenCompose</code> to chain the queries. This will free up the thread to process other queries.</p>
</li>
<li>
<p>Configure your distributed query bus to have more threads available. This will reduce the chance of a deadlock, but it will not prevent it.</p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="_remote_query_handler"><a class="anchor" href="#_remote_query_handler"></a>Remote query handler</h3>
<div class="paragraph">
<p>When calling a remote query handler from your query handler, the response processing uses a separate thread pool, preventing thread exhaustion. This allows safe query chaining across distributed applications.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_query_handler_parameters"><a class="anchor" href="#_query_handler_parameters"></a>Query handler parameters</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Query handlers support parameter injection to access various framework components and message metadata during query processing. The first parameter is always the query payload, but additional parameters can be injected.</p>
</div>
<div class="sect2">
<h3 id="_processingcontext"><a class="anchor" href="#_processingcontext"></a><code>ProcessingContext</code></h3>
<div class="paragraph">
<p>The <code>ProcessingContext</code> is Axon&#8217;s message handling lifecycle tool. As such, it is always created by Axon when processing a (query) message. It provides access to resources, correlation data, and lifecycle hooks during query processing.</p>
</div>
<div class="paragraph">
<p>You can inject the <code>ProcessingContext</code> as a handler parameter:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@QueryHandler
public CardSummary handle(FetchCardSummaryQuery query, ProcessingContext context) {
    // Access correlation data
    String correlationId = context.correlationId();

    // Access resources
    SomeService service = context.resource(SomeService.RESOURCE_KEY);

    return cardSummaryStorage.get(query.getCardSummaryId());
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>When dispatching queries or commands from within a query handler, always pass the <code>ProcessingContext</code> to ensure correlation data flows correctly:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.axonframework.messaging.queryhandling.QueryGateway;
import org.axonframework.messaging.core.unitofwork.ProcessingContext;

@QueryHandler
public OrderDetails handle(FetchOrderDetailsQuery query,
                           ProcessingContext context,
                           QueryGateway queryGateway) {
    // Dispatch another query, passing the ProcessingContext for correlation
    CompletableFuture&lt;CustomerInfo&gt; customerInfo =
        queryGateway.query(new FetchCustomerQuery(query.getCustomerId()),
                          CustomerInfo.class,
                          context);

    return orderStorage.get(query.getOrderId());
}</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_queryupdateemitter"><a class="anchor" href="#_queryupdateemitter"></a><code>QueryUpdateEmitter</code></h3>
<div class="paragraph">
<p>For subscription queries, you can inject a <code>QueryUpdateEmitter</code> to emit updates to subscribers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.axonframework.messaging.queryhandling.QueryUpdateEmitter;
import org.axonframework.messaging.eventhandling.EventHandler;

@Component
public class CardSummaryProjection {

    @EventHandler
    public void on(CardRedeemedEvent event, QueryUpdateEmitter emitter) {

        // Update the model
        CardSummary summary = cardSummaryStorage.get(event.getCardId());
        summary.setRemainingValue(event.getRemainingValue());

        // Emit update to subscription queries
        emitter.emit(FetchCardSummaryQuery.class,
                    query -&gt; query.getCardSummaryId().equals(event.getCardId()),
                    summary);
    }
}</code></pre>
</div>
</div>
<div class="admonitionblock warning">
<table>
<tr>
<td class="icon">
<i class="fa icon-warning" title="Warning"></i>
</td>
<td class="content">
<div class="title">QueryUpdateEmitter injection</div>
<div class="paragraph">
<p>The <code>QueryUpdateEmitter</code> must be created using <code>QueryUpdateEmitter.forContext(ProcessingContext)</code> or injected as a parameter, <strong>not</strong> as a field. This ensures the emitter is aware of the current processing context and can properly handle correlation data and lifecycle hooks.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// WRONG - Do not inject as a field
@Component
public class CardSummaryProjection {
    private final QueryUpdateEmitter emitter; // ❌ Wrong!

    public CardSummaryProjection(QueryUpdateEmitter emitter) {
        this.emitter = emitter;
    }
}

// CORRECT - Create from ProcessingContext
@Component
public class CardSummaryProjection {
    @EventHandler
    public void on(CardRedeemedEvent event, QueryUpdateEmitter emitter) {
        // ✅ Correct!
        // Use emitter...
    }
}</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_other_parameters"><a class="anchor" href="#_other_parameters"></a>Other parameters</h3>
<div class="paragraph">
<p>Query handlers support additional parameter types:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Metadata</strong>: Inject <code>org.axonframework.messaging.core.Metadata</code> to access all message metadata.</p>
</li>
<li>
<p><strong>MetadataValue</strong>: Use <code>@MetadataValue("key")</code> to inject a specific metadata value.</p>
</li>
<li>
<p><strong>Message</strong>: Inject the complete <code>QueryMessage</code> to access all message properties.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">import org.axonframework.messaging.core.Metadata;
import org.axonframework.messaging.core.annotation.MetadataValue;

@QueryHandler
public CardSummary handle(FetchCardSummaryQuery query,
                          Metadata metadata,
                          @MetadataValue("userId") String userId) {
    logger.info("Query from user: {}", userId);
    return cardSummaryStorage.get(query.getCardSummaryId());
}</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_query_handler_return_values"><a class="anchor" href="#_query_handler_return_values"></a>Query handler return values</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Axon allows a multitude of return types for a query handler method, as defined <a href="#writing-query-handler">earlier</a> on this page. Query handlers can return single objects, collections, or asynchronous types. Below we share a list of all the options which are supported and tested in the framework.</p>
</div>
<div class="paragraph">
<p>For clarity, we distinguish between single instance and multiple instances of a response type. When dispatching a query via the <code>QueryGateway</code>, you specify the expected response type using either the <code>query()</code> method for single results or <code>queryMany()</code> method for multiple results.</p>
</div>
<div class="sect2">
<h3 id="_supported_single_instance_return_values"><a class="anchor" href="#_supported_single_instance_return_values"></a>Supported single instance return values</h3>
<div class="paragraph">
<p>When querying for a single object using <code>QueryGateway.query()</code>, the following query handler return types are supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An exact match of the requested type</p>
</li>
<li>
<p>A subtype of the requested type</p>
</li>
<li>
<p>A generic bound to the requested type</p>
</li>
<li>
<p>A <code>CompletableFuture</code> of the requested type (for async processing)</p>
</li>
<li>
<p>A <code>Mono</code> (from Project Reactor) of the requested type (for reactive async processing)</p>
</li>
<li>
<p>A primitive of the requested type (will be boxed)</p>
</li>
<li>
<p>An <code>Optional</code> of the requested type</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Primitive Return Types</div>
<div class="paragraph">
<p>Among the usual Objects, it is also possible for queries to return primitive data types:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class QueryHandler {

     @QueryHandler
     public float handle(QueryPrimitive query) {
     }
 }</code></pre>
</div>
</div>
<div class="paragraph">
<p>Note that the querying party will retrieve a boxed result instead of the primitive type.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_supported_multiple_instances_return_values"><a class="anchor" href="#_supported_multiple_instances_return_values"></a>Supported multiple instances return values</h3>
<div class="paragraph">
<p>When querying for multiple objects using <code>QueryGateway.queryMany()</code>, the following query handler return types are supported:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An array containing:</p>
<div class="ulist">
<ul>
<li>
<p>The requested type</p>
</li>
<li>
<p>A subtype of the requested type</p>
</li>
<li>
<p>A generic bound to the requested type</p>
</li>
</ul>
</div>
</li>
<li>
<p>An <code>Iterable</code> or a custom implementation of <code>Iterable</code> containing:</p>
<div class="ulist">
<ul>
<li>
<p>The requested type</p>
</li>
<li>
<p>A subtype of the requested type</p>
</li>
<li>
<p>A generic bound to the requested type</p>
</li>
<li>
<p>A wildcard bound to the requested type</p>
</li>
</ul>
</div>
</li>
<li>
<p>A <code>Stream</code> of the requested type</p>
</li>
<li>
<p>A <code>CompletableFuture</code> of an <code>Iterable</code> of the requested type (for async processing)</p>
</li>
<li>
<p>A <code>List</code>, <code>Set</code>, or other <code>Collection</code> of the requested type</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_streaming_query_return_values"><a class="anchor" href="#_streaming_query_return_values"></a>Streaming query return values</h3>
<div class="paragraph">
<p>For streaming queries using <code>QueryGateway.streamingQuery()</code>, query handlers can return:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>A <code>Publisher</code> (from Reactive Streams) of the requested type</p>
</li>
<li>
<p>A <code>Flux</code> (from Project Reactor) of the requested type</p>
</li>
<li>
<p>Any <code>Iterable</code>, <code>Stream</code>, or collection type (will be converted to a <code>Publisher</code>)</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Streaming queries allow you to handle large result sets efficiently by streaming results as they become available rather than loading everything into memory at once.</p>
</div>
</div>
<div class="sect2">
<h3 id="_unsupported_return_values"><a class="anchor" href="#_unsupported_return_values"></a>Unsupported return values</h3>
<div class="paragraph">
<p>The following list contains method return values which are not supported when queried for:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>An array of primitive types</p>
</li>
<li>
<p>A <code>Map</code> of a given key and value type</p>
</li>
</ul>
</div>
</div>
</div>
</div>
        <nav class="pagination">
  <span class="prev"><a href="../">Queries</a></span>
  <span class="next"><a href="../query-dispatchers/">Dispatching</a></span>
</nav>
    </article>
  </div>
</main>
</div>
      <footer class="footer">
  <div class="secondary-footer">
    <p>Copyright © 2025 AxonIQ BV. All Rights Reserved</p>
    <img referrerpolicy="no-referrer-when-downgrade" src="https://static.scarf.sh/a.png?x-pxid=e0b2b5cb-139e-4753-acab-bae43f90c5d3" />
  </div>
</footer>
<script id="site-script" src="../../../../_/js/site.js" data-ui-root-path="../../../../_"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
<script async src="../../../../_/js/vendor/page-actions.js"></script>
<script async src="../../../../_/js/vendor/tabs.js" data-sync-storage-key="preferred-tab" data-sync-storage-scope="session"></script>
<script src="../../../../_/js/vendor/lunr.js"></script>
<script src="../../../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../../../.." data-snippet-length="100" data-stylesheet="../../../../_/css/search.css"></script>
<script async src="../../../../search-index.js"></script>
    </div>
  </body>
</html>
