<!DOCTYPE html>
<html lang="en">
  <head>
        <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Event Snapshots</title>
    <link rel="canonical" href="https://docs.axoniq.io/axon-framework-reference/4.11/tuning/event-snapshots/">
    <link rel="prev" href="../">
    <link rel="next" href="../event-processing/">
    <meta name="generator" content="Antora 3.1.10">
    <link rel="stylesheet" href="../../../../_/css/site.css">
    <link rel="stylesheet" href="../../../../_/css/vendor/tabs.css">
    <link rel="icon" href="../../../../_/img/favicon.ico" sizes="32x32">
    <link rel="icon" href="../../../../_/img/icon.svg" type="image/svg+xml" media="(prefers-color-scheme: light)">
    <link rel="icon" href="../../../../_/img/icon-light.svg" type="image/svg+xml" media="(prefers-color-scheme: dark)">
    <link rel="apple-touch-icon" href="../../../../_/img/apple-touch-icon.png"><!-- 180Ã—180 -->
    <link rel="manifest" href="../../../../_/static/manifest.webmanifest">
        <!-- Google Tag Manager -->
        <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer','GTM-5QD58ZB');</script>
        <!-- End Google Tag Manager -->

    <script>var uiRootPath = '../../../../_'</script>


  </head>
  <body class="article">
    <div class="banner">
    <a href="https://console.axoniq.io">Manage and monitor your Axon Framework applications and Axon Server environments. <span class="banner_button" target="_blank">Try AxonIQ Console</span></a>
</div>    
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5QD58ZB"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://docs.axoniq.io"><img src="../../../../_/img/logo-dark4x.png" class="header_logo" /></a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="../../../../home/basics/">Basics</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="../../../../home/guides/">Guides</a>
          <div class="navbar-dropdown card">
            <a class="navbar-item" href="../../../../home/guides/axon-framework">Axon Framework</a>
            <a class="navbar-item" href="../../../../home/guides/axon-server">Axon Server</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="../../../../home/reference/">Reference</a>
          <div class="navbar-dropdown card">
                <a class="navbar-item" href="../../../4.11/">Axon Framework</a>
                <a class="navbar-item" href="../../../../axon-framework-extensions/">Axon Framework Extensions</a>
                <a class="navbar-item" href="../../../../axon-server-reference/v2024.2/">Axon Server</a>
                <a class="navbar-item" href="../../../../synapse-reference/v0.11/">Axon Synapse</a>
                <a class="navbar-item" href="../../../../axoniq-console-reference/">AxonIQ Console</a>
          </div>
        </div>
      </div>
      <div class="navbar-end">
        <div class="navbar-item search hide-for-print">
          <div id="search-field" class="field">
            <input id="search-input" type="text" placeholder="Search AxonIQ Docs">
          </div>
        </div>
        <a class="navbar-item navbar-button" href="https://academy.axoniq.io" target="_blank">AxonIQ Academy</a>
        <a class="navbar-item navbar-button" href="https://discuss.axoniq.io" target="_blank">AxonIQ Discuss</a>
        <a class="navbar-item navbar-button" href="https://axoniq.io/contact" target="_blank">Get in touch</a>
      </div>
    </div>
  </nav>
</header>
    <div class="toolbar card" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../../home/" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../">Axon Framework Reference</a></li>
    <li><a href="../">Tuning</a></li>
    <li><a href="./">Event Snapshots</a></li>
  </ul>
</nav>
<div class="page-actions">
  <button class="actions-menu-toggle" title="Show actions related to this page">Actions</button>
  <div class="actions-menu toolbar_dropdown_menu card">
      <a class="action item" href="https://github.com/AxonFramework/AxonFramework/edit/axon-4.10.x/docs/old-reference-guide/modules/tuning/pages/event-snapshots.adoc">Edit this Page</a>
    
    <a class="action item" href="https://discuss.axoniq.io/search?q&#x3D;Event%20Snapshots" target="discuss_search">View Discussions</a>
    <a class="action item" href="https://discuss.axoniq.io/new-topic?category&#x3D;library&amp;title&#x3D;%22Event%20Snapshots%22%20Discussion&amp;body&#x3D;%3C!--%20Replace%20this%20comment%20with%20your%20comment%2Fsuggestion%2Fquestion%2F...%20--%3E%0A%0A%0A%3C!--%0AKeep%20the%20section%20below!%0ALinking%20back%20to%20the%20documentation%20URL%20not%20only%20helps%20people%20go%20to%20the%20page%0Abut%20also%20helps%20find%20relevant%20discussions%20from%20the%20documentation%20page%20via%20the%20%22View%20Discussion%22%20menu.%0A--%3E%0A%5Bdetails%3D%22Related%20library%20page%22%5D%0A%5BEvent%20Snapshots%5D(https%3A%2F%2Fdocs.axoniq.io%2Faxon-framework-reference%2F4.10%2Ftuning%2Fevent-snapshots%2F)%0A%5B%2Fdetails%5D%0A" target="discuss_add">Start new discussion</a>
  </div>
</div>


<div class="page-versions">
  <button class="version-menu-toggle" title="Show other versions of page">4.10</button>
  <div class="version-menu toolbar_dropdown_menu card">
    <a class="version item" href="../../../development/tuning/event-snapshots/">development</a>
    <a class="version item" href="../../../4.11/tuning/event-snapshots/">4.11</a>
    <a class="version item is-current" href="./">4.10</a>
    <a class="version item is-missing" href="../../../0/">older releases</a>
  </div>
</div>
</div>
    <div class="content_container">
      <div class="body">
<div class="nav-container" data-component="axon-framework-reference" data-version="4.10">
    <aside class="nav card">
      <div class="panels">
        <div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../../">Axon Framework</a></h3>

<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../">Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../upgrading-to-4-7/">Upgrading to Axon Framework 4.7</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../messaging-concepts/">Messaging Concepts</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../messaging-concepts/anatomy-message/">Anatomy of a Message</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../messaging-concepts/message-correlation/">Message Correlation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../messaging-concepts/message-intercepting/">Message Intercepting</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../messaging-concepts/supported-parameters-annotated-handlers/">Supported Parameters for Annotated Handlers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../messaging-concepts/exception-handling/">Exception Handling</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../messaging-concepts/unit-of-work/">Unit of Work</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../axon-framework-commands/">Commands</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../axon-framework-commands/command-handlers/">Handling</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../axon-framework-commands/command-dispatchers/">Dispatching</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../axon-framework-commands/modeling/aggregate/">Aggregates</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../axon-framework-commands/modeling/multi-entity-aggregates/">Multi-Entity Aggregates</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../axon-framework-commands/modeling/state-stored-aggregates/">State Stored Aggregates</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../axon-framework-commands/modeling/aggregate-creation-from-another-aggregate/">Aggregate Creation from another Aggregate</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../axon-framework-commands/modeling/aggregate-polymorphism/">Aggregate Polymorphism</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../axon-framework-commands/modeling/conflict-resolution/">Conflict Resolution</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../axon-framework-commands/infrastructure/">Infrastructure</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../axon-framework-commands/configuration/">Configuration</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../events/">Events</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../events/event-handlers/">Handling</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../events/event-dispatchers/">Dispatching</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../events/event-processors/">Event Processors</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../events/event-processors/subscribing/">Subscribing Event Processor</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../events/event-processors/streaming/">Streaming Event Processor</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../../events/event-processors/dead-letter-queue/">Dead-Letter Queue</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../events/infrastructure/">Infrastructure</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../events/event-versioning/">Event Versioning</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../queries/">Queries</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../queries/query-handlers/">Handling</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../queries/query-dispatchers/">Dispatching</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../queries/implementations/">Implementations</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../queries/configuration/">Configuration</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../sagas/">Sagas</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../sagas/implementation/">Implementation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../sagas/associations/">Associations</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../sagas/infrastructure/">Infrastructure</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../deadlines/">Deadlines</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../deadlines/deadline-managers/">Deadline Managers</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../deadlines/event-schedulers/">Event Schedulers</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../testing/">Testing</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../testing/commands-events/">Commands / Events</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../testing/sagas-1/">Sagas</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../serialization/">Serialization</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../">Tuning</a>
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="./">Event Snapshots</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../event-processing/">Event Processing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../command-processing/">Command Processing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../rdbms-tuning/">Relational Databases</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../monitoring/">Monitoring</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../monitoring/tracing/">Distributed Tracing</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../monitoring/metrics/">Metrics</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../monitoring/health/">Health Indicators</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../monitoring/processors/">Event Processor Monitoring</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../monitoring/message-tracking/">Message Tracking</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../spring-boot-integration/">Spring Boot Integration</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../modules/">Modules</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../release-notes/">Release Notes</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../release-notes/major-releases/">Major Releases</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../release-notes/minor-releases/">Minor Releases</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../known-issues-and-workarounds/">Known Issues and Workarounds</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
      </div>
    </aside>
</div>
<main class="article">
    <div class="page_content">
        <aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
          <article class="doc">
            <h1 class="page">Event Snapshots</h1>
            <div class="sect1">
<h2 id="_snapshotting"><a class="anchor" href="#_snapshotting"></a>Snapshotting</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When aggregates live for a long time, and their state constantly changes, they will generate a large amount of events. Having to load all these events in to rebuild an aggregate&#8217;s state may have a big performance impact. The snapshot event is a domain event with a special purpose: it summarises an arbitrary amount of events into a single one. By regularly creating and storing a snapshot event, the event store does not have to return long lists of events. Just the latest snapshot events and all events that occurred after the snapshot was made.</p>
</div>
<div class="paragraph">
<p>For example, items in stock tend to change quite often. Each time an item is sold, an event reduces the stock by one. Every time a shipment of new items comes in, the stock is incremented by some larger number. If you sell a hundred items each day, you will produce at least 100 events per day. After a few days, your system will spend too much time reading in all these events just to find out whether it should raise an "ItemOutOfStockEvent". A single snapshot event could replace a lot of these events, just by storing the current number of items in stock.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="title">To measure it to know!</div>
<div class="paragraph">
<p><a href="../../../../axoniq-console-reference/features/metrics/#aggregate_metrics" class="xref page">AxonIQ Console</a> can measure the number of events that were loaded during command handling, so you know if you need to create snapshots or not. It&#8217;s also able to track many more interesting metrics, such as the load time of the aggregate, and the time it took to store the events.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_creating_a_snapshot"><a class="anchor" href="#_creating_a_snapshot"></a>Creating a snapshot</h3>
<div class="paragraph">
<p>Snapshot creation can be triggered by a number of factors, for example: the number of events created since the last snapshot, the time to initialize an aggregate exceeds a certain threshold, time-based, etc. Currently, Axon provides a mechanism that allows you to trigger snapshots based on an event count threshold.</p>
</div>
<div class="paragraph">
<p>The definition of when snapshots should be created, is provided by the <code>SnapshotTriggerDefinition</code> interface.</p>
</div>
<div class="paragraph">
<p>The <code>EventCountSnapshotTriggerDefinition</code> provides the mechanism to trigger snapshot creation when the number of events needed to load an aggregate exceeds a certain threshold. If the number of events needed to load an aggregate exceeds a certain configurable threshold, the trigger tells a <code>Snapshotter</code> to create a snapshot for the aggregate.</p>
</div>
<div class="paragraph">
<p>The snapshot trigger is configured on an event sourcing repository and has a number of properties that allow you to tweak triggering:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>Snapshotter</code> sets the actual snapshotter instance, responsible for creating and storing the actual snapshot event;</p>
</li>
<li>
<p><code>Trigger</code> sets the threshold at which to trigger snapshot creation;</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A <code>Snapshotter</code> is responsible for the actual creation of a snapshot. Typically, snapshotting is a process that should disturb the operational processes as little as possible. Therefore, it is recommended to run the snapshotter in a different thread. The <code>Snapshotter</code> interface declares a single method: <code>scheduleSnapshot()</code>, which takes the aggregate&#8217;s type and identifier as parameters.</p>
</div>
<div class="paragraph">
<p>Axon provides the <code>AggregateSnapshotter</code>, which creates and stores <code>AggregateSnapshot</code> instances. This is a special type of snapshot, since it contains the actual aggregate instance within it. The repositories provided by Axon are aware of this type of snapshot, and will extract the aggregate from it, instead of instantiating a new one. All events loaded after the snapshot events are streamed to the extracted aggregate instance.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><strong>Serializing a Snapshot Event</strong></p>
</div>
<div class="paragraph">
<p>Do make sure the <code>Serializer</code> instance you use (which defaults to the <code>XStreamSerializer</code>) is capable of serializing your aggregate.
The <code>XStreamSerializer</code> requires you to use either a Hotspot JVM, or your aggregate must either have an accessible default constructor or implement the <code>Serializable</code> interface.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>The <code>AbstractSnapshotter</code> provides a basic set of properties that allow you to tweak the way snapshots are created:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>EventStore</code> sets the event store, which is used to load past events and store the snapshots. This event store must implement the <code>SnapshotEventStore</code> interface.</p>
</li>
<li>
<p><code>Executor</code> sets the executor, such as a <code>ThreadPoolExecutor</code> that will provide the thread to process actual snapshot creation. By default, snapshots are created in the thread that calls the <code>scheduleSnapshot()</code> method, which is generally not recommended for production.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <code>AggregateSnapshotter</code> provides one more property:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>AggregateFactories</code> is the property that allows you to set the factories that will create instances of your aggregates.
Configuring multiple aggregate factories allows you to use a single <code>Snapshotter</code> to create snapshots for a variety of aggregate types.
The <code>EventSourcingRepository</code> implementations and the <code>AggregateConfiguration</code> provide access to the <code>AggregateFactory</code> being used for a given Aggregate.
Both provide the factory through the <code>EventSourcingRepository#getAggregateFactory</code> and <code>AggregateConfiguration#aggregateFactory</code> methods respectively.
The result from either can be used to configure the same aggregate factories in the <code>Snapshotter</code> as the ones used by the Aggregate.</p>
</li>
</ul>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><strong>Snapshotter Configuration</strong></p>
</div>
<div class="paragraph">
<p>If you use an executor that executes snapshot creation in another thread, make sure you configure the correct transaction management for your underlying event store, if necessary.</p>
</div>
<div class="paragraph">
<p>For both non-Spring and Spring users a default <code>Snapshotter</code> is provided.
The former uses the Configuration API to provide a default <code>AggregateSnapshotter</code>, retrieving the aggregate factories from the registered Aggregates / <code>AggregateConfiguration`s.
Spring uses a `SpringAggregateSnapshotter</code>, which will automatically looks up the right <code>AggregateFactory</code> instances from the application context when a snapshot needs to be created.</p>
</div>
<div class="paragraph">
<p>The <code>@Revision</code> annotation has a dedicated, automatically configured <code>SnapshotFilter</code> implementation. This implementation is used to filter out non-matching snapshots from the <code>Repository&#8217;s loading process.
So when the `@Revision</code> annotation is used on an aggregate the snapshots will be filtered out automatically. When the`@Revision` on an aggregate is missing a <code>RevisionSnapshotFilter</code> is configured for revision <code>null</code>.</p>
</div>
</blockquote>
</div>
<div class="sect3">
<h4 id="_axon_configuration_api"><a class="anchor" href="#_axon_configuration_api"></a>Axon Configuration API</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">AggregateConfigurer&lt;GiftCard&gt; giftCardConfigurer =
        AggregateConfigurer.defaultConfiguration(GiftCard.class)
                           .configureSnapshotTrigger(config -&gt; new EventCountSnapshotTriggerDefinition(
                                   config.snapshotter(), 500
                           ));
Configurer configurer = DefaultConfigurer.defaultConfiguration()
                                         .configureAggregate(giftCardConfigurer);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_spring_boot_auto_configuration"><a class="anchor" href="#_spring_boot_auto_configuration"></a>Spring Boot auto configuration</h4>
<div class="paragraph">
<p>It is possible to define a custom <code>SnapshotTriggerDefinition</code> for an aggregate as a Spring bean.
In order to tie the <code>SnapshotTriggerDefinition</code> bean to an aggregate, use the <code>snapshotTriggerDefinition</code> attribute on <code>@Aggregate</code> annotation.
Listing below shows how to define a custom <code>EventCountSnapshotTriggerDefinition</code> which will take a snapshot every 500 events.</p>
</div>
<div class="paragraph">
<p>Note that a <code>Snapshotter</code> instance, if not explicitly defined as a bean already, will be automatically configured for you.
This means you can simply pass the <code>Snapshotter</code> as a parameter to your <code>SnapshotTriggerDefinition</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public SnapshotTriggerDefinition giftCardSnapshotTrigger(Snapshotter snapshotter) {
    return new EventCountSnapshotTriggerDefinition(snapshotter, 500);
}

...

@Aggregate(snapshotTriggerDefinition = "giftCardSnapshotTrigger")
public class GiftCard {...}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_storing_snapshot_events"><a class="anchor" href="#_storing_snapshot_events"></a>Storing snapshot events</h3>
<div class="paragraph">
<p>When a snapshot is stored in the event store, it will automatically use that snapshot to summarize all prior events and return it in their place. All event store implementations allow for concurrent creation of snapshots. This means they allow snapshots to be stored while another process is adding events for the same aggregate. This allows the snapshotting process to run as a separate process altogether.</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><strong>Snapshots as a replacement of your events?</strong></p>
</div>
<div class="paragraph">
<p>Normally, you can archive all events once they are part of a snapshot event.
Snapshotted events will never be read in again by the event store in regular operational scenarios.
However, if you want to be able to reconstruct an aggregate state prior to the moment the snapshot was created, you must keep the events up to that date.</p>
</div>
</blockquote>
</div>
<div class="paragraph">
<p>Axon provides a special type of snapshot event: the <code>AggregateSnapshot</code>, which stores an entire aggregate as a snapshot. The motivation is simple: your aggregate should only contain the state relevant to take business decisions. This is exactly the information you want captured in a snapshot. All event sourcing repositories provided by Axon recognize the <code>AggregateSnapshot</code>, and will extract the aggregate from it. Beware that using this snapshot event requires that the event serialization mechanism needs to be able to serialize the aggregate.</p>
</div>
</div>
<div class="sect2">
<h3 id="_filtering_snapshot_events"><a class="anchor" href="#_filtering_snapshot_events"></a>Filtering snapshot events</h3>
<div class="paragraph">
<p>When enabling snapshotting, several snapshots would be stored per Aggregate instance in the event store.
At a certain stage, some of these snapshot events are no longer being used by the application as newer versions took their place.
Especially if these snapshot events portray an old format of the aggregate by using the <code>AggregateSnapshot</code> event would it be smart to no longer load these.</p>
</div>
<div class="paragraph">
<p>You could take the stance of dropping all the snapshots which are stored (for a given aggregate type), but this means snapshots will be recreated with a 100% certainty.
It is also possible to filter out snapshot events when reading your Aggregate from the event store.
To that end, a <code>SnapshotFilter</code> can be defined per Aggregate type or for the entire <code>EventStore</code>.</p>
</div>
<div class="paragraph">
<p>The <code>SnapshotFilter</code> is a functional interface, providing two main operations: <code>allow(DomainEventData&lt;?)</code> and <code>combine(SnapshotFilter)</code>.
The former provides the <code>DomainEventData</code> which reflects the snapshot events.
The latter allows combining several `SnapshotFilter`s together.</p>
</div>
<div class="paragraph">
<p>The following snippets show how to configure a <code>SnapshotFilter</code>:</p>
</div>
<div class="sect3">
<h4 id="_axon_configuration_api_2"><a class="anchor" href="#_axon_configuration_api_2"></a>Axon Configuration API</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">SnapshotFilter giftCardSnapshotFilter = snapshotData -&gt; /* allow or disallow this snapshotData */;

AggregateConfigurer&lt;GiftCard&gt; giftCardConfigurer =
        AggregateConfigurer.defaultConfiguration(GiftCard.class)
                           .configureSnapshotFilter(config -&gt; giftCardSnapshotFilter);
Configurer configurer = DefaultConfigurer.defaultConfiguration()
                                         .configureAggregate(giftCardConfigurer);</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_spring_boot_auto_configuration_2"><a class="anchor" href="#_spring_boot_auto_configuration_2"></a>Spring Boot auto configuration</h4>
<div class="paragraph">
<p>It is possible to define a custom <code>SnapshotFilter</code> for an aggregate as a Spring bean.
In order to tie the <code>SnapshotFilter</code> bean to an aggregate, use the <code>snapshotFilter</code> attribute on <code>@Aggregate</code> annotation.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Bean
public SnapshotFilter giftCardSnapshotFilter() {
    return snapshotData -&gt; /* allow or disallow this snapshotData */;
}

...

@Aggregate(snapshotFilter = "giftCardSnapshotFilter")
public class GiftCard {...}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above snippet would be feasible to follow <em>if</em> fine-grained control is required when filtering snapshots from the store.
For example, when your snapshots are not based on the Aggregate class (which is the default).
When this is not required, you can base yourself on the default <code>SnapshotFilter</code> - the <code>RevisionSnapshotFilter</code>.</p>
</div>
<div class="paragraph">
<p>To configure this <code>SnapshotFilter</code>, all you have to do is use the <code>@Revision</code> annotation on your Aggregate class.
In doing so, the <code>RevisionSnapshotFilter</code> is set, filtering non-matching snapshots from the <code>Repository&#8217;s loading process, based on the value maintained within the `@Revision</code> annotation.</p>
</div>
<div class="paragraph">
<p>Through this, with every new production deployment of your application that adjusts the Aggregate state, you would only have to adjust the revision value in the annotation.
Check out the following example for how to set this up:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">// "1" is an example revision value.
// You're free to choose whatever value that fits your application's versioning scheme.
@Revision("1")
public class GiftCard {
    // Omitted aggregate internals for simplicity.
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_initializing_an_aggregate_based_on_a_snapshot_event"><a class="anchor" href="#_initializing_an_aggregate_based_on_a_snapshot_event"></a>Initializing an aggregate based on a snapshot event</h3>
<div class="paragraph">
<p>A snapshot event is an event like any other. That means a snapshot event is handled just like any other domain event. When using annotations to demarcate event handlers (<code>@EventHandler</code>), you can annotate a method that initializes full aggregate state based on a snapshot event. The code sample below shows how snapshot events are treated like any other domain event within the aggregate.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class MyAggregate extends AbstractAnnotatedAggregateRoot {

    // ...

    @EventHandler
    protected void handleSomeStateChangeEvent(MyDomainEvent event) {
        // ...
    }

    @EventHandler
    protected void applySnapshot(MySnapshotEvent event) {
        // the snapshot event should contain all relevant state
        this.someState = event.someState;
        this.otherState = event.otherState;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>There is one type of snapshot event that is treated differently: the <code>AggregateSnapshot</code>. This type of snapshot event contains the actual aggregate. The aggregate factory recognizes this type of event and extracts the aggregate from the snapshot. Then, all other events are re-applied to the extracted snapshot. That means aggregates never need to be able to deal with <code>AggregateSnapshot</code> instances themselves.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_caching"><a class="anchor" href="#_caching"></a>Caching</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A well-designed command handling module should pose no problems when implementing caching.
Especially when using event sourcing, loading an aggregate from an Event Store can be an expensive operation.
With a properly configured cache in place, loading an aggregate can be converted into a pure in-memory process.</p>
</div>
<div class="paragraph">
<p>To that end, Axon allows the configuration of a <code>Cache</code> object.
The framework currently provides several implementations to choose from:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>WeakReferenceCache</code> - An in-memory cache solution. In most scenarios, this is a good start.</p>
</li>
<li>
<p><code>EhCacheAdapter</code> -
An <code>AbstractCacheAdapter</code>, wrapping <a href="https://www.ehcache.org/">EhCache</a> into a usable solution for Axon. This can be used with major version 2, and is therefore deprecated.</p>
</li>
<li>
<p><code>EhCache3Adapter</code> -
An <code>AbstractCacheAdapter</code>, wrapping <a href="https://www.ehcache.org/">EhCache</a> into a usable solution for Axon. This can be used only with major version 3. Which has a <a href="https://mvnrepository.com/artifact/org.ehcache/ehcache">different group name</a> than version 2.</p>
</li>
<li>
<p><code>JCacheAdapter</code> -
An <code>AbstractCacheAdapter</code>, wrapping <a href="https://www.javadoc.io/doc/javax.cache/cache-api/1.0.0/index.html">JCache</a> into a usable solution for Axon.</p>
</li>
<li>
<p><code>AbstractCacheAdapter</code> - Abstract implementation towards supporting Axon&#8217;s <code>Cache</code> API.
Helpful in writing an adapter for a cache implementation that Axon does not support out of the box.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Before configuring a <code>Cache</code>, please consider the following guidelines.
They will help you get the most out of your caching solution:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Make sure the unit of work never needs to perform a rollback for functional reasons.</strong>
A rollback means that an aggregate has reached an invalid state.
Axon will automatically invalidate the cache entries involved.
The following request will force the aggregate to be reconstructed from its events.
If you use exceptions as a potential (functional) return value, you can configure a <code>RollbackConfiguration</code> on your command bus.
By default, the configuration will roll back the unit of work on unchecked exceptions for command handlers and on all exceptions for event handlers.</p>
</li>
<li>
<p><strong>All commands for a single aggregate must arrive on the machine with the aggregate in its cache.</strong>
This requirement means that commands should be consistently routed to the same machine for as long as that machine is "healthy."
Routing commands consistently prevents the cache from going stale.
A hit on a stale cache will cause a command to be executed and fail when events are stored in the event store.
By default, Axon&#8217;s distributed command bus components will use consistent hashing to route commands.</p>
</li>
<li>
<p><strong>Configure a sensible time to live / time to idle.</strong>
By default, caches tend to have a relatively short time to live, a matter of minutes.
For a command handling component with consistent routing, a longer time-to-idle and time-to-live is usually better.
This setting prevents the need to re-initialize an aggregate based on its events because its cache entry expired.
The time-to-live of your cache should match the expected lifetime of your aggregate.</p>
</li>
<li>
<p><strong>Cache data in-memory.</strong>
For proper optimization, caches should keep data in-memory (and preferably on-heap) for best performance.
This approach prevents the need to (re)serialize aggregates when storing to disk and even off-heap.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>To configure a cache for your Aggregates, consider the following snippet:</p>
</div>
<div class="sect3">
<h4 id="_axon_configuration_api_3"><a class="anchor" href="#_axon_configuration_api_3"></a>Axon Configuration API</h4>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class AxonConfig {
    // omitting other configuration methods...
    public void configureAggregateWithCache(Configurer configurer) {
        AggregateConfigurer&lt;GiftCard&gt; giftCardConfigurer =
                AggregateConfigurer.defaultConfiguration(GiftCard.class)
                                   .configureCache(config -&gt; new WeakReferenceCache());

        configurer.configureAggregate(giftCardConfigurer);
    }
}</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_spring_boot_auto_configuration_3"><a class="anchor" href="#_spring_boot_auto_configuration_3"></a>Spring Boot auto configuration</h4>
<div class="paragraph">
<p>The <code>Aggregate</code> annotation allows specification of the cache bean:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Aggregate(cache = "giftCardCache")
public class GiftCard {
    // state, command handlers and event sourcing handlers...
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This approach does require the bean name to be present in the Application Context of course:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Configuration
public class AxonConfig {
    // omitting other configuration methods...
    @Bean
    public Cache giftCardCache() {
        return new WeakReferenceCache();
    }
}</code></pre>
</div>
</div>
</div>
</div>
</div>
        <nav class="pagination">
  <span class="prev"><a href="../">Tuning</a></span>
  <span class="next"><a href="../event-processing/">Event Processing</a></span>
</nav>
    </article>
  </div>
</main>
</div>
      <footer class="footer">
  <div class="primary-footer">
    <div class="footer-logo ">
      <a href="https://axoniq.io/">
        <img src="https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=90&amp;height=20&amp;name=Logo%20AxonIQ%20(2).png" alt="Logo AxonIQ" loading="lazy" srcset="https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=45&amp;height=10&amp;name=Logo%20AxonIQ%20(2).png 45w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=90&amp;height=20&amp;name=Logo%20AxonIQ%20(2).png 90w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=135&amp;height=30&amp;name=Logo%20AxonIQ%20(2).png 135w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=180&amp;height=40&amp;name=Logo%20AxonIQ%20(2).png 180w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=225&amp;height=50&amp;name=Logo%20AxonIQ%20(2).png 225w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=270&amp;height=60&amp;name=Logo%20AxonIQ%20(2).png 270w" sizes="(max-width: 90px) 100vw, 90px" width="90" height="20">
      </a>
    </div>

    <div class="footer-menu">
	    <h3>Products</h3>
	    <div>
        <ul role="menu">
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/products/axon-framework">Axon Framework</a></li>
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/products/axon-server">Axon Server</a></li>
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/products/axoniq-cloud">AxonIQ Cloud</a></li>
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/products/axoniq-console">AxonIQ Console</a></li>
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/products/axon-synapse">Axon Synapse</a></li>
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/blog/protect-sensitive-data-in-an-event-sourced-application">AxonIQ Data Protection</a></li>
        </ul>
      </div>
    </div>

    <div class="footer-menu">
	    <h3>Sites</h3>
	    <div>
        <ul role="menu">
          <li><a class="ext" target="_blank" href="http://support.axoniq.io/">Customer Support Portal</a></li>
          <li><a class="ext" target="_blank" href="https://academy.axoniq.io/">AxonIQ Academy</a></li>
          <li><a class="ext" target="_blank" href="https://console.axoniq.io/">AxonIQ Console</a></li>
          <li><a class="ext" target="_blank" href="https://discuss.axoniq.io/">AxonIQ Discuss</a></li>
          <li><a class="ext" target="_blank" href="https://console.cloud.axoniq.io">AxonIQ Cloud</a></li>
        </ul>
      </div>
    </div>

    <div class="footer-menu">
	    <h3>Follow us</h3>
	    <div>
        <ul role="menu">
          <li><a class="ext" target="_blank" href="https://www.youtube.com/axoniq">YouTube</a></li>
          <li><a class="ext" target="_blank" href="https://www.linkedin.com/company/axoniq">LinkedIn</a></li>
          <li><a class="ext" target="_blank" href="https://github.com/AxonIQ">GitHub</a></li>
          <li><a class="ext" target="_blank" href="https://axoniq.bsky.social/">Bluesky</a></li>
          <li><a class="ext" target="_blank" href="https://www.instagram.com/axoniq/">Instagram</a></li>
          <li><a class="ext" target="_blank" href="https://www.facebook.com/AxonIQ.io">Facebook</a></li>
          <li><a class="ext" target="_blank" href="https://twitter.com/axon_iq">Twitter</a></li>
          <li><a class="ext" target="_blank" href="https://medium.com/axoniq">Medium</a></li>
        </ul>
      </div>
    </div>
  </div>
</footer>
<script id="site-script" src="../../../../_/js/site.js" data-ui-root-path="../../../../_"></script>
<script async src="../../../../_/js/vendor/highlight.js"></script>
<script async src="../../../../_/js/vendor/page-actions.js"></script>
<script async src="../../../../_/js/vendor/tabs.js" data-sync-storage-key="preferred-tab" data-sync-storage-scope="session"></script>
<script src="../../../../_/js/vendor/lunr.js"></script>
<script src="../../../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../../../.." data-snippet-length="100" data-stylesheet="../../../../_/css/search.css"></script>
<script async src="../../../../search-index.js"></script>
    </div>
  </body>
</html>
