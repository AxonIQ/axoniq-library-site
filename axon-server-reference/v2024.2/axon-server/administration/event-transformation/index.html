<!DOCTYPE html>
<html lang="en">
  <head>
        <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Event Transformation</title>
    <link rel="canonical" href="https://docs.axoniq.io/axon-server-reference/v2024.2/axon-server/administration/event-transformation/">
    <link rel="prev" href="../tiered-storage/">
    <link rel="next" href="../tagging/">
    <meta name="generator" content="Antora 3.1.10">
    <link rel="stylesheet" href="../../../../../_/css/site.css">
    <link rel="stylesheet" href="../../../../../_/css/vendor/tabs.css">
    <link rel="icon" href="../../../../../_/img/favicon.ico" sizes="32x32">
    <link rel="icon" href="../../../../../_/img/icon.svg" type="image/svg+xml" media="(prefers-color-scheme: light)">
    <link rel="icon" href="../../../../../_/img/icon-light.svg" type="image/svg+xml" media="(prefers-color-scheme: dark)">
    <link rel="apple-touch-icon" href="../../../../../_/img/apple-touch-icon.png"><!-- 180Ã—180 -->
    <link rel="manifest" href="../../../../../_/static/manifest.webmanifest">
        <!-- Google Tag Manager -->
        <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer','GTM-5QD58ZB');</script>
        <!-- End Google Tag Manager -->

    <script>var uiRootPath = '../../../../../_'</script>


  </head>
  <body class="article">
    <div class="banner">
    <a href="https://console.axoniq.io">Manage and monitor your Axon Framework applications and Axon Server environments. <span class="banner_button" target="_blank">Try AxonIQ Console</span></a>
</div>    
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5QD58ZB"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://docs.axoniq.io"><img src="../../../../../_/img/logo-dark4x.png" class="header_logo" /></a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="../../../../../home/basics/">Basics</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="../../../../../home/guides/">Guides</a>
          <div class="navbar-dropdown card">
            <a class="navbar-item" href="../../../../../home/guides/axon-framework">Axon Framework</a>
            <a class="navbar-item" href="../../../../../home/guides/axon-server">Axon Server</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="../../../../../home/reference/">Reference</a>
          <div class="navbar-dropdown card">
                <a class="navbar-item" href="../../../../../axon-framework-reference/4.11/">Axon Framework</a>
                <a class="navbar-item" href="../../../../../axon-framework-extensions/">Axon Framework Extensions</a>
                <a class="navbar-item" href="../../../">Axon Server</a>
                <a class="navbar-item" href="../../../../../synapse-reference/v0.11/">Axon Synapse</a>
                <a class="navbar-item" href="../../../../../axoniq-console-reference/">AxonIQ Console</a>
          </div>
        </div>
      </div>
      <div class="navbar-end">
        <div class="navbar-item search hide-for-print">
          <div id="search-field" class="field">
            <input id="search-input" type="text" placeholder="Search AxonIQ Docs">
          </div>
        </div>
        <a class="navbar-item navbar-button" href="https://academy.axoniq.io" target="_blank">AxonIQ Academy</a>
        <a class="navbar-item navbar-button" href="https://discuss.axoniq.io" target="_blank">AxonIQ Discuss</a>
        <a class="navbar-item navbar-button" href="https://axoniq.io/contact" target="_blank">Get in touch</a>
      </div>
    </div>
  </nav>
</header>
    <div class="toolbar card" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../../../home/" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../../">Axon Server Reference</a></li>
    <li><a href="../">Administration</a></li>
    <li><a href="./">Event Transformation</a></li>
  </ul>
</nav>
<div class="page-actions">
  <button class="actions-menu-toggle" title="Show actions related to this page">Actions</button>
  <div class="actions-menu toolbar_dropdown_menu card">

    <a class="action item" href="https://discuss.axoniq.io/search?q&#x3D;Event%20Transformation" target="discuss_search">View Discussions</a>
    <a class="action item" href="https://discuss.axoniq.io/new-topic?category&#x3D;library&amp;title&#x3D;%22Event%20Transformation%22%20Discussion&amp;body&#x3D;%3C!--%20Replace%20this%20comment%20with%20your%20comment%2Fsuggestion%2Fquestion%2F...%20--%3E%0A%0A%0A%3C!--%0AKeep%20the%20section%20below!%0ALinking%20back%20to%20the%20documentation%20URL%20not%20only%20helps%20people%20go%20to%20the%20page%0Abut%20also%20helps%20find%20relevant%20discussions%20from%20the%20documentation%20page%20via%20the%20%22View%20Discussion%22%20menu.%0A--%3E%0A%5Bdetails%3D%22Related%20library%20page%22%5D%0A%5BEvent%20Transformation%5D(https%3A%2F%2Fdocs.axoniq.io%2Faxon-server-reference%2Fv2024.2%2Faxon-server%2Fadministration%2Fevent-transformation%2F)%0A%5B%2Fdetails%5D%0A" target="discuss_add">Start new discussion</a>
  </div>
</div>


<div class="page-versions">
  <button class="version-menu-toggle" title="Show other versions of page">v2024.2</button>
  <div class="version-menu toolbar_dropdown_menu card">
    <a class="version item" href="../../../../development/axon-server/administration/event-transformation/">development</a>
    <a class="version item" href="../../../../v2025.0/axon-server/administration/event-transformation/">v2025.0</a>
    <a class="version item is-current" href="./">v2024.2</a>
    <a class="version item" href="../../../../v2024.1/axon-server/administration/event-transformation/">v2024.1</a>
    <a class="version item is-missing" href="../../../../0/">older releases</a>
  </div>
</div>
</div>
    <div class="content_container">
      <div class="body">
<div class="nav-container" data-component="axon-server-reference" data-version="v2024.2">
    <aside class="nav card">
      <div class="panels">
        <div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../../../">Axon Server</a></h3>

<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../">Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../installation/">Installation</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../installation/local-installation/">Local installation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../installation/docker-k8s/">Docker / K8s</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../">Administration</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../admin-configuration/">Configuration</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../admin-configuration/configuration/">System properties</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../admin-configuration/command-line-interface/">Command Line Interface</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../admin-configuration/rest-api/">REST API</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../admin-configuration/grpc-api/">gRPC API</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../monitoring/">Monitoring</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../monitoring/actuator-endpoints/">Actuator Endpoints</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../monitoring/axon-server-metrics/">Axon Server Metrics</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../monitoring/grpc-metrics/">gRPC Metrics</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../monitoring/heartbeat-monitoring/">Heartbeat Monitoring</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../monitoring/diagnostics/">Diagnostics</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../clustering/">Clusters</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../replication-groups/">Replication Groups</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../multi-context/">Multi-Context</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../tiered-storage/">Tiered Storage</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="./">Event Transformation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../tagging/">Tagging</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../backup-and-messaging-only-nodes/">Backup and Messaging-Only Nodes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../backups/">Backups</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../recovery/">Recovery</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../plugins/">Axon Server Plugins</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../logging/">Logging</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../logging/logging-format/">Logging Format</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../error-codes/">Error Codes</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../security/">Security</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../security/ssl/">SSL</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../security/access-control-ee/">Access Control for Axon Server</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../security/access-control-clients/">Security for Axon Framework Client Applications</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../security/access-control-cli/">Access Control and the CLI</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../security/access-control-api/">Access Control on the REST and gRPC APIs</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../security/access-control-ldap/">Axon Server EE - LDAP Extension</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../security/access-control-oauth2/">Axon Server EE - OAuth Extension</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../performance/">Performance</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../performance/tuning-event-processing/">Event Segments</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../performance/flow-control/">Flow Control</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../migration/">Migration</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../migration/non-axon-server-to-axon-server/">Non-Axon Server to Axon Server</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../../release-notes/">Release Notes</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../rn-as-major-releases/">Major Releases</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../rn-as-minor-releases/">Patch Releases</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
      </div>
    </aside>
</div>
<main class="article">
    <div class="page_content">
        <aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
          <article class="doc">
            <h1 class="page">Event Transformation</h1>
            <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><!-- vale Google.Passive = NO -->
<!-- vale Google.Will = NO -->
<!-- vale Google.We = NO -->
<!-- vale Google.FirstPerson = NO -->
<!-- vale Google.EnDash = NO -->
<!-- vale proselint.But = NO -->
<!-- vale AxonIQ.Headings = NO --></p>
</div>
<div class="paragraph">
<p>The new Event Transformation feature allows users to perform specific event transformations like updates and deletes in the event store, utilizing the Event Transformation API.
This functional change is intended to facilitate more flexible event management in rare instances where modifications are unavoidable.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_objective_and_justification"><a class="anchor" href="#_objective_and_justification"></a>Objective and justification</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Event transformation sounds like an oxymoron to you?</p>
</div>
<div class="paragraph">
<p>Don&#8217;t worry, it is not our intention to change what is by its nature immutable: a fact happened in the past.
But there are situations when we believe it is not forbidden to manipulate the way the events are stored.</p>
</div>
<div class="sect2">
<h3 id="_what_does_it_mean_to_transform_events"><a class="anchor" href="#_what_does_it_mean_to_transform_events"></a>What does it mean to transform events?</h3>
<div class="paragraph">
<p>An event is immutable.
An event lasts forever.
This is true, and we strongly believe in these rules.
But like any other rule, there are few exceptions that should not be underestimated.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s say that you start using your event store in production.
After some time you realize you have a security issue since you forgot to encrypt the sensitive data inside your events.
What should you do?</p>
</div>
<div class="paragraph">
<p>The only solution is to change the way events are stored in the event store.
This does not mean they change their semantic, but only their persisted representation.</p>
</div>
<div class="paragraph">
<p>Another typical use-case is when you want to forget some old data, because it is stale.
You just want to get rid of it, to free some space.</p>
</div>
<div class="paragraph">
<p>So, to sum it up: we transform events either by changing their format (not the semantic) or by deleting them.</p>
</div>
<div class="sect3">
<h4 id="_when_you_could_transform_your_events"><a class="anchor" href="#_when_you_could_transform_your_events"></a>When you could transform your events?</h4>
<div class="paragraph">
<p>The event transformation feature fits well all situations where you need to manipulate the persisted representation of the events, without touching their semantic.
It could be used, for example, in the following cases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>to get rid of a large number of up-casters, which could affect your performance</p>
</li>
<li>
<p>to encrypt sensitive data inside your events</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="_when_you_should_not_transform_your_events"><a class="anchor" href="#_when_you_should_not_transform_your_events"></a>When you should not transform your events?</h4>
<div class="paragraph">
<p>The event transformation feature is not intended to manipulate events semantically.
It should not be used, for example, in the following cases:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>to fix a bug</p>
</li>
<li>
<p>to change history</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_what"><a class="anchor" href="#_what"></a>What?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Whenever we need to change the representation of events in the Event Store, we desire this change to be as atomic as possible.
We are going to change events by introducing the concept of the Transformation.
Transformation is essentially a bucket of actions that are going to be performed against the Event Store.
Currently, the supported actions are the deletion of events and the replacement of events.
Once we gather all actions that we want to use to transform our Event Store, we are going to apply those actions to it.</p>
</div>
<div class="paragraph">
<p>Since the number of those actions we want to perform against the Event Store can be large, we must ensure that our Event Store is not impacted by the Transformation itself.
In other words, it must behave as the Transformation is not happening at all.
Our little helper in this scenario is the fact that Event Store is immutable by its nature.
We are going to create a new version of our event segments by reading current events and transforming them according to the bucket of actions we have collected for the specific Transformation.
Axon Server will make sure to always read the latest version of event segments.
The transformation process will increase disk space usage, since it creates multiple versions of the same events.
For this reason, before you start transforming your events, make sure there is enough free disk space.
If you decide to change the entire Event Store in one Transformation, this would require free space larger than twice the space occupied by the event store.</p>
</div>
<div class="paragraph">
<p>Once the transformation is complete, the disk space can be freed up again through the compaction procedure, a way to clean older versions of event segments that should be invoked only when we are absolutely sure they are no longer needed.</p>
</div>
<div class="paragraph">
<p>To limit the possible misusing of the Event Store Transformation, we are going to make sure that there is only one ACTIVE Transformation of the Event Store at the time.
Having this in mind there are several states in which our Event Store can end up in.
Let&#8217;s talk about them.</p>
</div>
<div class="sect2">
<h3 id="_the_event_store_states"><a class="anchor" href="#_the_event_store_states"></a>The event store states</h3>
<div class="paragraph">
<p>In order to prevent more than one transformation happening at the same time we are going to have our Event Store transition between IDLE, TRANSFORMING, and COMPACTING states.</p>
</div>
<div class="sect3">
<h4 id="_idle"><a class="anchor" href="#_idle"></a>IDLE</h4>
<div class="paragraph">
<p>IDLE state is the state representing a normal operation of the Event Store, meaning that there is no any Transformation happening at the time.
While being in this state, Event Store is open for starting a new Transformation.
If choosing so, we are going to end up in the following state called TRANSFORMING.</p>
</div>
</div>
<div class="sect3">
<h4 id="_transforming"><a class="anchor" href="#_transforming"></a>TRANSFORMING</h4>
<div class="paragraph">
<p>Once our Event Store ends up in TRANSFORMING state, that means that no new Transformation can be accepted until we either apply this Transformation or we cancel it.
Do note, that even during TRANSFORMING state, Event Store can append new events and can also read existing ones.</p>
</div>
</div>
<div class="sect3">
<h4 id="_compacting"><a class="anchor" href="#_compacting"></a>COMPACTING</h4>
<div class="paragraph">
<p>By applying the Transformation to the Event Store, we are creating the new version of event segments.
This can make a significant impact on our disk space availability.
To overcome that, Event Store introduces a compact option which will get rid of all older versions of event segments.
By compacting the Event Store we enter the COMPACTING state and once compaction is done, we move back to IDLE.</p>
</div>
</div>
<div class="sect3">
<h4 id="_state_flow_of_the_event_store"><a class="anchor" href="#_state_flow_of_the_event_store"></a>State flow of the event store</h4>
<div class="paragraph">
<p>Let&#8217;s depict what we have talked about in previous chapter in a form of a state diagram.</p>
</div>
<div class="imageblock kroki">
<div class="content">
<img src="../../../_images/diag-0f96593c8934e3982cd84aba0339ee3f50efcc02.svg" alt="Diagram">
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_the_transformation"><a class="anchor" href="#_the_transformation"></a>The transformation</h3>
<div class="paragraph">
<p>As we already said, the Transformation is a bucket of actions.
Those actions are event deletion and event replacement.
The Transformation itself is started by invoking the START TRANSFORMATION operation which moves the Event Store to TRANSFORMING state and initializes the newly created Transformation in the ACTIVE state.
After that, we are allowed to send DELETE and REPLACE event actions to the Axon Server.
Axon Server will store them durably.
Up until this point, the content of the Event Store remains unchanged.
Once we are happy with the Transformation Actions, we can call the APPLY operation to apply the Transformation; in other words, to effectively change the Event Store.</p>
</div>
<div class="paragraph">
<p>Depending on the number of actions, apply operation can take a while, but once it&#8217;s completed, we can say that the Transformation is APPLIED.
After that, the Event Store moves to IDLE state.</p>
</div>
<div class="paragraph">
<p>Instead of applying the Transformation, we can also decide to CANCEL it; after the active Transformation has been cancelled, the Event Store moves to IDLE state and this makes it available for accepting new Transformations.</p>
</div>
<div class="sect3">
<h4 id="_apply_considerations"><a class="anchor" href="#_apply_considerations"></a>APPLY considerations</h4>
<div class="paragraph">
<p>As you might have concluded already, the apply process can take a while.
This means that the caller cannot wait for this process to complete.
Hence, the caller is only going to START applying process, and it will be done in the background.
By monitoring the state of the Transformation you can understand when the apply process has been completed.</p>
</div>
<div class="paragraph">
<p>During the apply process, it might happen that while reading events you get a mixture of old and newly transformed events.
This is absolutely fine, and you must take this fact into the consideration when building your system that invokes the Transformation.</p>
</div>
</div>
<div class="sect3">
<h4 id="_state_flow_of_the_transformation"><a class="anchor" href="#_state_flow_of_the_transformation"></a>State flow of the transformation</h4>
<div class="paragraph">
<p>Let&#8217;s depict what we have talked about in previous chapter in a form of a state diagram.</p>
</div>
<div class="imageblock kroki">
<div class="content">
<img src="../../../_images/diag-035d226eadd468972c9d79e8f09dcafc5a6d5011.svg" alt="Diagram">
</div>
</div>
</div>
<div class="sect3">
<h4 id="_cleaning_transformation_resources"><a class="anchor" href="#_cleaning_transformation_resources"></a>Cleaning transformation resources</h4>
<div class="paragraph">
<p>Once we apply or cancel the Transformation, the actions we have collected and stored are useless.
To mitigate this issue there is a Cleaning Task that is going to from time to time check whether there are resources to be cleaned.
Basically, it&#8217;ll check for all applied and cancelled transformations and clean their resources.</p>
</div>
</div>
<div class="sect3">
<h4 id="_cluster_considerations"><a class="anchor" href="#_cluster_considerations"></a>Cluster considerations</h4>
<div class="paragraph">
<p>When a Transformation runs in a cluster environment, several aspects must be taken into consideration.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>The Transformation creation is replicated across the nodes in the same replication group.</p>
</li>
<li>
<p>The Transformation Actions are replicated too.
In other word, each node will persist all Transformation Actions.</p>
</li>
<li>
<p>Apply and Cancel Operations are replicated.</p>
</li>
<li>
<p>Each node does the applying of the Transformation at its own pace.</p>
</li>
<li>
<p>Once all storage nodes in the replication group have applied the Transformation, the Transformation is considered APPLIED.
The majority of nodes in not enough.
The reason for this maybe strong requirement is to prevent possible mixed scenarios.</p>
</li>
</ul>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_how"><a class="anchor" href="#_how"></a>How?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Axon Server will need to persist your Event Transformation Actions to a dedicated storage.
By default, the location where all transformation data is stored is the <code>transformation</code> folder.
You can customize this location using the following property:</p>
</div>
<div class="paragraph">
<p><code>axoniq.axonserver.transformation.storage</code></p>
</div>
<div class="paragraph">
<p>Please be aware that the transformation store could be huge, exactly like the event store.
Select a storage location with a suitable size.</p>
</div>
<div class="sect2">
<h3 id="_how_to_transform_events"><a class="anchor" href="#_how_to_transform_events"></a>How to transform events</h3>
<div class="paragraph">
<p>Anytime you want to change events already written in the event store, you need to create a new Transformation.
A newly created Transformation is in ACTIVE state.
While being ACTIVE, the Transformation can accept all changes you want to perform.
Once all changes have been registered, the Transformation can be APPLIED.
Only when the Transformation is applied the changes are effective inside your Event Store.</p>
</div>
<div class="paragraph">
<p>The simplest way to transform the events in your Java project, is to use the Axon Server Connector.
Axon Server Connector supports Event Transformation feature starting from version 2023.1.0.</p>
</div>
<div class="sect3">
<h4 id="_connecting_to_axon_server"><a class="anchor" href="#_connecting_to_axon_server"></a>Connecting to Axon Server</h4>
<div class="paragraph">
<p>You can use <code>AxonServerConnectionFactory#forClient</code> static method to build your <code>AxonServerConnectionFactory</code> that could be used to open a new <code>AxonServerConnection</code>.
See the following example:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>AxonServerConnectionFactory.forClient("event-transformer")
                           .routingServers(new ServerAddress("localhost", 8124))
                           .build();</pre>
</div>
</div>
<div class="paragraph">
<p>The <code>AxonServerConnectionFactory</code> can be used to establish a connection with a specific <code>context</code>, using the method
<code>AxonServerConnectionFactory#connect(context)</code>.
This method establishes a long living connection to Axon Server for the specified context.
This connection remains open until the <code>AxonServerConnection#disconnect</code> method is invoked.
You can check whether your client is connected by invoking the <code>AxonServerConnection#isConnected</code> method.</p>
</div>
<div class="paragraph">
<p>Remember to always disconnect your client after you performed the desired operation.</p>
</div>
</div>
<div class="sect3">
<h4 id="_fluent_api"><a class="anchor" href="#_fluent_api"></a>Fluent API</h4>
<div class="paragraph">
<p>The simplest way to transform your events is to implement your own <code>EventTransformer</code>.
The <code>EventTransformer</code> is simply a <code>BiConsumer&lt;EventWithToken, Appender&gt;</code>, where the first argument is the original event, and the second argument is the <code>Appender</code> that can be used to append the desired transformation action for the event.
In other words, the <code>Appender</code> allows you to perform two different operations:
- delete event - replace event</p>
</div>
<div class="paragraph">
<p>To better understand how to use the <code>EventTransformer</code>, we will analyze the following example:</p>
</div>
<div class="paragraph">
<p><code>EventSources.range) -&gt; connection.eventChannel(), 0, 200) .filter(eventWithToken -&gt; isUnencrypted(eventWithToken.getEvent()
.transform(&quot;Encryption of sensitive data&quot;,
(eventWithToken, appender) -&gt; appender.replaceEvent(eventWithToken.getToken(),
encrypt(eventWithToken.getEvent())))
.execute) -&gt; connection.eventTransformationChannel(
.get();</code></p>
</div>
<div class="paragraph">
<p>In order to access to the events currently stored in your Event Store, you can use the static methods offered by
<code>EventSources</code> interfaces.
The <code>range(eventChannelProvider, fistToken, lastToken)</code> method, will allow you to access the event stream starting from the specified firstToken, until the specified lastToken.</p>
</div>
<div class="paragraph">
<p>It is possible to filter the event stream, invoking the <code>filter(predicate)</code> method.
When the stream is properly filtered (if needed), it is possible to transform the events, by invoking the <code>transform</code>
method, with the description of the Transformation and the <code>EventTransformer</code> that implements the business logic of the transformation itself.
Since the <code>EventTransformer</code> is a functional interface, it can also be expressed as a lambda.</p>
</div>
<div class="paragraph">
<p>These APIs take a declarative approach, that means that nothing happens until the pipeline is not executed, invoking the
<code>execute(eventTranformationChannelSupplier)</code> method.</p>
</div>
<div class="paragraph">
<p>This method takes care of multiple operations:
- open a new transformation with the specified description - run the event transformer - request the transformation to be applied</p>
</div>
<div class="paragraph">
<p>The <code>execute</code> method returns a <code>CompletableFuture</code>: wait for the completion before checking the result.
The request to apply the transformation is executed by a scheduled task.
That means that you could wait some time before being able to see the events transformed in your Event Store.</p>
</div>
<div class="paragraph">
<p>If you don&#8217;t need to read the events currently stored in your Event Store, you can transform your events by implementing your own <code>Transformer</code>.
The <code>Transformer#transform(appender)</code> provides you the <code>Appender</code> needed to append the required transformation actions.</p>
</div>
<div class="paragraph">
<p>For example, you can delete the event with token 100 and replace event with token 562L with the following snippet:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    Transformer transformer = appender -&gt; {
        appender.deleteEvent(100L);
        appender.replaceEvent(562L, replacement);
    };</pre>
</div>
</div>
<div class="paragraph">
<p>You can run the Transformation by invoking the <code>EventTransformationChannel#transform</code> method.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    connection.eventTransformationChannel()
              .transform("Transformation test", transformer);</pre>
</div>
</div>
<div class="paragraph">
<p>As before, this method takes care of multiple operations:
- open a new transformation with the specified description - run the transformer - request the transformation to be applied</p>
</div>
<div class="paragraph">
<p>And don&#8217;t forget that also the <code>transform</code> method returns a <code>CompletableFuture</code>.
As before, you must wait for its completion, and after that, you could wait some time before being able to see the events transformed in your Event Store.</p>
</div>
</div>
<div class="sect3">
<h4 id="_step_by_step_way_to_transform_your_events"><a class="anchor" href="#_step_by_step_way_to_transform_your_events"></a>Step-by-step way to transform your events</h4>
<div class="paragraph">
<p>If you want to have a full control of all the state changes of your transformation, you can use the <code>ActiveTransformation</code>.</p>
</div>
<div class="paragraph">
<p>In order to open a new transformation, use the <code>EventTransformationChannel#newTransformation(description)</code> method.</p>
</div>
<div class="paragraph">
<p>To transform your Event Store, you need to implement a <code>Transformer</code> (just like in the prev example).
The transformer will be executed by invoking the <code>ActiveTransformation#transform(transformer)</code> method.</p>
</div>
<div class="paragraph">
<p>An active transformation can be either applied or cancelled.
To apply the active transformation, you can use <code>ActiveTransformation#startApplying()</code> method.
To cancel the active transformation, you can use <code>ActiveTransformation#cancel()</code> method.</p>
</div>
<div class="paragraph">
<p>All methods in <code>ActiveTransformation</code> return `CompletableFuture`s.
Remember to compose them when needed.</p>
</div>
<div class="paragraph">
<p>This is the snippet of code that opens a new Transformation with the specified description, runs the transformer and finally requests the transformation to be applied.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>    connection.eventTransformationChannel()
              .newTransformation("My transformation description")
              .thenCompose(activeTransformation -&gt; activeTransformation.transform(transformer))
              .thenCompose(ActiveTransformation::startApplying);</pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_access_control"><a class="anchor" href="#_access_control"></a>Access control</h4>
<div class="paragraph">
<p>When engaging in event transformation, certain roles are necessary to ensure secured process.
Here&#8217;s a detailed explanation of each role:</p>
</div>
<div class="paragraph">
<p><strong>TRANSFORM</strong></p>
</div>
<div class="paragraph">
<p>Users granted the TRANSFORM role can prepare a transformation and get information about transformations.
However, they are not able to apply transformations.</p>
</div>
<div class="paragraph">
<p><strong>TRANSFORM_ADMIN</strong></p>
</div>
<div class="paragraph">
<p>To apply a transformation you need the transform_admin role.</p>
</div>
<div class="paragraph">
<p>To create and apply transformations <strong>users will need both roles</strong>.</p>
</div>
</div>
<div class="sect3">
<h4 id="_how_to_check_the_transformations_for_a_context"><a class="anchor" href="#_how_to_check_the_transformations_for_a_context"></a>How to check the transformations for a context</h4>
<div class="paragraph">
<p>In order to read all transformations that have been created for a context, you can use the <code>EventTransformationChannel</code>
provided by your <code>AxonServerConnection</code>.</p>
</div>
<div class="paragraph">
<p>The method <code>EventTransformationChannel#transformations</code> will provide a <code>CompletableFuture</code> of all the transformations created for a context and their current state.
Remember, you can have one and only one ACTIVE transformation for each context.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_how_to_compact_the_event_store"><a class="anchor" href="#_how_to_compact_the_event_store"></a>How to compact the event store</h3>
<div class="paragraph">
<p>Whenever a transformation is applied, the events in the Event Store are changed.
Axon Server, to perform the changes, does not delete the previous form of the events, it just creates a new version of the events saving them into a new segment version.</p>
</div>
<div class="paragraph">
<p>This choice was made for security reasons, because we don&#8217;t want the Axon Server to delete anything unless explicitly requested.
However, this choice has a negative impact on disk space.
In fact, every time I create a new segment version, I&#8217;m doubling the space needed to save those events.</p>
</div>
<div class="paragraph">
<p>For this reason, Axon Server provides a feature that allows you to compact the event store, deleting the previous versions once they are no longer needed.</p>
</div>
<div class="paragraph">
<p>You can request the compaction by invoking the <code>EventTransformationChannel#startCompacting</code> method.
Be carefull, this will permanently delete the previous versions of your events.</p>
</div>
</div>
<div class="sect2">
<h3 id="_troubleshooting"><a class="anchor" href="#_troubleshooting"></a>Troubleshooting</h3>
<div class="sect3">
<h4 id="_there_is_already_ongoing_transformation"><a class="anchor" href="#_there_is_already_ongoing_transformation"></a>"There is already ongoing transformation"</h4>
<div class="paragraph">
<p>Remember, you can have one and only one ACTIVE transformation for each context.
If you try to create a new transformation when there is another one in ACTIVE state, you will receive this error.</p>
</div>
<div class="paragraph">
<p>To solve the problem, you can either - cancel the already existing ACTIVE transformation - apply the already existing ACTIVE transformation - continue working on already existing ACTIVE transformation starting from where it stopped</p>
</div>
<div class="paragraph">
<p>In the last case, you can retrieve the <code>ActiveTransformation</code> that is already created with the method
<code>EventTransformationChannel#activeTransformation</code>.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_how_to_use_the_grpc_api_directly"><a class="anchor" href="#_how_to_use_the_grpc_api_directly"></a>How to use the gRPC API directly</h3>
<div class="paragraph">
<p>If you are not using Java, or if you are just curious to try, you can try to use the gRPC/HTTP operations directly.</p>
</div>
<div class="paragraph">
<p>For HTTP endpoints, please refer to the Swagger UI for the documentation.</p>
</div>
</div>
<div class="sect2">
<h3 id="_how_to_deactivate_the_transformation_feature_in_axon_server"><a class="anchor" href="#_how_to_deactivate_the_transformation_feature_in_axon_server"></a>How to deactivate the transformation feature in Axon Server</h3>
<div class="paragraph">
<p>The Event Transformation functionality is enabled by default, starting from AxonServer 2023.1.0.
In order to deactivate the feature, it is sufficient to add the following property in Axon Server property file:</p>
</div>
<div class="paragraph">
<p><code>axoniq.axonserver.event-transformation.enabled=false</code></p>
</div>
</div>
</div>
</div>
        <nav class="pagination">
  <span class="prev"><a href="../tiered-storage/">Tiered Storage</a></span>
  <span class="next"><a href="../tagging/">Tagging</a></span>
</nav>
    </article>
  </div>
</main>
</div>
      <footer class="footer">
  <div class="primary-footer">
    <div class="footer-logo ">
      <a href="https://axoniq.io/">
        <img src="https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=90&amp;height=20&amp;name=Logo%20AxonIQ%20(2).png" alt="Logo AxonIQ" loading="lazy" srcset="https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=45&amp;height=10&amp;name=Logo%20AxonIQ%20(2).png 45w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=90&amp;height=20&amp;name=Logo%20AxonIQ%20(2).png 90w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=135&amp;height=30&amp;name=Logo%20AxonIQ%20(2).png 135w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=180&amp;height=40&amp;name=Logo%20AxonIQ%20(2).png 180w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=225&amp;height=50&amp;name=Logo%20AxonIQ%20(2).png 225w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=270&amp;height=60&amp;name=Logo%20AxonIQ%20(2).png 270w" sizes="(max-width: 90px) 100vw, 90px" width="90" height="20">
      </a>
    </div>

    <div class="footer-menu">
	    <h3>Products</h3>
	    <div>
        <ul role="menu">
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/products/axon-framework">Axon Framework</a></li>
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/products/axon-server">Axon Server</a></li>
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/products/axoniq-cloud">AxonIQ Cloud</a></li>
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/products/axoniq-console">AxonIQ Console</a></li>
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/products/axon-synapse">Axon Synapse</a></li>
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/blog/protect-sensitive-data-in-an-event-sourced-application">AxonIQ Data Protection</a></li>
        </ul>
      </div>
    </div>

    <div class="footer-menu">
	    <h3>Sites</h3>
	    <div>
        <ul role="menu">
          <li><a class="ext" target="_blank" href="http://support.axoniq.io/">Customer Support Portal</a></li>
          <li><a class="ext" target="_blank" href="https://academy.axoniq.io/">AxonIQ Academy</a></li>
          <li><a class="ext" target="_blank" href="https://console.axoniq.io/">AxonIQ Console</a></li>
          <li><a class="ext" target="_blank" href="https://discuss.axoniq.io/">AxonIQ Discuss</a></li>
          <li><a class="ext" target="_blank" href="https://console.cloud.axoniq.io">AxonIQ Cloud</a></li>
        </ul>
      </div>
    </div>

    <div class="footer-menu">
	    <h3>Follow us</h3>
	    <div>
        <ul role="menu">
          <li><a class="ext" target="_blank" href="https://www.youtube.com/axoniq">YouTube</a></li>
          <li><a class="ext" target="_blank" href="https://www.linkedin.com/company/axoniq">LinkedIn</a></li>
          <li><a class="ext" target="_blank" href="https://github.com/AxonIQ">GitHub</a></li>
          <li><a class="ext" target="_blank" href="https://axoniq.bsky.social/">Bluesky</a></li>
          <li><a class="ext" target="_blank" href="https://www.instagram.com/axoniq/">Instagram</a></li>
          <li><a class="ext" target="_blank" href="https://www.facebook.com/AxonIQ.io">Facebook</a></li>
          <li><a class="ext" target="_blank" href="https://twitter.com/axon_iq">Twitter</a></li>
          <li><a class="ext" target="_blank" href="https://medium.com/axoniq">Medium</a></li>
        </ul>
      </div>
    </div>
  </div>
</footer>
<script id="site-script" src="../../../../../_/js/site.js" data-ui-root-path="../../../../../_"></script>
<script async src="../../../../../_/js/vendor/highlight.js"></script>
<script async src="../../../../../_/js/vendor/page-actions.js"></script>
<script async src="../../../../../_/js/vendor/tabs.js" data-sync-storage-key="preferred-tab" data-sync-storage-scope="session"></script>
<script src="../../../../../_/js/vendor/lunr.js"></script>
<script src="../../../../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../../../../.." data-snippet-length="100" data-stylesheet="../../../../../_/css/search.css"></script>
<script async src="../../../../../search-index.js"></script>
    </div>
  </body>
</html>
