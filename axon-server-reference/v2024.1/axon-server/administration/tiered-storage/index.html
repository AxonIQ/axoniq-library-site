<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Tiered Storage</title>
    <link rel="canonical" href="https://docs.axoniq.io/axon-server-reference/v2024.1/axon-server/administration/tiered-storage/">
    <link rel="prev" href="../multi-context/">
    <link rel="next" href="../event-transformation/">
    <meta name="generator" content="Antora 3.1.9">
    <link rel="stylesheet" href="../../../../../_/css/site.css">
    <link rel="stylesheet" href="../../../../../_/css/vendor/tabs.css">
    <link rel="icon" href="../../../../../_/img/favicon.ico" sizes="32x32">
    <link rel="icon" href="../../../../../_/img/icon.svg" type="image/svg+xml" media="(prefers-color-scheme: light)">
    <link rel="icon" href="../../../../../_/img/icon-light.svg" type="image/svg+xml" media="(prefers-color-scheme: dark)">
    <link rel="apple-touch-icon" href="../../../../../_/img/apple-touch-icon.png"><!-- 180×180 -->
    <link rel="manifest" href="../../../../../_/static/manifest.webmanifest">
        <!-- Google Tag Manager -->
        <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer','GTM-5QD58ZB');</script>
        <!-- End Google Tag Manager -->

    <script>var uiRootPath = '../../../../../_'</script>


  </head>
  <body class="article">

    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5QD58ZB"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://docs.axoniq.io"><img src="../../../../../_/img/logo-dark4x.png" class="header_logo" /></a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="../../../../../home/basics/">Basics</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="../../../../../home/guides/">Guides</a>
          <div class="navbar-dropdown card">
            <a class="navbar-item" href="../../../../../home/guides/axon-framework">Axon Framework</a>
            <a class="navbar-item" href="../../../../../home/guides/axon-server">Axon Server</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="../../../../../home/reference/">Reference</a>
          <div class="navbar-dropdown card">
                <a class="navbar-item" href="../../../../../axon-framework-reference/4.10/">Axon Framework</a>
                <a class="navbar-item" href="../../../../../axon-framework-extensions/">Axon Framework Extensions</a>
                <a class="navbar-item" href="../../../">Axon Server</a>
                <a class="navbar-item" href="../../../../../synapse-reference/v0.11/">Axon Synapse</a>
                <a class="navbar-item" href="../../../../../axoniq-console-reference/">AxonIQ Console</a>
          </div>
        </div>
      </div>
      <div class="navbar-end">
        <div class="navbar-item search hide-for-print">
          <div id="search-field" class="field">
            <input id="search-input" type="text" placeholder="Search AxonIQ Docs">
          </div>
        </div>
        <a class="navbar-item navbar-button" href="https://academy.axoniq.io" target="_blank">AxonIQ Academy</a>
        <a class="navbar-item navbar-button" href="https://discuss.axoniq.io" target="_blank">AxonIQ Discuss</a>
        <a class="navbar-item navbar-button" href="https://console.axoniq.io" target="_blank">AxonIQ Console</a>
      </div>
    </div>
  </nav>
</header>
<div class="toolbar card" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../../../home/" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../../../">Axon Server Reference</a></li>
    <li><a href="../">Administration</a></li>
    <li><a href="./">Tiered Storage</a></li>
  </ul>
</nav>
<div class="page-actions">
  <button class="actions-menu-toggle" title="Show actions related to this page">Actions</button>
  <div class="actions-menu toolbar_dropdown_menu card">

    <a class="action item" href="https://discuss.axoniq.io/search?q&#x3D;Tiered%20Storage" target="discuss_search">View Discussions</a>
    <a class="action item" href="https://discuss.axoniq.io/new-topic?category&#x3D;library&amp;title&#x3D;%22Tiered%20Storage%22%20Discussion&amp;body&#x3D;%3C!--%20Replace%20this%20comment%20with%20your%20comment%2Fsuggestion%2Fquestion%2F...%20--%3E%0A%0A%0A%3C!--%0AKeep%20the%20section%20below!%0ALinking%20back%20to%20the%20documentation%20URL%20not%20only%20helps%20people%20go%20to%20the%20page%0Abut%20also%20helps%20find%20relevant%20discussions%20from%20the%20documentation%20page%20via%20the%20%22View%20Discussion%22%20menu.%0A--%3E%0A%5Bdetails%3D%22Related%20library%20page%22%5D%0A%5BTiered%20Storage%5D(https%3A%2F%2Fdocs.axoniq.io%2Faxon-server-reference%2Fv2024.1%2Faxon-server%2Fadministration%2Ftiered-storage%2F)%0A%5B%2Fdetails%5D%0A" target="discuss_add">Start new discussion</a>
  </div>
</div>


<div class="page-versions">
  <button class="version-menu-toggle" title="Show other versions of page">v2024.1</button>
  <div class="version-menu toolbar_dropdown_menu card">
    <a class="version item" href="../../../../development/axon-server/administration/tiered-storage/">development</a>
    <a class="version item is-current" href="./">v2024.1</a>
    <a class="version item is-missing" href="../../../../0/">older releases</a>
  </div>
</div>
</div>
<div class="body">
<div class="nav-container" data-component="axon-server-reference" data-version="v2024.1">
  <aside class="nav card">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../../../">Axon Server</a></h3>

<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../../../">Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../installation/">Installation</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../installation/local-installation/">Local installation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../installation/docker-k8s/">Docker / K8s</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../">Administration</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../admin-configuration/">Configuration</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../admin-configuration/configuration/">System properties</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../admin-configuration/command-line-interface/">Command Line Interface</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../admin-configuration/rest-api/">REST API</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../admin-configuration/grpc-api/">gRPC API</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../monitoring/">Monitoring</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../monitoring/actuator-endpoints/">Actuator Endpoints</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../monitoring/axon-server-metrics/">Axon Server Metrics</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../monitoring/grpc-metrics/">gRPC Metrics</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../monitoring/heartbeat-monitoring/">Heartbeat Monitoring</a>
  </li>
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../monitoring/diagnostics/">Diagnostics</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../clustering/">Clusters</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../replication-groups/">Replication Groups</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../multi-context/">Multi-Context</a>
  </li>
  <li class="nav-item is-current-page" data-depth="2">
    <a class="nav-link" href="./">Tiered Storage</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../event-transformation/">Event Transformation</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../tagging/">Tagging</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../backup-and-messaging-only-nodes/">Backup and Messaging-Only Nodes</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../backups/">Backups</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../recovery/">Recovery</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../plugins/">Axon Server Plugins</a>
  </li>
  <li class="nav-item" data-depth="2">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../logging/">Logging</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="3">
    <a class="nav-link" href="../logging/logging-format/">Logging Format</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../error-codes/">Error Codes</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../security/">Security</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../security/ssl/">SSL</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../security/access-control-ee/">Access Control for Axon Server</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../security/access-control-clients/">Security for Axon Framework Client Applications</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../security/access-control-cli/">Access Control and the CLI</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../security/access-control-api/">Access Control on the REST and gRPC APIs</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../security/access-control-ldap/">Axon Server EE - LDAP Extension</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../security/access-control-oauth2/">Axon Server EE - OAuth Extension</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../performance/">Performance</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../performance/tuning-event-processing/">Event Segments</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../performance/flow-control/">Flow Control</a>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../migration/">Migration</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../migration/non-axon-server-to-axon-server/">Non-Axon Server to Axon Server</a>
  </li>
</ul>
  </li>
</ul>
  </li>
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <button class="nav-item-toggle"></button>
    <a class="nav-link" href="../../../release-notes/">Release Notes</a>
<ul class="nav-list">
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../rn-as-major-releases/">Major Releases</a>
  </li>
  <li class="nav-item" data-depth="2">
    <a class="nav-link" href="../../../rn-as-minor-releases/">Minor Releases</a>
  </li>
</ul>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
    <div class="content">
        <aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
          <article class="doc">
            <h1 class="page">Tiered Storage</h1>
            <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p><!-- vale Google.Passive = NO -->
<!-- vale AxonIQ.Headings = NO -->
<!-- vale Google.Will = NO -->
<!-- vale Google.Units = NO -->
<!-- vale Google.We = NO --></p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_introduction"><a class="anchor" href="#_introduction"></a>Introduction</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Tiered storage is a useful feature that allows you to store data across different levels of storage media based on access speed and cost.
This helps optimize performance and reduce overall storage costs by placing frequently accessed data on faster storage media, such as SSDs, and less frequently accessed data on slower but more cost-effective storage media, such as HDDs.</p>
</div>
<div class="paragraph">
<p>In a tiered storage system, data is usually classified according to its importance or frequency of use, and then automatically migrated between storage tiers based on these criteria.
This approach helps users to optimize their storage resources, reduce costs, and improve performance by ensuring that data is stored on the most appropriate type of storage media.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_axon_server_tiered_storage"><a class="anchor" href="#_axon_server_tiered_storage"></a>Axon Server tiered storage</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In Axon Server, there are two features that allow you to manage how data is stored: tiered storage and secondary nodes.
They work differently but can complement each other.</p>
</div>
<div class="paragraph">
<p>Let&#8217;s first explain these two different options and compare them to each other.</p>
</div>
<div class="paragraph">
<p><em>Tier configuration is shared with all nodes.
Each node maintains tiered storage independently storing on its own unique storage locations.</em></p>
</div>
<div class="paragraph">
<p>Tiered Storage is a feature that enables each node to maintain a local representation of its own tiered storage over its event store replica.
This feature allows you to configure multiple storage tiers based on each node’s role, such as primary, secondary, or backup nodes.
Nodes of the same role share a tiered configuration execute segment-moving operations locally, and independently.
For this reason, it is possible for segments to not be transferred at the same time on all nodes due to timing differences, but this is not a problem, and over time, the tiers will become synchronized.</p>
</div>
<div class="paragraph">
<p>With Tiered Storage, you can configure as many tiers as you need, and you can set retention intervals for each tier to determine after which interval the data should be moved from one tier to another.
There are several supported tier types available, including the default, custom storage, and black hole.</p>
</div>
<div class="paragraph">
<p><em>Tiered configuration within Context page - Axon Server Enterprise Edition</em></p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><strong>Lazy tiers</strong></p>
</div>
<div class="paragraph">
<p>As all available tier types are eagerly initialized they are not suitable for cold storage or archiving.</p>
</div>
<div class="paragraph">
<p>In the future, we will aim to support lazy initialization of tiers, which will allow support for cold storage and archiving.</p>
</div>
</blockquote>
</div>
<div class="sect2">
<h3 id="_default"><a class="anchor" href="#_default"></a>Default</h3>
<div class="paragraph">
<p>The Default tier type is a convenient option that allows you to quickly set up your event store without having to specify a custom location on disk.
If you do not have any specific requirements for the physical storage location of your event data or you are migrating from an older version of Axon Server where the event store location was set via environment variables, then using the Default tier type is a suitable initial tier to use.</p>
</div>
</div>
<div class="sect2">
<h3 id="_custom_storage"><a class="anchor" href="#_custom_storage"></a>Custom storage</h3>
<div class="paragraph">
<p>The Custom storage tier type enables you to set a custom location for a specific tier in Axon Server.
You can choose storage via a dropdown menu.
To add storage locations to the dropdown menu, you need to configure Axon Server with additional properties.
This can be done either through a property file or environment variables, using the following syntax:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>axoniq.axonserver.event.storages.{storage name}={path to storage}
axoniq.axonserver.snapshot.storages.{storage name}={path to storage}</pre>
</div>
</div>
<div class="paragraph">
<p>For example, to set the <code>slow_disk</code> storage location to <code>/hhd2/eventstore</code>, you can add the following line to your configuration:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>axoniq.axonserver.event.storages.slow_disk=/hhd2/eventstore
axoniq.axonserver.snapshot.storages.slow_disk=/hhd2/eventstore</pre>
</div>
</div>
<div class="paragraph">
<p>You can add as many storage locations as needed, such as different hard drives or even mounted network drives, but it is important to configure the given storage on all nodes in the Axon Server cluster.</p>
</div>
<div class="paragraph">
<p>Configuration is shared for all nodes of the same role.
That&#8217;s why all nodes should provide paths where they want to store data for certain named locations (storages).
After configuration is set, it&#8217;s replicated to all nodes, after that nodes maintain and run segment-moving operations on their own, independently.</p>
</div>
<div class="paragraph">
<p>Storage locations are referenced by name (for instance slow_disk), and the provided path is resolved at runtime on each node.
It&#8217;s important that path on each node points to a <strong>unique physical location</strong>!</p>
</div>
</div>
<div class="sect2">
<h3 id="_black_hole_tier"><a class="anchor" href="#_black_hole_tier"></a>Black Hole Tier</h3>
<div class="paragraph">
<p>The Black Hole is tier type in Axon Server that consumes your events, and you will never see them again.</p>
</div>
<div class="paragraph">
<p>Using the Black Hole tier will mark your context as <strong>ephemeral</strong>, which means that data is permanently removed after a specified retention interval. <strong>Once the data is removed, it cannot be recovered</strong>, so it&#8217;s essential to use this feature with caution and only if you&#8217;re certain that you no longer need the data.</p>
</div>
<div class="paragraph">
<p><em>Context using a black hole tier will be marked as ephemeral and the flow of data will be visualized (only for primary nodes)</em></p>
</div>
<div class="sect3">
<h4 id="_configuring_ephemeral_context"><a class="anchor" href="#_configuring_ephemeral_context"></a>Configuring ephemeral context</h4>
<div class="paragraph">
<p>To configure context as ephemeral, you first need to choose storage where you want to store events or snapshots initially.
You can do so by choosing default tier type or selecting the storage location from the dropdown menu.
After that, you need to add Black Hole tier type and set retention interval for this tier.</p>
</div>
<div class="paragraph">
<p><em>Example on how to configure ephemeral context</em></p>
</div>
</div>
<div class="sect3">
<h4 id="_use_cases_for_ephemeral_context"><a class="anchor" href="#_use_cases_for_ephemeral_context"></a>Use cases for ephemeral context</h4>
<div class="paragraph">
<p>Ephemeral context is particularly useful in scenarios such as event streaming or integration contexts, where events are published to multiple observers in real-time, and after some time, the events are no longer of interest.
Another use case is for contexts that produce many events, like notifications, which are no longer useful for the business after a certain period.</p>
</div>
<div class="paragraph">
<p><strong>However:</strong>
The Black Hole tier should not be used if you have event-sourced aggregates.
Ephemeral context is not suitable for fine-grain event removal as it removes segments per whole, that contain many different events of different types of aggregates, making it difficult to remove specific events.</p>
</div>
</div>
<div class="sect3">
<h4 id="_conditional_removal"><a class="anchor" href="#_conditional_removal"></a>Conditional Removal</h4>
<div class="paragraph">
<p>In the case you need to use event-sourced aggregates and want to delete events after a period of time and ensure that you always have a valid state, Axon Server provides an experimental feature called conditional removal, which allows you to remove segments conditionally.
To use this feature, you first need to enable snapshots for your aggregates.
Setting the conditional property (available by editing context properties in the UI)</p>
</div>
<div class="listingblock">
<div class="content">
<pre>experimental.black-hole.conditional-remove = 1</pre>
</div>
</div>
<div class="paragraph">
<p>instructs the black hole tier to remove an event segment only if each event in the segment was previously included in a snapshot. It also removes a snapshot segment only if there is a newer snapshot for each snapshot in the segment.
However, note that this feature is experimental, and it comes with some caveats. For example, there are many events of different aggregates in one segment. If only one aggregate from this segment does not have a snapshot, it may prevent the segment from being deleted indefinitely. This feature is best used if you have a small number of aggregate instances, ideally one aggregate, which is a common case for integration purposes contexts.</p>
</div>
<div class="paragraph">
<p>Another safer usage of condition removal and black hole tier, is to enable it only for snapshot storage. With that after some time older non-used snapshots will be removed, but latest snapshot will be always available for each aggregate.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../../../_images/tiered-conditional.png" alt="tiered conditional"></span></p>
</div>
<div class="paragraph">
<p><em>Configuring conditional remove in context properties</em></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_retention_intervals"><a class="anchor" href="#_retention_intervals"></a>Retention Intervals</h3>
<div class="paragraph">
<p>Axon Server supports both time-based and size-based retention intervals for tiered storage.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../../../_images/tiered-retentiontime.png" alt="tiered retentiontime"></span>]</p>
</div>
<div class="paragraph">
<p><em>Retention interval options for tiered storage</em></p>
</div>
<div class="sect3">
<h4 id="_time_based_retention"><a class="anchor" href="#_time_based_retention"></a>Time-Based Retention</h4>
<div class="paragraph">
<p>Time-based retention specifies how long a segment should be in one tier before being moved to another tier. After the segment is closed for writing and the retention time is due, the segment becomes eligible to move to the next tier.</p>
</div>
</div>
<div class="sect3">
<h4 id="_size_based_retention"><a class="anchor" href="#_size_based_retention"></a>Size-Based Retention</h4>
<div class="paragraph">
<p>Size-based retention monitors the size of the whole tier. After the size threshold is breached, the oldest segments in the tier that are outside of the size boundary are moved to the next tier, maintaining the specified size of the tier.
<em>Specified size is calculated only using event segment file sizes and does not include index file sizes. So, make sure to leave enough space on the disk for indexes and for the currently open segment.</em>
Size-based retention is useful when you want to keep the newest events on fast storage limited by size, while moving everything else to a slower disk.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_controlling_the_flow_of_data"><a class="anchor" href="#_controlling_the_flow_of_data"></a>Controlling the flow of data</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Axon Server allows you to control the flow of data between tiers. You can limit the rate of segment moves to prevent large IO spikes. You can also pause the segment moving operation to prevent data from being moved between tiers.</p>
</div>
<div class="sect2">
<h3 id="_setting_io_rate_limits"><a class="anchor" href="#_setting_io_rate_limits"></a>Setting IO Rate Limits</h3>
<div class="paragraph">
<p>You can limit the max number of segments that can be moved per minute by setting the following properties:</p>
</div>
<div class="paragraph">
<p><code>event.segment-move-rate=5</code></p>
</div>
<div class="paragraph">
<p>By default, the max number of segments that can be moved per minute is set to 5. This setting can be changed within the context properties in Axon Server UI.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../../../_images/tiered-move-rate.png" alt="tiered move rate"></span></p>
</div>
<div class="paragraph">
<p><em>Limiting IO rate in context properties for a given context</em></p>
</div>
<div class="sect3">
<h4 id="_pausing_moving_operation"><a class="anchor" href="#_pausing_moving_operation"></a>Pausing moving operation</h4>
<div class="paragraph">
<p>In some cases, you may want to pause the segment moving operation. This can be useful in emergency situations or during maintenance/backup operations.</p>
</div>
<div class="paragraph">
<p>To pause the segment moving operation, set the segment move rate to zero: <code>event.segment-move-rate=0</code></p>
</div>
<div class="paragraph">
<p>To resume the segment moving operation, simply set the segment move rate to a non-zero value.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_metrics"><a class="anchor" href="#_metrics"></a>Metrics</h3>
<div class="paragraph">
<p>To track the flow of data from one tier to another, we provide a few useful metrics:</p>
</div>
<div class="listingblock">
<div class="content">
<pre>file_segment_moved_initiated_total{axonserver="axonserver-enterprise-1",context="mycontext",fromTierLevel="0",type="EVENT",} 11.0
file_segment_moved_completed_total{axonserver="axonserver-enterprise-1",context="mycontext",fromTierLevel="0",type="EVENT",}10.0
file_segment_moved_duration_seconds_sum{axonserver="axonserver-enterprise-1",context="mycontext",fromTierLevel="1",type="SNAPSHOT",} 0.53</pre>
</div>
</div>
<div class="paragraph">
<p><em>Example of metrics for tracking the flow of data in tiered storage</em></p>
</div>
<div class="paragraph">
<p><code>file_segment_moved_initiated</code> - counts how many segments, per context, per tier level, were initiated to be moved to next tier</p>
</div>
<div class="paragraph">
<p><code>file_segment_moved_completed</code> - counts how many segments, per context, per tier level, was successfully moved to next tier</p>
</div>
<div class="paragraph">
<p><code>file_segment_moved_duration</code> - measures how long did it take to move segments to next tier</p>
</div>
<div class="paragraph">
<p><code>file.segment.per.tier</code> - current number of segments per each tier</p>
</div>
<div class="quoteblock">
<blockquote>
<div class="paragraph">
<p><strong>Limitations to changing and adding to tier configuration</strong></p>
</div>
<div class="paragraph">
<p>While it is possible to change the conditions for moving data from one tier to the next, it is not possible to change the order of tiers. Currently, new tiers can only be added at the end and removal of existing tiers is not possible.
In the future, it is expected that it will be possible to alter the configuration completely.</p>
</div>
</blockquote>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_secondary_nodes"><a class="anchor" href="#_secondary_nodes"></a>Secondary Nodes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Secondary Nodes are a feature in Axon Server that allows you to reduce the number of copies of data that is stored, by keeping only the most recent event store on your primary nodes and keeping the full event store on the secondary nodes.</p>
</div>
<div class="paragraph">
<p>The primary nodes can have faster (more expensive) disks, while the secondary nodes can have slower but more cost-effective disks. This can help reduce storage costs without significantly impacting performance.</p>
</div>
<div class="paragraph">
<p>When Axon Server processes a transaction to append events, the leader replicates this transaction to all of the nodes in the cluster. This includes the primary nodes, as well as the secondary and backup nodes. While the leader will be satisfied when the majority of the primary nodes have acknowledged the receipt of the transaction, it will also keep track of the progress of the other nodes.
Each node holds an exact copy of the data initially. So with a cluster of three nodes, each element of data (typically events) will be stored a total of three times. The main reason for this is to ensure that the failure of a single node will not result in the data becoming unavailable or lost. This is particularly relevant for recent information, which is accessed frequently by various event processors, and when using event sourcing.</p>
</div>
<div class="paragraph">
<p>However, the added value of these extra copies degrades over time, as these entries are accessed less frequently.
Secondary nodes contain a full copy of all the data that the primary nodes also process. While replicating that data, they inform the primary nodes of their progress. Once the data has aged to the configured retention time, it becomes eligible for <em>removal from the last tier in primary nodes</em>, but only if all available secondary nodes have a safe copy of that data.</p>
</div>
<div class="paragraph">
<p>When primary nodes need to access old data, they will retrieve it from the secondary nodes.
By using secondary nodes, you can leverage concurrent access performance of faster disks while minimizing cost by moving events to slower disks once access requirements are reduced. Additionally, a secondary node could be used to keep access for incidental operational use of older events. This secondary node could use several storage tiers to be able to cope with the large amount of data to store. If needed, after a certain retention period, data can be removed altogether.</p>
</div>
<div class="sect2">
<h3 id="_tiered_storage_vs_secondary_nodes"><a class="anchor" href="#_tiered_storage_vs_secondary_nodes"></a>Tiered storage vs Secondary Nodes</h3>
<div class="sect3">
<h4 id="_how_are_secondary_nodes_different"><a class="anchor" href="#_how_are_secondary_nodes_different"></a>How are Secondary Nodes Different?</h4>
<div class="paragraph">
<p>The main difference between Secondary Nodes and Tiered Storage is the cardinality of data.</p>
</div>
<div class="paragraph">
<p>Secondary Nodes allow for a reduction in the number of copies of each data element that is stored; whereas in Tiered Storage, the number of copies always equals to the number of nodes in the cluster.
Another significant difference is that Secondary Nodes copy all the data, including the most recent events, even though they still exist on the primary node. Once the data has aged to the configured retention time, it becomes eligible for removal from the primary nodes, but only if all available secondary nodes have a safe copy of that data. In contrast, Tiered Storage involves an actual data copy operation at the moment data transitions from one tier to the next.</p>
</div>
</div>
<div class="sect3">
<h4 id="_how_can_they_complement_each_other"><a class="anchor" href="#_how_can_they_complement_each_other"></a>How Can They Complement Each Other?</h4>
<div class="paragraph">
<p>The differences between Secondary Nodes and Tiered Storage allow for interesting data management techniques. High-performance systems require the ability to concurrently ingest data and read events for event sourcing. Additionally, events that are "cooling down" may still occasionally be needed for operational purposes, making the availability of this data essential.
In such scenarios, one could use SSD and HDD on the primary nodes to leverage the concurrent access performance of SSD and minimize costs by moving events to a local HDD once access requirements are reduced. Additionally, a Secondary node could be used to keep access for incidental operational use of older events. This Secondary node could use several storage tiers to cope with large amounts of data to store.
By combining Secondary Nodes and Tiered Storage, users can effectively manage their data and strike a balance between performance and cost.</p>
</div>
<div class="paragraph">
<p><span class="image"><img src="../../../_images/tiered-secondary.png" alt="tiered secondary"></span></p>
</div>
<div class="paragraph">
<p><em>Example of a tiered setup that keeps most up-to-date events in primary nodes. After a given period of time data is removed from primary nodes and reduced to one replica in one secondary node which deletes data after a long period of time.</em></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_configuring_and_using_secondary_nodes"><a class="anchor" href="#_configuring_and_using_secondary_nodes"></a>Configuring and Using Secondary Nodes</h3>
<div class="paragraph">
<p>To use secondary nodes, the replication group for the context must have nodes with <code>SECONDARY</code> role. You may consider to have at least two nodes with <code>SECONDARY</code> role to prevent a single point of failure.
To configure a secondary node, you need to add it to the Axon Server cluster as a new node with the <code>SECONDARY</code> role. You can do this by installing Axon Server on a new machine, configuring it to use the same Axon Server instance as the primary node, and starting it up with the <code>SECONDARY</code> role.
Once the secondary node is up and running, it will automatically start replicating data from the primary node. By default, the secondary node will store a full copy of all data that the primary nodes also process. While replicating that data, the secondary node informs the primary nodes of its progress.
To control the retention time of events on the primary nodes, you can set the retention time properties in the context properties.</p>
</div>
<div class="listingblock">
<div class="content">
<pre>event.retention-time=10d
snapshot.retention-time=10d</pre>
</div>
</div>
<div class="paragraph">
<p><em>Entering number without unit defaults to milliseconds, but you can specify a value with a unit, for instance 1d or 5h.</em></p>
</div>
<div class="paragraph">
<p>This allows you to specify how long events will be kept on the primary nodes before they are eligible for removal. If you have primary nodes with multiple tiers, data will be removed only from last tier.</p>
</div>
<div class="paragraph">
<p>Once events are removed from the primary nodes, they will still be available on the secondary nodes.
To access old data on the primary nodes, you can retrieve it from the secondary nodes. This ensures that your data remains available even after it has been removed from the primary nodes, as long as it is still available on the secondary nodes.
Overall, secondary nodes provide a way to reduce the number of copies of each data element that is stored, while still maintaining the availability of that data.</p>
</div>
</div>
</div>
</div>
        <nav class="pagination">
  <span class="prev"><a href="../multi-context/">Multi-Context</a></span>
  <span class="next"><a href="../event-transformation/">Event Transformation</a></span>
</nav>
    </article>
  </div>
</main>
</div>
<footer class="footer">
  <div class="primary-footer">
    <div class="footer-logo ">
      <a href="https://axoniq.io/">
        <img src="https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=90&amp;height=20&amp;name=Logo%20AxonIQ%20(2).png" alt="Logo AxonIQ" loading="lazy" srcset="https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=45&amp;height=10&amp;name=Logo%20AxonIQ%20(2).png 45w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=90&amp;height=20&amp;name=Logo%20AxonIQ%20(2).png 90w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=135&amp;height=30&amp;name=Logo%20AxonIQ%20(2).png 135w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=180&amp;height=40&amp;name=Logo%20AxonIQ%20(2).png 180w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=225&amp;height=50&amp;name=Logo%20AxonIQ%20(2).png 225w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=270&amp;height=60&amp;name=Logo%20AxonIQ%20(2).png 270w" sizes="(max-width: 90px) 100vw, 90px" width="90" height="20">
      </a>
    </div>

    <div class="footer-menu">
	    <h3>Products</h3>
	    <div>
        <ul role="menu">
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/products/axon-framework">Axon Framework</a></li>
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/products/axon-server">Axon Server</a></li>
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/products/axoniq-cloud">AxonIQ Cloud</a></li>
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/products/axoniq-console">AxonIQ Console</a></li>
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/products/axon-synapse">Axon Synapse</a></li>
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/blog/protect-sensitive-data-in-an-event-sourced-application">AxonIQ Data Protection</a></li>
        </ul>
      </div>
    </div>

    <div class="footer-menu">
	    <h3>Sites</h3>
	    <div>
        <ul role="menu">
          <li><a class="ext" target="_blank" href="http://support.axoniq.io/">Customer Support Portal</a></li>
          <li><a class="ext" target="_blank" href="https://academy.axoniq.io/">AxonIQ Academy</a></li>
          <li><a class="ext" target="_blank" href="https://console.axoniq.io/">AxonIQ Console</a></li>
          <li><a class="ext" target="_blank" href="https://discuss.axoniq.io/">AxonIQ Discuss</a></li>
          <li><a class="ext" target="_blank" href="https://console.cloud.axoniq.io">AxonIQ Cloud</a></li>
        </ul>
      </div>
    </div>

    <div class="footer-menu">
	    <h3>Follow us</h3>
	    <div>
        <ul role="menu">
          <li><a class="ext" target="_blank" href="https://www.youtube.com/axoniq">YouTube</a></li>
          <li><a class="ext" target="_blank" href="https://www.linkedin.com/company/axoniq">LinkedIn</a></li>
          <li><a class="ext" target="_blank" href="https://www.facebook.com/AxonIQ.io">Facebook</a></li>
          <li><a class="ext" target="_blank" href="https://twitter.com/axon_iq">Twitter</a></li>
          <li><a class="ext" target="_blank" href="https://github.com/AxonIQ">GitHub</a></li>
          <li><a class="ext" target="_blank" href="https://medium.com/axoniq">Medium</a></li>
        </ul>
      </div>
    </div>
  </div>
</footer>
<script id="site-script" src="../../../../../_/js/site.js" data-ui-root-path="../../../../../_"></script>
<script async src="../../../../../_/js/vendor/highlight.js"></script>
<script async src="../../../../../_/js/vendor/page-actions.js"></script>
<script async src="../../../../../_/js/vendor/tabs.js" data-sync-storage-key="preferred-tab" data-sync-storage-scope="session"></script>
<script src="../../../../../_/js/vendor/lunr.js"></script>
<script src="../../../../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../../../../.." data-snippet-length="100" data-stylesheet="../../../../../_/css/search.css"></script>
<script async src="../../../../../search-index.js"></script>
  </body>
</html>
