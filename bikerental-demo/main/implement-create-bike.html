<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Implement Create New Bike Feature</title>
    <link rel="canonical" href="https://library.axoniq.io/bikerental-demo/main/implement-create-bike.html">
    <link rel="prev" href="bootstraping-axonframework.html">
    <link rel="next" href="run-app-with-docker-compose.html">
    <meta name="generator" content="Antora 3.1.1">
    <link rel="stylesheet" href="../../_/css/site.css">
    <link rel="stylesheet" href="../../_/css/vendor/tabs.css">
    <link rel="icon" href="../../_/img/favicon.ico" sizes="32x32">
    <link rel="icon" href="../../_/img/icon.svg" type="image/svg+xml" media="(prefers-color-scheme: light)">
    <link rel="icon" href="../../_/img/icon-light.svg" type="image/svg+xml" media="(prefers-color-scheme: dark)">
    <link rel="apple-touch-icon" href="../../_/img/apple-touch-icon.png"><!-- 180Ã—180 -->
    <link rel="manifest" href="../../_/static/manifest.webmanifest">
        <!-- Google Tag Manager -->
        <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer','GTM-5QD58ZB');</script>
        <!-- End Google Tag Manager -->

    <script>var uiRootPath = '../../_'</script>


  </head>
  <body class="article">

    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5QD58ZB"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://library.axoniq.io"><img src="../../_/img/logo-dark.png" class="header_logo" /></a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="../../home/basics.html">Basics</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link">Guides</a>
          <div class="navbar-dropdown card">
              <a class="navbar-item" href="../../home/guides/axon-framework.html">Axon Framework</a>
              <a class="navbar-item" href="../../home/guides/axon-server.html">Axon Server</a>
              <a class="navbar-item" href="../../home/guides/migration.html">Migration</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link">Reference</a>
          <div class="navbar-dropdown card">
                <a class="navbar-item" href="../../axon_framework_ref/introduction.html">Axon Framework</a>
                <a class="navbar-item" href="../../axon_server_ref/v2024.1/index.html">Axon Server</a>
                <a class="navbar-item" href="../../synapse_ref/latest/index.html">Axon Synapse</a>
                <a class="navbar-item" href="../../axoniq_console_ref/main/index.html">AxonIQ Console</a>
          </div>
        </div>
      </div>
      <div class="navbar-end">
        <div class="navbar-item search hide-for-print">
          <div id="search-field" class="field">
            <input id="search-input" type="text" placeholder="Search AxonIQ Docs">
          </div>
        </div>
        <a class="navbar-item navbar-button" href="https://academy.axoniq.io" target="_blank">AxonIQ Academy</a>
        <a class="navbar-item navbar-button" href="https://discuss.axoniq.io" target="_blank">AxonIQ Discuss</a>
      </div>
    </div>
  </nav>
</header>
<div class="toolbar card" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../home/index.html" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="index.html">Building An Axon Framework Application From Scratch </a></li>
    <li><a href="implement-create-bike.html">Create New Bike Feature</a></li>
  </ul>
</nav>
<div class="page-actions">
  <button class="actions-menu-toggle" title="Show actions related to this page">Actions</button>
  <div class="actions-menu toolbar_dropdown_menu card">
      <a class="action item" href="https://github.com/AxonIQ/bike-rental-quick-start/edit/main/docs/tutorial/modules/ROOT/pages/implement-create-bike.adoc">Edit this Page</a>
    
    <a class="action item" href="https://discuss.axoniq.io/search?q&#x3D;https%3A%2F%2Flibrary.axoniq.io%2Fbikerental-demo%2Fmain%2Fimplement-create-bike.html%20%23library" target="discuss_search">View Discussions</a>
    <a class="action item" href="https://discuss.axoniq.io/new-topic?category&#x3D;library&amp;title&#x3D;%22Implement%20Create%20New%20Bike%20Feature%22%20library%20page%20...&amp;body&#x3D;%3C!--%20Replace%20this%20comment%20with%20your%20comment%2Fsuggestion%2Fquestion%2F...%20--%3E%0A%0A%0A%3C!--%0AKeep%20the%20section%20below!%0ALinking%20back%20to%20the%20documentation%20URL%20not%20only%20helps%20people%20go%20to%20the%20page%0Abut%20also%20helps%20find%20relevant%20discussions%20from%20the%20documentation%20page%20via%20the%20%22View%20Discussion%22%20menu.%0A--%3E%0A%5Bdetails%3D%22Related%20library%20page%22%5D%0A%5BImplement%20Create%20New%20Bike%20Feature%5D(https%3A%2F%2Flibrary.axoniq.io%2Fbikerental-demo%2Fmain%2Fimplement-create-bike.html)%0A%5B%2Fdetails%5D%0A" target="discuss_add">Start new discussion</a>
  </div>
</div>


</div>
<div class="body">
<div class="nav-container" data-component="bikerental-demo" data-version="main">
  <aside class="nav card">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="index.html">Building An Axon Framework Application From Scratch</a></h3>

<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="index.html">Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="create-axon-framework-project.html">Create New Project</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="bootstraping-axonframework.html">Bootstrap AxonFramework</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="implement-create-bike.html">Create New Bike Feature</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="run-app-with-docker-compose.html">Running Your Application Locally With Docker Compose</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="invoking-create-bike-endpoint.html">Invoking the Register Bike Endpoint</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="unit-testing-commands.html">Add Unit Tests For Command Handlers</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="create-bike-status-projection.html">Creating the Query Model</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
    <div class="content">
        <aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
          <article class="doc">
            <h1 class="page">Implement Create New Bike Feature</h1>
            <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In this step of the tutorial, we will implement the support for our first feature: create (or register) a new bike in our system.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_design_considerations"><a class="anchor" href="#_design_considerations"></a>Design considerations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Before jumping over the keyboard to start writing code, let&#8217;s first introduce the big picture of the design of our system so that we are prepared to split and scale it out later.</p>
</div>
<div class="paragraph">
<p>Although we will work on our rental module, we want to build it as a <strong>modular monolith</strong>. To achieve that goal, we need to keep a few design goals in mind:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Logical modules based on component&#8217;s responsibility</strong>: We will group them according to their responsibility in our system. We are going to identify the following logical modules:</p>
<div class="ulist">
<ul>
<li>
<p><strong>UI/API</strong>: Components that receive requests directly from the user or external applications. We will implement our application&#8217;s interface to users or other applications using a REST API.</p>
</li>
<li>
<p><strong>Command Model</strong>: These are the components that receive all the requests that, as a result of processing them, imply a change in the state of our system. Requests like "Register a new bike", "Rent a bike" or "Return a bike" are a few examples of Commands</p>
</li>
<li>
<p><strong>Query Model</strong> (also known as <strong>Projections</strong>): Composed of components that will handle the requests for information (or queries). In order to reply as fast as possible, these components will keep the data from our system structured as close as possible to how the user expects the information in the response. For example, imagine that our application needs to support requests to get a complete list of all the bikes and their availability status. In that case, a component (a Projection) will keep the list of all the bikes with their state up to date and ready to be sent back when requested.</p>
</li>
</ul>
</div>
</li>
<li>
<p>Components <strong>loosely coupled</strong>: we will use <strong>messages</strong> (like Commands, Events or Queries) to communicate the different logical modules.</p>
</li>
<li>
<p><strong>Location transparency</strong>: we want to rely on abstractions that allow our components not to have to deal with the specific details of how to reach other components to deliver a message. For example, the UI (whose responsibility is to receive HTTP requests and forward the right message to the appropriate handler, either in the Command Model or in the Query Model) should not have to know which is the specific component that will handle and process the request.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>These design goals may seem complicated to achieve. Still, if we rely on the correct type of messages and thanks to AxonIQ tools, you will see it is much easier to achieve.</p>
</div>
<div class="paragraph">
<p>In summary, our rental application will have the following high-level architecture diagram for handling requests to register a new bike in our system (and, generally, to handle all types of requests.)</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/logic-diagram.png" alt="Design diagram with the logical modules for rental application: An UI/API module contains the HTTP Controller that receives the HTTP POST request to register a new bike. The HTTP Controller sends a RegisterBikeCommand to the Command Model module" width="including a CommandHandler to maintain the Bike aggregates. After processing a RegisterBikeCommand" height="the CommandHandler sends a BikeRegisteredEvent to the Query Model module">
</div>
</div>
<div class="paragraph">
<p>These could be separate modules, but for now, we are going to consider these just as logical components within the same project: We will define different packages in the same project (in our case, the <code>rental</code> module)</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_implementing_the_process_to_register_a_new_bike_in_the_system"><a class="anchor" href="#_implementing_the_process_to_register_a_new_bike_in_the_system"></a>Implementing the process to register a new bike in the system</h2>
<div class="sectionbody">
<div class="paragraph">
<p>When the application receives a request to create a bike, that implies that the state of our application will change because, after successfully processing it, we will have a new bike in our system (so, the list of available bikes -our application&#8217;s state- will have changed). So, we will model our request as a <code>Command</code>; in our case, we will call it <code>RegisterBikeCommand</code>.</p>
</div>
<div class="paragraph">
<p>So, the <code>RegisterBikeCommand</code> will be routed to the <code>Command Model</code>, where we will implement a handler method to process it. That method must create the new <code>Bike</code> in our system and notify that "a new bike has been registered" to other components interested in this change.</p>
</div>
<div class="paragraph">
<p>The type of this message, a <strong>notification that something has happened</strong>, corresponds to what we define as an <code>Event</code>. Thus, the command handler will trigger a <code>BikeRegisteredEvent</code>.</p>
</div>
<div class="paragraph">
<p>One last but important thing to remember in our design is the order in which we will implement the code that creates the new bike in our system and the code that fires the event that notifies the change.</p>
</div>
<div class="paragraph">
<p><a id="design-command-handler"></a>In our application, we want to follow the design goals of Event Sourcing, and that implies that the changes in our command model will be done as a result of processing the same <code>BikeRegisteredEvent</code> just as any other component in our application will do. That means that, among other good reasons, the list of Events will become our system&#8217;s <strong>single source of truth</strong>.</p>
</div>
<div class="paragraph">
<p>The steps for implementing the command handling for the <code>RegisterBikeCommand</code> will be:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Receive and validate the command in the <code>@CommandHandler</code>.</p>
</li>
<li>
<p>If valid, send a <code>BikeRegisteredEvent</code> from the <code>@CommandHandler</code>.</p>
</li>
<li>
<p>Register and receive the <code>BikeRegisteredEvent</code> using an <code>@EventSourcingHandler</code> in our Command model.</p>
</li>
<li>
<p>Create the bike and assign the details for the bike created in the <code>@EventSourcingHandler</code> of our command model.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>In the following sections, let&#8217;s see how to implement each of these steps in detail.</p>
</div>
<div class="sect2">
<h3 id="_defining_the_command"><a class="anchor" href="#_defining_the_command"></a>Defining the command</h3>
<div class="paragraph">
<p>As we aim to keep the modules loosely coupled so that we can easily split the modular monolith into different projects if we reach in the future the point in which the application has grown too complex that it needs to scale to multiple simpler modules, it&#8217;s a good idea to keep the definition of the messages that we are going to use to communicate those logical modules in the <code>core-api</code> module we created earlier.</p>
</div>
<div class="paragraph">
<p>So, we will create a new <code>CreateBikeCommand</code> in the <code>core-api</code> module. Create a new package <code>io.axoniq.demo.bikerental.coreapi.rental</code> and, inside that package, create the following <code>RegisterBikeCommand</code>:</p>
</div>
<div class="listingblock">
<div class="title">core-api/src/main/java/io/axoniq/demo/bikerental/coreapi/retnal/RegisterBikeCommand.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package io.axoniq.demo.bikerental.coreapi.rental;

import org.axonframework.modelling.command.TargetAggregateIdentifier;

public record RegisterBikeCommand(@TargetAggregateIdentifier String bikeId, <i class="conum" data-value="1"></i><b>(1)</b>
                                  String bikeType,
                                  String location) {
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>@TargetAggregateIdentifier</code> indicates to AxonFramework to use the <code>bikeId</code> attribute as the unique identifier to load the Bike with id <code>{bikeId}</code> before handling the command.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We have defined the command as a Java record that contains the minimum amount of information necessary to process the command.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
Using a Java record structure also brings the benefit of immutability to our command. You can also use a data class in Kotlin to define the commands.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_implementing_the_command_model"><a class="anchor" href="#_implementing_the_command_model"></a>Implementing the command model</h2>
<div class="sectionbody">
<div class="paragraph">
<p>The next step to process the <code>RegisterBikeCommand</code> is to define the component responsible for processing that request. In our example, we are following the DDD design model, which relies on the concept of the <strong>Aggregate</strong> to model the state of our system. And, with the Axon Framework, we will use the Aggregate to "designate" (via annotations) the methods the framework should invoke upon receiving a specific message.</p>
</div>
<div class="sect2">
<h3 id="_creating_the_aggregate_class_the_bike"><a class="anchor" href="#_creating_the_aggregate_class_the_bike"></a>Creating the aggregate class (the Bike)</h3>
<div class="paragraph">
<p>Thus, we will start by creating the Aggregate (or Entity) that will represent the state of our application related to the feature of processing requests to register, rent or return a bike.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
In more complex systems, there are some techniques to design your command and query models based on a previous analysis of the interactions and features that the system will support. <strong>Event Storming</strong> and <strong>Event Modeling</strong> are valuable techniques to analyze your system and extract the different Commands, Events, Queries and Aggregates.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We can start by creating a <code>Bike</code> class to model our Aggregate.</p>
</div>
<div class="listingblock">
<div class="title">rental/src/main/java/io/axoniq/demo/bikerental/rental/command/Bike.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Aggregate <i class="conum" data-value="1"></i><b>(1)</b>
public class Bike {

    @AggregateIdentifier <i class="conum" data-value="2"></i><b>(2)</b>
    private String bikeId;

    private boolean isAvailable;
    private String reservedBy;
    private boolean reservationConfirmed;

    public Bike() { <i class="conum" data-value="3"></i><b>(3)</b>
    }


}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We will mark the class with <code>org.axonframework.spring.stereotype.Aggregate</code> annotation. This way Axon Framework will handle the lifecycle of the instances of our Bikes based on the Commands and Events received by our command model component.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We will design the attribute that will hold the unique identifier of our bike instance using the <code>org.axonframework.modeling.command.AggregateIdentifier</code> annotation.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>We also need a default Java constructor that Axon Framework needs to create the new instance of a bike before populating its fields with the state and invoking the method to handle the Command or Event received.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_defining_the_command_handler_method"><a class="anchor" href="#_defining_the_command_handler_method"></a>Defining the command handler method.</h3>
<div class="paragraph">
<p>To process a <code>RegisterBikeCommand</code> in our application, we must define a method in our <code>Bike</code> class that receives the command as an argument. To indicate that the method should be invoked upon receiving a command, we will add the <code>@CommandHandler</code> annotation provided by AxonFramework.</p>
</div>
<div class="paragraph">
<p>In this case, as the <code>RegisterBikeCommand</code> is the request to create a new instance of a Bike, we must define the command handler using a constructor.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Aggregate
public class Bike {


    @CommandHandler <i class="conum" data-value="1"></i><b>(1)</b>
    public Bike(RegisterBikeCommand command) { <i class="conum" data-value="2"></i><b>(2)</b>
        var seconds = Instant.now().getEpochSecond();
        if (seconds % 5 ==0) {
            throw new IllegalStateException("Can't accept new bikes right now");
        }

        apply(new BikeRegisteredEvent(command.bikeId(), command.bikeType(), command.location())); <i class="conum" data-value="3"></i><b>(3)</b>
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>org.axonframework.commandhandling.CommandHandler</code> annotation instructs Axon Framework to call this method upon receiving commands.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The type of the argument indicates to Axon Framework which type of commands should be linked to the invocation of this method.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The static method <code>AggregateLifecycle.apply()</code> is invoked to send the Event that notifies the change in the state of our system. In this case, to notify that the <strong>bike has been registered</strong>.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>In the command handler, we have not changed the internal properties of the <code>Bike</code> instance.</p>
</div>
<div class="paragraph">
<p>As a general rule and as we discussed in the <a href="#design-command-handler">Command Handler design considerations</a>, we will simply:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Validate, if necessary, that the command we received is valid and can be processed.</p>
</li>
<li>
<p>Send a message notifying that, as the command is valid, the bike was registered.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>We will leave the task of setting the properties of our newly registered <code>Bike</code> instance for a later step, when the command model reacts to the reception of the <code>BikeRegisteredEvent</code>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_handling_the_bikeregisteredevent_in_the_aggregate"><a class="anchor" href="#_handling_the_bikeregisteredevent_in_the_aggregate"></a>Handling the BikeRegisteredEvent in the aggregate</h3>
<div class="paragraph">
<p>We want to design our system following the principles of <strong>Event Sourcing</strong>, which implies we will use the set of Events as the <strong>single source of truth</strong> for building or refreshing the state of any component in our system.</p>
</div>
<div class="paragraph">
<p>That means that we will also use the <code>BikeRegisteredEvent</code> as the source to trigger the state change in our command model, or, more specifically, in this case, in our <code>Bike</code> aggregate.</p>
</div>
<div class="paragraph">
<p>To be able to react to the event in our <code>Bike</code> aggregate, we need to add a method that receives the <code>BikeRegisteredEvent</code> event as an argument and annotate that method with <code>@EventSourcingHandler</code>:</p>
</div>
<div class="listingblock">
<div class="title">rental/src/main/java/io/axoniq/demo/bikerental/rental/command/Bike.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@Aggregate
public class Bike {


    @EventSourcingHandler <i class="conum" data-value="1"></i><b>(1)</b>
    protected void handle(BikeRegisteredEvent event) { <i class="conum" data-value="2"></i><b>(2)</b>
        this.bikeId = event.bikeId();
        this.isAvailable = true;
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>EventSourcingHandler</code> annotation indicates to Axon Framework to link this method to the reception of an event.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Axon Framework will use the type of the argument to link this method to the specific type of event.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In the implementation of the method, we will finally set the bike properties (the state of our model) with the information provided by the event.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
The <code>EventSourcingHandler</code> will be called right after the event publication by the <code>CommandHandler</code>. But it also will be invoked in the future, for the same event, when the system receives another command for the same <code>bikeId</code> (identified because the command has the same  <code>@AggregateIdentifier</code>) and Axon Framework needs to regenerate the current state of the <code>Bike</code> instance, by replaying all previous events with the same <code>bikeId</code>.
</td>
</tr>
</table>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
In the <code>EventSourcingHandler</code> method, we should never validate or ignore the changes represented by the event received. The reception of the event and the invocation of the method imply that the command has already been processed previously. So we can&#8217;t ignore or reject those changes <strong>because they already happened</strong>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>With this step, we have completed the code to process a Command that represents the request to register a new bike in our system.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_implementing_the_http_rest_controller"><a class="anchor" href="#_implementing_the_http_rest_controller"></a>Implementing the HTTP REST controller</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this section, we will implement the UI layer for our system. The UI layer represents the interface our system offers to the outside world to interact with our application.</p>
</div>
<div class="paragraph">
<p>In our example, we will start with a REST service interface that offers some endpoints so that a third-party application can invoke our system. This REST interface is convenient for our example because we can show you how to accept requests from the user or another system and create and send the corresponding Command internally.</p>
</div>
<div class="sect2">
<h3 id="_create_the_springboot_controller"><a class="anchor" href="#_create_the_springboot_controller"></a>Create the SpringBoot controller.</h3>
<div class="paragraph">
<p>For the controller, we are going to create a simple Spring <code>@RestController,</code> and we will configure a couple of components provided by AxonFramework:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong><code>CommandGateway</code></strong>: is the abstraction mechanism provided by AxonFramework to send commands to the handler and removes from the controller any need to know all the specifics about the number and location of command handlers registered in our system or how to reach them.</p>
</li>
<li>
<p><strong><code>QueryGateway</code></strong>: is a similar abstraction to the <code>CommandGateway</code> provided by Axon Framework, but in this case, it is intended to deliver query requests and wait for the query response.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Although we will only use the <code>CommandGateway</code> for now, we are also going to add the <code>QueryGateway</code> to our <code>@RestController</code> as we will need it later to implement the handling of requests to gather information from our system.</p>
</div>
<div class="paragraph">
<p>If you prefer to implement your code more progressively, just add the <code>CommandGateway</code> as this is the only component we will use now. You can add the <code>QueryGateway</code> field and its initialization later when implementing the code to handle the first query.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The abstraction these two components provide helps keep our <code>@RestController</code> decoupled from the different query and command handlers in our system. Axon Framework will inject the proper implementation to handle the routing and communication patterns required both for queries and commands.</p>
</div>
<div class="paragraph">
<p>Thus, our controller does not need to keep track of any detail about any of the handlers. This property is known as <strong>Location Transparency</strong> and it&#8217;s one of the features that enable our application to scale out later easily because we can move the command handler implementation to a different module and deploy it in a different machine without the need to touch the code that sends the commands.</p>
</div>
<div class="paragraph">
<p>We will place our controller in the <code>io.axoniq.demo.bikerental.rental.ui</code> package. Create a <code>RentalController</code> java class with the following contents:</p>
</div>
<div class="listingblock">
<div class="title">rental/src/main/java/io/axoniq/demo/bikerental/rental/ui/RentalController.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@RestController      <i class="conum" data-value="1"></i><b>(1)</b>
@RequestMapping("/") <i class="conum" data-value="2"></i><b>(2)</b>
public class RentalController {

    private final CommandGateway commandGateway;    <i class="conum" data-value="3"></i><b>(3)</b>
    private final QueryGateway queryGateway;        <i class="conum" data-value="4"></i><b>(4)</b>

    private final BikeRentalDataGenerator bikeRentalDataGenerator;

    public RentalController(CommandGateway commandGateway, QueryGateway queryGateway, BikeRentalDataGenerator bikeRentalDataGenerator) { <i class="conum" data-value="5"></i><b>(5)</b>
        this.commandGateway = commandGateway;
        this.queryGateway = queryGateway;
        this.bikeRentalDataGenerator = bikeRentalDataGenerator;
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>@RestController</code> SpringBoot annotation indicates that this component will define the REST endpoints.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>@RequestMapping</code> SpringBoot annotation indicates the root path for all the endpoints that this controller handles.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>CommandGateway</code> that we will use to send the commands.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The <code>QueryGateway</code> that we will use later to send query requests and wait for the response.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>We will define a constructor that receives both the <code>CommandGateway</code> and <code>QueryGateway</code> as an argument. Spring will provide the right implementation based on the components defined by Axon Framework.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_implement_the_endpoint_to_register_a_bike"><a class="anchor" href="#_implement_the_endpoint_to_register_a_bike"></a>Implement the endpoint to register a bike</h3>
<div class="paragraph">
<p>We must add a method in our controller to handle the HTTP Request to register a new bike. In our system, to create a new bike, we require the request to provide the type of the bike and the location where the bike is registered.</p>
</div>
<div class="paragraph">
<p>For this endpoint, we will consider the following request format:</p>
</div>
<div class="literalblock">
<div class="content">
<pre>POST /bikes?bikeType={bikeType}&amp;location={city}</pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
When designing a REST endpoint that registers a new element in our system, it is usual to model the API to use a POST request, which contains the information of the entity to create in the body. In this first example, for the sake of simplicity, we will receive the bike details as parameters on the request.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>To implement the endpoint that handles these requests, add the following method to the <code>RentalController</code>:</p>
</div>
<div class="listingblock">
<div class="title">rental/src/main/java/io/axoniq/demo/bikerental/rental/ui/RentalController.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">@PostMapping("/bikes") <i class="conum" data-value="1"></i><b>(1)</b>
public CompletableFuture&lt;String&gt; registerBike(
        @RequestParam("bikeType") String bikeType,      <i class="conum" data-value="2"></i><b>(2)</b>
        @RequestParam("location") String location) {    <i class="conum" data-value="3"></i><b>(3)</b>

    RegisterBikeCommand registerBikeCommand =
            new RegisterBikeCommand(                <i class="conum" data-value="4"></i><b>(4)</b>
                    UUID.randomUUID().toString(),   <i class="conum" data-value="5"></i><b>(5)</b>
                    bikeType,
                    location);

    CompletableFuture&lt;String&gt; commandResult =
            commandGateway.send(registerBikeCommand); <i class="conum" data-value="6"></i><b>(6)</b>

    return commandResult; <i class="conum" data-value="7"></i><b>(7)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>@PostMapping</code> links the execution of this method to the reception of <code>POST /bike</code> requests.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>bikeType</code> argument is extracted from the parameter with the same name on the request.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>location</code> argument is filled with the value of the parameter with the same name from the request&#8217;s URL.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>We must create the <code>RegisterBikeCommand</code> that represents the command we will send to the command handler in the command model.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The command requires a unique ID for the bike. As this request represents the creation of the new bike, we have chosen to create a unique ID on the controller.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>We send the command through the <code>CommandGateway</code> abstraction provided by Axon Framework.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>The command will be dispatched to the command handler. It will return a <code>CompletableFuture</code> with the result of executing the command.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
By default, Axon Framework returns the ID of the bike that has been created. If there is any error in delivering the command to a command handler (for example, because there is no command handler registered for `RegisterBikeCommand`s), the CompletableFuture will contain the error.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_conclusion"><a class="anchor" href="#_conclusion"></a>Conclusion</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this section, we have implemented the code necessary to handle requests to register a new bike in our system.</p>
</div>
<div class="paragraph">
<p>The following image represents the design of what we have implemented.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="_images/RegisterBikeCommand.png" alt="A diagram that shows the flow to process a Register bike request: First" width="we receive a POST HTTP request in the RentalController. Then" height="the RentalController sends a RegisterBikeCommand through the CommandGateway. The RegisterBikeCommand is delivered to the @CommandHandler method of the Bike Aggregate. The Command Handler validates the command and sends a BikeRegisteredEvent that will be sent to every other external module that is "interested" in this type of event. The @EventSourcingHandler also handles the event in the Bike aggregate">
</div>
<div class="title">Figure 1. Diagram with the flow of messages to register a new bike</div>
</div>
<div class="paragraph">
<p>We can execute our application and see it in action. In our next section, we will go through the steps to run our AxonFramework application together using docker from your development environment.</p>
</div>
</div>
</div>
        <nav class="pagination">
  <span class="prev"><a href="bootstraping-axonframework.html">Bootstrap AxonFramework</a></span>
  <span class="next"><a href="run-app-with-docker-compose.html">Running Your Application Locally With Docker Compose</a></span>
</nav>
    </article>
  </div>
</main>
</div>
<footer class="footer">
  <div class="primary-footer">
    <div class="footer-logo ">
      <a href="https://axoniq.io/">
        <img src="https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=90&amp;height=20&amp;name=Logo%20AxonIQ%20(2).png" alt="Logo AxonIQ" loading="lazy" srcset="https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=45&amp;height=10&amp;name=Logo%20AxonIQ%20(2).png 45w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=90&amp;height=20&amp;name=Logo%20AxonIQ%20(2).png 90w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=135&amp;height=30&amp;name=Logo%20AxonIQ%20(2).png 135w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=180&amp;height=40&amp;name=Logo%20AxonIQ%20(2).png 180w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=225&amp;height=50&amp;name=Logo%20AxonIQ%20(2).png 225w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=270&amp;height=60&amp;name=Logo%20AxonIQ%20(2).png 270w" sizes="(max-width: 90px) 100vw, 90px" width="90" height="20">
      </a>
    </div>

    <div class="footer-menu">
	    <h3>Products</h3>
	    <div>
        <ul role="menu">
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/products/axon-framework">Axon Framework</a></li>
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/products/axon-server">Axon Server</a></li>
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/products/axoniq-cloud">AxonIQ Cloud</a></li>
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/products/axoniq-console">AxonIQ Console</a></li>
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/products/axon-synapse">Axon Synapse</a></li>
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/blog/protect-sensitive-data-in-an-event-sourced-application">AxonIQ Data Protection</a></li>
        </ul>
      </div>
    </div>

    <div class="footer-menu">
	    <h3>Sites</h3>
	    <div>
        <ul role="menu">
          <li><a class="ext" target="_blank" href="http://support.axoniq.io/">Customer Support Portal</a></li>
          <li><a class="ext" target="_blank" href="https://academy.axoniq.io/">AxonIQ Academy</a></li>
          <li><a class="ext" target="_blank" href="https://console.axoniq.io/">AxonIQ Console</a></li>
          <li><a class="ext" target="_blank" href="https://discuss.axoniq.io/">AxonIQ Discuss</a></li>
          <li><a class="ext" target="_blank" href="https://console.cloud.axoniq.io">AxonIQ Cloud</a></li>
        </ul>
      </div>
    </div>

    <div class="footer-menu">
	    <h3>Follow us</h3>
	    <div>
        <ul role="menu">
          <li><a class="ext" target="_blank" href="https://www.youtube.com/axoniq">YouTube</a></li>
          <li><a class="ext" target="_blank" href="https://www.linkedin.com/company/axoniq">LinkedIn</a></li>
          <li><a class="ext" target="_blank" href="https://www.facebook.com/AxonIQ.io">Facebook</a></li>
          <li><a class="ext" target="_blank" href="https://twitter.com/axon_iq">Twitter</a></li>
          <li><a class="ext" target="_blank" href="https://github.com/AxonIQ">GitHub</a></li>
          <li><a class="ext" target="_blank" href="https://medium.com/axoniq">Medium</a></li>
        </ul>
      </div>
    </div>
  </div>
</footer>
<script id="site-script" src="../../_/js/site.js" data-ui-root-path="../../_"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
<script async src="../../_/js/vendor/page-actions.js"></script>
<script async src="../../_/js/vendor/tabs.js" data-sync-storage-key="preferred-tab" data-sync-storage-scope="session"></script>
<script src="../../_/js/vendor/lunr.js"></script>
<script src="../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../.." data-snippet-length="100" data-stylesheet="../../_/css/search.css"></script>
<script async src="../../search-index.js"></script>
  </body>
</html>
