<!DOCTYPE html>
<html lang="en">
  <head>
        <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Feature: Course Creation</title>
    <link rel="canonical" href="https://docs.axoniq.io/axon-framework-5-getting-started/implement-command-create-course/">
    <link rel="prev" href="../project-structure/">
    <link rel="next" href="../implement-command-subscribe-student/">
    <meta name="generator" content="Antora 3.1.10">
    <link rel="stylesheet" href="../../_/css/site.css">
    <link rel="stylesheet" href="../../_/css/vendor/tabs.css">
    <link rel="icon" href="../../_/img/favicon.ico" sizes="32x32">
    <link rel="icon" href="../../_/img/icon.svg" type="image/svg+xml" media="(prefers-color-scheme: light)">
    <link rel="icon" href="../../_/img/icon-light.svg" type="image/svg+xml" media="(prefers-color-scheme: dark)">
    <link rel="apple-touch-icon" href="../../_/img/apple-touch-icon.png"><!-- 180×180 -->
    <link rel="manifest" href="../../_/static/manifest.webmanifest">
        <!-- Google Tag Manager -->
        <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer','GTM-5QD58ZB');</script>
        <!-- End Google Tag Manager -->

    <script>var uiRootPath = '../../_'</script>


  </head>
  <body class="article">
    <div class="banner">
    <a href="https://console.axoniq.io">Manage and monitor your Axon Framework applications and Axon Server environments. <span class="banner_button" target="_blank">Try AxonIQ Console</span></a>
</div>    
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5QD58ZB"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://docs.axoniq.io"><img src="../../_/img/logo-dark4x.png" class="header_logo" /></a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="../../home/basics/">Basics</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="../../home/guides/">Guides</a>
          <div class="navbar-dropdown card">
            <a class="navbar-item" href="../../home/guides/axon-framework">Axon Framework</a>
            <a class="navbar-item" href="../../home/guides/axon-server">Axon Server</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="../../home/reference/">Reference</a>
          <div class="navbar-dropdown card">
                <a class="navbar-item" href="../../axon-framework-reference/4.11/">Axon Framework</a>
                <a class="navbar-item" href="../../axon-framework-extensions/">Axon Framework Extensions</a>
                <a class="navbar-item" href="../../axon-server-reference/v2024.2/">Axon Server</a>
                <a class="navbar-item" href="../../synapse-reference/v0.12/">Axon Synapse</a>
                <a class="navbar-item" href="../../axoniq-console-reference/">AxonIQ Console</a>
          </div>
        </div>
      </div>
      <div class="navbar-end">
        <div class="navbar-item search hide-for-print">
          <div id="search-field" class="field">
            <input id="search-input" type="text" placeholder="Search AxonIQ Docs">
          </div>
        </div>
        <a class="navbar-item navbar-button" href="https://academy.axoniq.io" target="_blank">AxonIQ Academy</a>
        <a class="navbar-item navbar-button" href="https://discuss.axoniq.io" target="_blank">AxonIQ Discuss</a>
        <a class="navbar-item navbar-button" href="https://axoniq.io/contact" target="_blank">Get in touch</a>
      </div>
    </div>
  </nav>
</header>
    <div class="toolbar card" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../home/" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../">Getting Started with Axon Framework 5 </a></li>
    <li><a href="./">Feature: Course Creation</a></li>
  </ul>
</nav>
<div class="page-actions">
  <button class="actions-menu-toggle" title="Show actions related to this page">Actions</button>
  <div class="actions-menu toolbar_dropdown_menu card">
      <a class="action item" href="https://github.com/AxonFramework/AxonFramework/edit/axon-5.0.x/docs/af5-getting-started/modules/ROOT/pages/implement-command-create-course.adoc">Edit this Page</a>
    
    <a class="action item" href="https://discuss.axoniq.io/search?q&#x3D;Feature%3A%20Course%20Creation" target="discuss_search">View Discussions</a>
    <a class="action item" href="https://discuss.axoniq.io/new-topic?category&#x3D;library&amp;title&#x3D;%22Feature%3A%20Course%20Creation%22%20Discussion&amp;body&#x3D;%3C!--%20Replace%20this%20comment%20with%20your%20comment%2Fsuggestion%2Fquestion%2F...%20--%3E%0A%0A%0A%3C!--%0AKeep%20the%20section%20below!%0ALinking%20back%20to%20the%20documentation%20URL%20not%20only%20helps%20people%20go%20to%20the%20page%0Abut%20also%20helps%20find%20relevant%20discussions%20from%20the%20documentation%20page%20via%20the%20%22View%20Discussion%22%20menu.%0A--%3E%0A%5Bdetails%3D%22Related%20library%20page%22%5D%0A%5BFeature%3A%20Course%20Creation%5D(https%3A%2F%2Fdocs.axoniq.io%2Faxon-framework-5-getting-started%2Fimplement-command-create-course%2F)%0A%5B%2Fdetails%5D%0A" target="discuss_add">Start new discussion</a>
  </div>
</div>


</div>
    <div class="content_container">
      <div class="body">
<div class="nav-container" data-component="axon-framework-5-getting-started" data-version="master">
    <aside class="nav card">
      <div class="panels">
        <div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../">Getting Started with Axon Framework 5</a></h3>

<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../">Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../sample-domain-event-modeling/">University Domain</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../project-structure/">Project Structure</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="./">Feature: Course Creation</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../implement-command-subscribe-student/">Feature: Subscribe Student</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
      </div>
    </aside>
</div>
<main class="article">
    <div class="page_content">
        <aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
          <article class="doc">
            <h1 class="page">Feature: Course Creation</h1>
            <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>When implementing a new feature in Axon Framework 5, the first step is defining the messages that will flow through the system. Messages are first-class citizens in Axon, and everything is designed around them.
They are inputs and outputs of the certain features (slices in the Vertical Slice Architecture).
While designing the app and also during execution—you&#8217;re always in the context of some command.</p>
</div>
<div class="paragraph">
<p>For our first feature, we&#8217;ll implement the capability to create a new course.
After all, what&#8217;s a university faculty without courses that students can subscribe to?</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_define_messages"><a class="anchor" href="#_define_messages"></a>Define messages</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Messages are the contract between different parts of our system, so you need to pay attention to craft them correctly.
Event Modeling helps a lot, thanks to its completeness check you can be sure that you don&#8217;t forget about anything.
So let&#8217;s take the first Write Slice on the table.</p>
</div>
<div class="paragraph">
<p>Looking at our Event Modeling diagram, our first writing slice involves <code>CreateCourse</code> leading to <code>CourseCreated</code>.
Let&#8217;s translate these sticky notes into code.
The orange sticky is an event, and every event needs a cause, which is a command that may trigger the event.
In this case it&#8217;s a <code>CreatCourse</code> on the blue sticky note.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/EventModeling_CreateCourse_Stickies.png" alt="EventModeling CreateCourse Stickies">
</div>
</div>
<div class="paragraph">
<p>In Axon Framework 5, we typically define commands and events as Java records to ensure immutability.
You can also use Java classes if you really want, but records nicely fulfill the characteristic of messages because they are immutable by definition.
Following our Vertical Slice Architecture, we&#8217;ll place each message in its appropriate package:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>CreateCourse</code> in the <code>io.axoniq.demo.university.faculty.write.createcourse</code> package (we place command inside the slice package, because the command has only one handler)</p>
</li>
<li>
<p><code>CourseCreated</code> in the <code>io.axoniq.demo.university.faculty.events</code> package (events are shared between slices, there may be 0 to many handlers for the same event)</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">src/main/java/io/axoniq/demo/university/faculty/write/createcourse/CreateCourse.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package io.axoniq.demo.university.faculty.write.createcourse;

import io.axoniq.demo.university.faculty.shared.ids.CourseId;
import org.axonframework.modelling.annotation.TargetEntityId;

public record CreateCourse(
    CourseId courseId,
    String name,
    int capacity
) {}</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You may notice that for the <code>courseId</code> field we use <code>CourseId</code> value object.
It&#8217;s not necessary, but it&#8217;s a convention.
This class provides type safety and domain semantics for course identifiers.
Thanks to that, you won&#8217;t mix CourseId with other identifiers in the system like StudentId.
The class may be as simple as:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public record CourseId(String raw) {
    @Override
    public String toString() { // will be used as a tag value
        return raw;
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the repository, we have also some additional helpful methods that you may find in the repository, but for now this is enough.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Next, let&#8217;s define the event that will be published when a course is created:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/io/axoniq/demo/university/faculty/events/CourseCreated.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package io.axoniq.demo.university.faculty.events;

import org.axonframework.eventsourcing.annotations.EventTag;

public record CourseCreated(
    @EventTag
    CourseId courseId, <i class="conum" data-value="1"></i><b>(1)</b>
    String name,
    int capacity
) {}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>@EventTag</code> annotation is crucial—it allows Axon to tag events as connected to specific business entities, which enables efficient retrieval later.
If you are used to Aggregate approach before, note that the Tag identifies the aggregate. Now, thanks to Dynamic Consistency Boundary, you now can have one event assigned to many business entities (instead of one, as before!).
The EventStore in Axon Framework 5 always stores your events along with assigned tags, so you can query them later based on those tags and types.
For the <code>Tag</code> value the <code>toString()</code> method will be used, so you need to override it in your typed identifier.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Please remember that if you want to use the Value Objects in your events (like for the <code>courseId</code>), you need to configure custom deserializers for them to avoid <code>{"courseId": {"raw": "some-id"}}</code> in case of JSON.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For the first milestone, it&#8217;s only possible to define tags with annotations.
In the future, the configuration API will expose methods to do that without placing annotations on your events.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_specification_by_example"><a class="anchor" href="#_specification_by_example"></a>Specification by example</h2>
<div class="sectionbody">
<div class="paragraph">
<p>With our messages defined, we&#8217;ll now follow a Test-First approach to specify the behavior of our slice (feature).
Axon provides excellent support for testing through the <code>AxonTestFixture</code>.</p>
</div>
<div class="paragraph">
<p>So keep focus on the current command - <code>CreateCourse</code> and create corresponding <code>CreateCourseTest</code> class in the <code>io.axoniq.demo.university.faculty.write.createcourse</code> package.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
You can also use your IDE to create the unit test class.
Open the <code>CreateCourse</code> class and ask your IDE to generate the corresponding unit test.
Depending on your IDE, the shortcut or menu may vary, but it&#8217;s a shortcut worth knowing for your IDE.
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">src/test/java/io/axoniq/demo/university/faculty/write/createcourse/CreateCourse.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package io.axoniq.demo.university.faculty.write.createcourse;

class CreateCourseTest {

}</code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_defining_the_test_fixture"><a class="anchor" href="#_defining_the_test_fixture"></a>Defining the test fixture</h3>
<div class="paragraph">
<p>Axon Framework&#8217;s test fixture allows you to execute test cases against a provided configuration.
It may be your module/component configuration, or even the whole application!</p>
</div>
<div class="paragraph">
<p>Do you remember the configurer that we used while bootstrapping the application?
Now it&#8217;s time to use it to initialize our test fixture.
We need to have access to application components in tests to verify their behavior, which the configuration provides.</p>
</div>
<div class="listingblock">
<div class="title">src/test/java/io/axoniq/demo/university/faculty/write/createcourse/CreateCourse.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package io.axoniq.demo.university.faculty.write.createcourse;

class CreateCourseTest {

    private AxonTestFixture fixture;

    @BeforeEach <i class="conum" data-value="1"></i><b>(1)</b>
    void beforeEach() {
        fixture = AxonTestFixture.with(UniversityAxonApplication.configurer()); <i class="conum" data-value="2"></i><b>(2)</b>
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>@BeforeEach</code> marks this method to be called before any test is executed in our test class.
Adding the code to create the <code>AxonTestFixture</code> here will ensure that we have a fresh fixture for each test case, and thus we make our different tests independent.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>This line creates a new <code>AxonTestFixture</code> based on our configurer. The configuration will be build and started from configurer by the fixture itself.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_testing_the_command"><a class="anchor" href="#_testing_the_command"></a>Testing the command</h3>
<div class="paragraph">
<p>Thanks to the help of the <code>AxonTestFixture</code> we can now create a test following the Given-When-Then pattern:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Given</strong>: Set the initial state for our test.
Since we are designing our system to follow Event-Sourcing patterns, we need to set the list of events that have already happened before receiving the command.</p>
</li>
<li>
<p><strong>When</strong>: Specify the command whose execution we want to test.
In this case, we will test the processing of a <code>CreateCourse</code>.</p>
</li>
<li>
<p><strong>Expect</strong>: We can instruct the fixture on the expectations we have from our system after processing the command.
In an Event-Sourcing system, we will specify these expectations in the form of what events should have been produced by the command handler as a result of processing the command.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>So, let&#8217;s define a method in our unit test to check that our system can successfully process the request to create a course.
For now, we focus on the happy path. In the Event Modeling, we&#8217;ve described this as GWT specification:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/EventModeling_CreateCourse_GWT_Spec1.png" alt="EventModeling CreateCourse GWT Spec1">
</div>
</div>
<div class="listingblock">
<div class="title">src/test/java/io/axoniq/demo/university/faculty/write/createcourse/CreateCourse.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package io.axoniq.demo.university.faculty.write.createcourse;

import java.util.UUID;class CreateCourseTest {

    private AxonTestFixture fixture;

    @BeforeEach
    void beforeEach() {
        fixture = AxonTestFixture.with(UniversityAxonApplication.configurer());
    }

    @Test
    void givenNotExistingCourse_WhenCreateCourse_ThenSuccess() {
        var courseId = new CourseId(UUID.randomUUID().toString());
        var courseName = "Event Sourcing in Practice";
        var capacity = 3;

        fixture.given() <i class="conum" data-value="1"></i><b>(1)</b>
               .noPriorActivity()
               .when()
               .command(new CreateCourse(courseId, courseName, capacity)) <i class="conum" data-value="2"></i><b>(2)</b>
               .then()
               .events(new CourseCreated(courseId, courseName, capacity)); <i class="conum" data-value="3"></i><b>(3)</b>
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>In our case, when we receive the <code>CreateCourse</code> command, we expect that no previous events were received in the system.
We may even skip the whole <code>given</code> section if there is nothing to execute.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We provide the <code>CreateCourse</code> command we want to dispatch against the system (scoped to the given configuration).</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>After successfully processing the <code>CreateCourse</code>, we expect the publication of a new <code>CourseCreated</code> event with the details of the new course.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If we run this test now, it will fail with the following error:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">org.axonframework.commandhandling.NoHandlerForCommandException: No handler was subscribed for command [io.axoniq.demo.university.faculty.write.createcourse.CreateCourse#0.0.1].</code></pre>
</div>
</div>
<div class="paragraph">
<p>This is expected, of course.
It means that we need to implement the handler for the <code>CreateCourse</code> command.
And this will be our next step!</p>
</div>
</div>
<div class="sect2">
<h3 id="_implementing_the_command_handler"><a class="anchor" href="#_implementing_the_command_handler"></a>Implementing the command handler</h3>
<div class="paragraph">
<p>To process a <code>CreateCourse</code> command in our application, we must define a method that receives the command as an argument.
To indicate that the method should be invoked upon receiving a command, we will add the <code>@CommandHandler</code> annotation provided by Axon Framework.
Let&#8217;s create a new class for that inside the slice package, name it <code>CreateCourseCommandHandler</code>, and implement the minimum required to make the test pass.</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/io/axoniq/demo/university/faculty/write/createcourse/CreateCourseCommandHandler.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package io.axoniq.demo.university.faculty.write.createcourse;

import org.axonframework.commandhandling.annotation.CommandHandler;
import org.axonframework.eventhandling.gateway.EventAppender;
import org.axonframework.modelling.annotation.InjectEntity;

class CreateCourseCommandHandler {

    @CommandHandler <i class="conum" data-value="1"></i><b>(1)</b>
     void handle(
            CreateCourse command,  <i class="conum" data-value="2"></i><b>(2)</b>
            EventAppender eventAppender <i class="conum" data-value="3"></i><b>(3)</b>
    ) {
        var event = new CourseCreated(command.courseId(), command.name(), command.capacity());  <i class="conum" data-value="4"></i><b>(4)</b>
        eventAppender.append(event); <i class="conum" data-value="5"></i><b>(5)</b>
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>org.axonframework.commandhandling.annotation.CommandHandler</code> annotation instructs Axon Framework to call this method upon receiving commands.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The type of the argument indicates to Axon Framework which type of commands should be linked to the invocation of this method.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>EventAppender</code> is a component that allows us to publish events in the context of the current command so the events will be published after successful command execution.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>We create the Event as a result of the command handling. The Event message responsibility is to notify the change in the state of our system. In this case, the event notifies that the <strong>course has been created</strong>.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The invocation of <code>EventAppender#append</code> stage event to be published after the current <code>ProcessingContext</code> is completed.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Have you already tried to run the test?
Unfortunately, it will fail again.
What we need to do now, we need to register the <code>CreateCourseCommandHandler</code> in the Axon Framework configuration.
We&#8217;re going to do it in dedicated class <code>CreateCourseConfiguration</code> which will be responsible for spinning up the infrastructure for the whole slice.</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/io/axoniq/demo/university/faculty/write/createcourse/CreateCourseConfiguration.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package io.axoniq.demo.university.faculty.write.createcourse;

public class CreateCourseConfiguration {

    public static EventSourcingConfigurer configure(EventSourcingConfigurer configurer) {
        var commandHandlingModule = StatefulCommandHandlingModule.named("CreateCourse") <i class="conum" data-value="1"></i><b>(1)</b>
                .commandHandlers()
                .annotatedCommandHandlingComponent(c -&gt; new CreateCourseCommandHandler()); <i class="conum" data-value="2"></i><b>(2)</b>
        return configurer.registerStatefulCommandHandlingModule(commandHandlingModule); <i class="conum" data-value="3"></i><b>(3)</b>
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>StatefulCommandHandlingModule</code> is a component that allows us to register the command handler for the <code>CreateCourse</code> command.
For our current needs we skip <code>entities</code> configuration, because we don&#8217;t need the state yet.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>annotatedCommandHandlingComponent</code> method allows us to register the <code>CreateCourseCommandHandler</code> as the command handler for the <code>CreateCourse</code> command.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>registerStatefulCommandHandlingModule</code> method registers the command handler module in the Axon Framework configuration.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>When the slice configurer is ready, we can register it to the main application configurer.
To do that, let&#8217;s introduce changes in our main <code>UniversityAxonApplication</code> class.</p>
</div>
<div class="listingblock">
<div class="title">/src/main/java/io/axoniq/demo/university/UniversityAxonApplication.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class UniversityAxonApplication {

    public static ApplicationConfigurer configurer() {
        var configurer = EventSourcingConfigurer.create();
        configurer = CreateCourseConfiguration.configure(configurer);
        return configurer;
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s check our test again, and&#8230;&#8203; now everything is green!
Can we say that the work is done?
Not yet!
Because we have some business rules defined in the Given-When-Then specification as follows:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/EventModeling_CreateCourse_GWT_Spec2.png" alt="EventModeling CreateCourse GWT Spec2">
</div>
</div>
<div class="paragraph">
<p>The course cannot be created if it already exists.
So let&#8217;s add a test case for that to the <code>CreateCourseTest</code> class as below.</p>
</div>
<div class="listingblock">
<div class="title">src/test/java/io/axoniq/demo/university/faculty/write/createcourse/CreateCourse.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package io.axoniq.demo.university.faculty.write.createcourse;

import java.util.UUID;

class CreateCourseTest {

    // fixture creation skipped for brevity

    @Test
    void givenCourseCreated_WhenCreateCourse_ThenSuccess_NoEvents() {
        var courseId = new CourseId(UUID.randomUUID().toString());
        var courseName = "Event Sourcing in Practice";
        var capacity = 3;

        fixture.given()
               .event(new CourseCreated(courseId, courseName, capacity)) <i class="conum" data-value="1"></i><b>(1)</b>
               .when()
               .command(new CreateCourse(courseId, courseName, capacity)) <i class="conum" data-value="2"></i><b>(2)</b>
               .then()
               .success() <i class="conum" data-value="3"></i><b>(3)</b>
               .noEvents(); <i class="conum" data-value="3"></i><b>(3)</b>
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>In our case, when we receive the <code>CreateCourse</code> command, we expect that <code>CourseCreated</code> event happened in the past, so the Course already exists in the system.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We provide the <code>CreateCourse</code> command we want to dispatch against the system (scoped to the given configuration), so will be handled by registered handler.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>After successfully processing the <code>CreateCourse</code>, we expect the command handler executed successfully, but no events were published.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>If you ran this test, you may notice that it fails because of unexpected event was published!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlightjs highlight"><code class="language-console hljs" data-lang="console">org.axonframework.test.AxonAssertionError: The published events do not match the expected events

Expected  |  Actual
----------|----------
         &lt;|&gt; io.axoniq.demo.university.faculty.events.CourseCreated</code></pre>
</div>
</div>
<div class="paragraph">
<p>Do you remember that we haven&#8217;t used any state inside the <strong>Stateful</strong> command handling component?
Now we are definitely going to do that, because the system decision what to do with the command will be based on what happened in the system before—the state derived from the historical events.</p>
</div>
</div>
<div class="sect2">
<h3 id="_validate_the_command_against_the_state"><a class="anchor" href="#_validate_the_command_against_the_state"></a>Validate the Command against the state</h3>
<div class="paragraph">
<p>The only thing we need to know when handling a <code>CreateCourse</code> command, is whether a certain course already exists.
So let&#8217;s add the <code>State</code> class which will be responsible for providing that information.
We will use the generic term <code>State</code>, because we do not need the entire <code>Course</code> to make our decision.
You can name it <code>Course</code> as well, but keep in mind it&#8217;s just a part of information needed for the validation of this command.
I&#8217;m going to put it as internal class in the handler, because it will be used just there.</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/io/axoniq/demo/university/faculty/write/createcourse/CreateCourseCommandHandler.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package io.axoniq.demo.university.faculty.write.createcourse;

class CreateCourseCommandHandler {

    @EventSourcedEntity(tagKey = "courseId") <i class="conum" data-value="1"></i><b>(1)</b>
    static class State {

        private boolean created = false; <i class="conum" data-value="2"></i><b>(2)</b>

        @EventSourcingHandler <i class="conum" data-value="3"></i><b>(3)</b>
        public void evolve(CourseCreated event) {
            this.created = true;
        }
    }

    @CommandHandler
    void handle(
        CreateCourse command,
        @InjectEntity(idProperty = "courseId") State state, <i class="conum" data-value="4"></i><b>(4)</b>
        EventAppender eventAppender
    ) {
        if(state.created) { <i class="conum" data-value="5"></i><b>(5)</b>
            return;
        }
        var event = new CourseCreated(command.courseId(), command.name(), command.capacity());
        eventAppender.append(event);
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>@EventSourcedEntity</code> annotation indicates that this class' state is derived from the events published with the given tag key (<code>courseId</code> in this case).
We&#8217;ve already annotated <code>courseId</code> property in the <code>CourseCreated</code> event class with <code>@EventTag</code>, so the event will be applied while loading the entity if the <code>courseId</code> value matches.
Pay attention that <code>State</code> per feature/slice approach gives us a high level of encapsulation, because we can keep it package-private. The cohesion is also higher, because you don&#8217;t care about the unrelated topics for the current process. It reduces the cognitive load on a developer—you only need to comprehend the state needed for that particular slice.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The properties needed to guard certain business rules.
In this case, we need to know if the course was already created or not.
While executing the command, we don&#8217;t care about the name or other properties.
In other words: you don&#8217;t need to know who/how many students are subscribed to decide if the name can be changed.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>@EventSourcingHandler</code> annotation indicates to Axon Framework that this method should be called while rehydrating the state of the entity.
Axon Framework will use the type of the annotated method argument to link this method to the specific type of event. Furthermore, the event type is used to query the <code>Event Store</code> just for those types.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>The <code>@InjectEntity</code> annotation indicates to Axon Framework to inject the entity with the given identifier property which needs to be present in the processed command.
In this case, we want to inject the <code>State</code> entity with the <code>courseId</code> property.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>The <code>if</code> statement checks if the course was already created.
If it was, we don&#8217;t need to do anything, so we just return from the method.
To just ignore the command (do not publish events) is a choice. Thanks to that, the command can be safely retried.
Alternatively, you may throw an exception or publish an event that notifies about the failure.</td>
</tr>
</table>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
In the <code>EventSourcingHandler</code> method, we should never validate or ignore the changes represented by the event received.
The reception of the event and the invocation of the method imply that the command has already been processed previously.
So we can&#8217;t ignore or reject those changes <strong>because they already happened</strong>.
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As before, the last step to fulfill the next test case is to change our configuration.
Come back to the <code>CreateCourseConfiguration</code> class and add the <code>State</code> class to the configuration.</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/io/axoniq/demo/university/faculty/write/createcourse/CreateCourseConfiguration.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">package io.axoniq.demo.university.faculty.write.createcourse;

public class CreateCourseConfiguration {

    public static EventSourcingConfigurer configure(EventSourcingConfigurer configurer) {
        var stateEntity = EventSourcedEntityBuilder
                .annotatedEntity(CourseId.class, CreateCourseCommandHandler.State.class);  <i class="conum" data-value="1"></i><b>(1)</b>

        var commandHandlingModule = StatefulCommandHandlingModule.named("CreateCourse")
                .entities()
                .entity(stateEntity)  <i class="conum" data-value="2"></i><b>(2)</b>
                .commandHandlers()
                .annotatedCommandHandlingComponent(c -&gt; new CreateCourseCommandHandler());
        return configurer.registerStatefulCommandHandlingModule(commandHandlingModule);
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>EventSourcedEntityBuilder</code> is a builder that allows us to create an entity with the given identifier type and state class.
We use <code>annotatedEntity</code>, because of the style we follow here, but you may also invoke just an <code>entity</code> builder method and do everything like defining event handlers here, so you can keep your domain model free from annotations if it&#8217;s your preferred way of coding.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>entity</code> method allows us to register the <code>State</code> class as the entity for the <code>CreateCourse</code> command handling module.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You may run the tests again and see that all of them should pass!</p>
</div>
</div>
<div class="sect2">
<h3 id="_execute_the_command"><a class="anchor" href="#_execute_the_command"></a>Execute the command</h3>
<div class="paragraph">
<p>In your production application you need to get the <code>CommandGateway</code> from your configuration to execute commands.
This component was configured by default for you, because you have used <code>EventSourcingConfigurer</code>.
To be able to get components from the configuration, you need to start the <code>ApplicationConfigurer</code>.
In the example below, we&#8217;re doing essentially what the Test Fixture does for us under the hood while testing.</p>
</div>
<div class="listingblock">
<div class="title">/src/main/java/io/axoniq/demo/university/UniversityAxonApplication.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class UniversityAxonApplication {

    public static ApplicationConfigurer configurer() {
        var configurer = EventSourcingConfigurer.create();
        configurer = CreateCourseConfiguration.configure(configurer);
        return configurer;
    }

    public static void main(String[] args) {
        var configuration = configurer().start(); <i class="conum" data-value="1"></i><b>(1)</b>

        var createCourse = new CreateCourse(CourseId.random(), "Event Sourcing in Practice", 3);

        var commandGateway = configuration.getComponent(CommandGateway.class); <i class="conum" data-value="2"></i><b>(2)</b>

        commandGateway.sendAndWait(createCourse); <i class="conum" data-value="3"></i><b>(3)</b>
    }


}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>start</code> method builds and starts (for example, invoke lifecycle hooks) the configuration and returns the <code>NewConfiguration</code> instance. The name of the <code>NewConfiguration</code> type will definitely change to <code>Configuration</code> when the Framework is released fully.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>getComponent</code> method allows us to retrieve the <code>CommandGateway</code> component from the configuration.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>The <code>sendAndWait</code> method sends the command to the command bus and waits for the result.</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you&#8217;re using Spring Boot you can always define <code>NewConfiguration</code> as a <code>@Bean</code> and inject it into your controller. The first-class Spring support for Axon Framework 5 is under development.
</td>
</tr>
</table>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
If you&#8217;re familiar with Hexagonal Architecture (aka Ports &amp; Adapters) you may treat the CommandGateway as a Port to your application and the controllers as Adapter.
</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_first_in_first_out"><a class="anchor" href="#_first_in_first_out"></a>First in, first out</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="../_images/EventModeling_CreateCourse_Done.png" alt="EventModeling CreateCourse Done">
</div>
</div>
<div class="paragraph">
<p>Do you like green tests?
What we like even more are green slices on Event Modeling.
So if you use this approach now you can mark your first slice as implemented!
Congratulations!</p>
</div>
<div class="paragraph">
<p>In the next section, we&#8217;ll tackle a more complex feature: allowing students to subscribe to courses, where we have to deal with business rules spanning a wider scope of the system.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_alternative_approach_without_annotations"><a class="anchor" href="#_alternative_approach_without_annotations"></a>Alternative approach without annotations</h2>
<div class="sectionbody">
<div class="paragraph">
<p>If you prefer not to use annotations in your domain model, we have you covered.
You can skip annotations like <code>@EventSourcingHandler</code> on the state class and snip up everything in the configuration using plain Java code!
To see how to implement this slice differently, you can check the GitHub repository <a href="https://github.com/AxonIQ/university-demo/tree/master/src/main/java/io/axoniq/demo/university/faculty/write/createcourseplain/" class="external" target="_blank" rel="noopener">University Demo (Create Course in plain Java)</a>.</p>
</div>
</div>
</div>
        <nav class="pagination">
  <span class="prev"><a href="../project-structure/">Project Structure</a></span>
  <span class="next"><a href="../implement-command-subscribe-student/">Feature: Subscribe Student</a></span>
</nav>
    </article>
  </div>
</main>
</div>
      <footer class="footer">
  <div class="primary-footer">
    <div class="footer-logo ">
      <a href="https://axoniq.io/">
        <img src="https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=90&amp;height=20&amp;name=Logo%20AxonIQ%20(2).png" alt="Logo AxonIQ" loading="lazy" srcset="https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=45&amp;height=10&amp;name=Logo%20AxonIQ%20(2).png 45w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=90&amp;height=20&amp;name=Logo%20AxonIQ%20(2).png 90w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=135&amp;height=30&amp;name=Logo%20AxonIQ%20(2).png 135w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=180&amp;height=40&amp;name=Logo%20AxonIQ%20(2).png 180w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=225&amp;height=50&amp;name=Logo%20AxonIQ%20(2).png 225w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=270&amp;height=60&amp;name=Logo%20AxonIQ%20(2).png 270w" sizes="(max-width: 90px) 100vw, 90px" width="90" height="20">
      </a>
    </div>

    <div class="footer-menu">
	    <h3>Products</h3>
	    <div>
        <ul role="menu">
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/products/axon-framework">Axon Framework</a></li>
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/products/axon-server">Axon Server</a></li>
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/products/axoniq-console">AxonIQ Console</a></li>
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/blog/protect-sensitive-data-in-an-event-sourced-application">AxonIQ Data Protection</a></li>
        </ul>
      </div>
    </div>

    <div class="footer-menu">
	    <h3>Sites</h3>
	    <div>
        <ul role="menu">
          <li><a class="ext" target="_blank" href="http://support.axoniq.io/">Customer Support Portal</a></li>
          <li><a class="ext" target="_blank" href="https://academy.axoniq.io/">AxonIQ Academy</a></li>
          <li><a class="ext" target="_blank" href="https://console.axoniq.io/">AxonIQ Console</a></li>
          <li><a class="ext" target="_blank" href="https://discuss.axoniq.io/">AxonIQ Discuss</a></li>
        </ul>
      </div>
    </div>

    <div class="footer-menu">
	    <h3>Follow us</h3>
	    <div>
        <ul role="menu">
          <li><a class="ext" target="_blank" href="https://www.youtube.com/axoniq">YouTube</a></li>
          <li><a class="ext" target="_blank" href="https://www.linkedin.com/company/axoniq">LinkedIn</a></li>
          <li><a class="ext" target="_blank" href="https://github.com/AxonIQ">GitHub</a></li>
          <li><a class="ext" target="_blank" href="https://axoniq.bsky.social/">Bluesky</a></li>
        </ul>
      </div>
    </div>

    <div class="footer-menu">
	    <h3>&nbsp;</h3>
	    <div>
        <ul role="menu">
          <li><a class="ext" target="_blank" href="https://www.instagram.com/axoniq/">Instagram</a></li>
          <li><a class="ext" target="_blank" href="https://www.facebook.com/AxonIQ.io">Facebook</a></li>
          <li><a class="ext" target="_blank" href="https://twitter.com/axon_iq">Twitter</a></li>
          <li><a class="ext" target="_blank" href="https://medium.com/axoniq">Medium</a></li>
        </ul>
      </div>
    </div>

  </div>
</footer>
<script id="site-script" src="../../_/js/site.js" data-ui-root-path="../../_"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
<script async src="../../_/js/vendor/page-actions.js"></script>
<script async src="../../_/js/vendor/tabs.js" data-sync-storage-key="preferred-tab" data-sync-storage-scope="session"></script>
<script src="../../_/js/vendor/lunr.js"></script>
<script src="../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../.." data-snippet-length="100" data-stylesheet="../../_/css/search.css"></script>
<script async src="../../search-index.js"></script>
    </div>
  </body>
</html>
