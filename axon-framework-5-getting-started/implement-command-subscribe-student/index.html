<!DOCTYPE html>
<html lang="en">
  <head>
        <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Feature: Subscribe Student</title>
    <link rel="canonical" href="https://docs.axoniq.io/axon-framework-5-getting-started/implement-command-subscribe-student/">
    <link rel="prev" href="../implement-command-create-course/">
    <link rel="next" href="../configure-axon-server/">
    <meta name="generator" content="Antora 3.1.10">
    <link rel="stylesheet" href="../../_/css/site.css">
    <link rel="stylesheet" href="../../_/css/vendor/tabs.css">
    <link rel="icon" href="../../_/img/favicon.ico" sizes="32x32">
    <link rel="icon" href="../../_/img/icon.svg" type="image/svg+xml" media="(prefers-color-scheme: light)">
    <link rel="icon" href="../../_/img/icon-light.svg" type="image/svg+xml" media="(prefers-color-scheme: dark)">
    <link rel="apple-touch-icon" href="../../_/img/apple-touch-icon.png"><!-- 180×180 -->
    <link rel="manifest" href="../../_/static/manifest.webmanifest">
        <!-- Google Tag Manager -->
        <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer','GTM-5QD58ZB');</script>
        <!-- End Google Tag Manager -->

    <script>var uiRootPath = '../../_'</script>


  </head>
  <body class="article">
    <div class="header_container">
      <div class="banner">
    <a href="https://console.axoniq.io">Manage and monitor your Axon Framework applications and Axon Server environments. <span class="banner_button" target="_blank">Try AxonIQ Console</span></a>
</div>      
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5QD58ZB"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://docs.axoniq.io"><img src="../../_/img/logo-dark4x.png" class="header_logo" /></a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="../../home/basics/">Basics</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="../../home/guides/">Guides</a>
          <div class="navbar-dropdown card">
            <a class="navbar-item" href="../../home/guides/axon-framework">Axon Framework</a>
            <a class="navbar-item" href="../../home/guides/axon-server">Axon Server</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="../../home/reference/">Reference</a>
          <div class="navbar-dropdown card">
                <a class="navbar-item" href="../../axon-framework-reference/4.11/">Axon Framework</a>
                <a class="navbar-item" href="../../axon-framework-extensions/">Axon Framework Extensions</a>
                <a class="navbar-item" href="../../axon-server-reference/v2025.1/">Axon Server</a>
                <a class="navbar-item" href="../../synapse-reference/v0.12/">Axon Synapse</a>
                <a class="navbar-item" href="../../axoniq-console-reference/">AxonIQ Console</a>
          </div>
        </div>
      </div>
      <div class="navbar-end">
        <div class="navbar-item search hide-for-print">
          <div id="search-field" class="field">
            <input id="search-input" type="text" placeholder="Search AxonIQ Docs">
          </div>
        </div>
        <a class="navbar-item navbar-button" href="https://academy.axoniq.io" target="_blank">AxonIQ Academy</a>
        <a class="navbar-item navbar-button" href="https://discuss.axoniq.io" target="_blank">AxonIQ Discuss</a>
        <a class="navbar-item navbar-button" href="https://axoniq.io/contact" target="_blank">Get in touch</a>
      </div>
    </div>
  </nav>
</header>
      <div class="toolbar card" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../home/" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../">Getting Started with Axon Framework 5 </a></li>
    <li><a href="./">Feature: Subscribe Student</a></li>
  </ul>
</nav>
<div class="page-actions">
  <button class="actions-menu-toggle" title="Show actions related to this page">Actions</button>
  <div class="actions-menu toolbar_dropdown_menu card">
      <a class="action item" href="https://github.com/AxonFramework/AxonFramework/edit/main/docs/af5-getting-started/modules/ROOT/pages/implement-command-subscribe-student.adoc">Edit this Page</a>
    
    <a class="action item" href="https://discuss.axoniq.io/search?q&#x3D;Feature%3A%20Subscribe%20Student" target="discuss_search">View Discussions</a>
    <a class="action item" href="https://discuss.axoniq.io/new-topic?category&#x3D;library&amp;title&#x3D;%22Feature%3A%20Subscribe%20Student%22%20Discussion&amp;body&#x3D;%3C!--%20Replace%20this%20comment%20with%20your%20comment%2Fsuggestion%2Fquestion%2F...%20--%3E%0A%0A%0A%3C!--%0AKeep%20the%20section%20below!%0ALinking%20back%20to%20the%20documentation%20URL%20not%20only%20helps%20people%20go%20to%20the%20page%0Abut%20also%20helps%20find%20relevant%20discussions%20from%20the%20documentation%20page%20via%20the%20%22View%20Discussion%22%20menu.%0A--%3E%0A%5Bdetails%3D%22Related%20library%20page%22%5D%0A%5BFeature%3A%20Subscribe%20Student%5D(https%3A%2F%2Fdocs.axoniq.io%2Faxon-framework-5-getting-started%2Fimplement-command-subscribe-student%2F)%0A%5B%2Fdetails%5D%0A" target="discuss_add">Start new discussion</a>
  </div>
</div>


</div>
    </div>
    <div class="content_container">
      <div class="body">
<div class="nav-container" data-component="axon-framework-5-getting-started" data-version="master">
    <aside class="nav card">
      <div class="panels">
        <div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../">Getting Started with Axon Framework 5</a></h3>

<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../">Introduction</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../sample-domain-event-modeling/">University Domain</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../project-structure/">Project Structure</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../implement-command-create-course/">Feature: Course Creation</a>
  </li>
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="./">Feature: Subscribe Student</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../configure-axon-server/">Connecting to Axon Server</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../implement-stateless-event-handler/">Feature: Send Notification When Student Subscribed</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../implement-stateful-event-handler/">Feature: Send Notification To The Administrator When All Courses Are Fully Booked</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../implement-read-model/">Feature: Build Course Statistics Read Model (Projection)</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
      </div>
    </aside>
</div>
<main class="article">
    <div class="page_content">
        <aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
          <article class="doc">
                <h1 class="page">Feature: Subscribe Student</h1>
            <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>One of the major benefits of Axon Framework 5&#8217;s Vertical Slice Architecture is the ability to implement features independently.
Now we&#8217;ll implement the <code>SubscribeStudentToCourse</code> feature without needing to implement every feature in between.
As long as we keep the <code>State</code> needed for command validation private to each slice, the only shared code between slices are the events, which serve as the backbone contract of our system.</p>
</div>
<div class="paragraph">
<p>You don&#8217;t even need to stick to certain order. How many times have you heard in the development team: "I&#8217;m waiting till the feature X is implemented, so I can implement my feature Y"?</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_define_messages"><a class="anchor" href="#_define_messages"></a>Define messages</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As before, let&#8217;s look at the Event Modeling diagram.
Which events do we need for this slice to fulfill the following Given-When-Then specification?</p>
</div>
<div class="imageblock">
<div class="content">
<img src="../_images/EventModeling_GWT_SubscribeStudent.png" alt="EventModeling GWT SubscribeStudent">
</div>
</div>
<div class="paragraph">
<p>In previous section we&#8217;ve defined the <code>CourseCreated</code> events, so there are two left from the specification.
Let&#8217;s define them as Java records, as before.</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/io/axoniq/demo/university/faculty/events/StudentSubscribedToCourse.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public record StudentEnrolledInFaculty(
        @EventTag <i class="conum" data-value="1"></i><b>(1)</b>
        StudentId studentId,
        String firstName,
        String lastName
) {

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Always remember about marking which properties are event tags.</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">src/main/java/io/axoniq/demo/university/faculty/events/StudentSubscribedToCourse.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public record StudentSubscribedToCourse(
        @EventTag <i class="conum" data-value="1"></i><b>(1)</b>
        StudentId studentId,
        @EventTag <i class="conum" data-value="1"></i><b>(1)</b>
        CourseId courseId
) {
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Thanks to those annotations the event will be tagged with <code>studentId</code> and <code>courseId</code>.
It&#8217;s a good example that StudentSubscribedToCourse event is connected to two business entities—Student and the Course.
When domain experts say that "student subscribed", they know that means the course free spots decreased. And, that the student subscription limit may have been reached.
In the case of one event type per entity/tag/aggregateId we would need to duplicate those events artificially to have two in two different streams.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Last, but not least, we define the <code>SubscribeStudentToCourse</code> command.</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/io/axoniq/demo/university/faculty/write/subscribestudent/SubscribeStudentToCourse.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public record SubscribeStudentToCourse(StudentId studentId, CourseId courseId) {
}</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_specification_by_example"><a class="anchor" href="#_specification_by_example"></a>Specification by example</h2>
<div class="sectionbody">
<div class="paragraph">
<p>As you remember from the previous section, we do not focus on entities but on behavior.
So we&#8217;re going to describe our feature in a Given-When-Then manner based on commands and events.
Let&#8217;s create the first test case using Axon Test Fixture.</p>
</div>
<div class="paragraph">
<p>We&#8217;re going to translate the Event Modeling specification, which you&#8217;ve seen on the top of the page plus other test cases for this slice, to the code.
We call it "Test First" as we don&#8217;t use TDD to design our application.
We do the design on the whiteboard using Event Modeling, which is faster and much less expensive than in the code.
From Event Modeling we can derive the test cases for specific slice (functionality) and translate them directly to the code.
The Axon Framework supports the Given-When-Then convention pretty well.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
Translating Event Modeling specification to test is a repeatable task, so it can be even done automatically with the help of AI.
</td>
</tr>
</table>
</div>
<div class="literalblock">
<div class="content">
<pre>The Subscribe Student feature has several business rules which you may derive from the Event Modeling Given-When-Then specifications:</pre>
</div>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>The student must be enrolled in the faculty.</p>
</li>
<li>
<p>The course must exist.</p>
</li>
<li>
<p>The student should not yet be subscribed to the course.</p>
</li>
<li>
<p>The student must not be subscribed to too many courses (limit: 3).</p>
</li>
<li>
<p>The course must not be at full capacity.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>Let&#8217;s create tests for these scenarios.</p>
</div>
<div class="listingblock">
<div class="title">src/test/java/io/axoniq/demo/university/faculty/write/subscribestudent/SubscribeStudentToCourseTest.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">class SubscribeStudentToCourseTest {

    private AxonTestFixture fixture;

    @BeforeEach
    void beforeEach() {
        var application = new UniversityAxonApplication();
        var sliceConfigurer = application.configurer(SubscribeStudentConfiguration::configure);
        fixture = AxonTestFixture.with(sliceConfigurer);
    }

    @AfterEach
    void afterEach() {
        fixture.stop();
    }

    @Test
    void successfulSubscription() {
        var courseId = CourseId.random();
        var studentId = StudentId.random();

        fixture.given()
                .event(new StudentEnrolledInFaculty(studentId, "Mateusz", "Nowak"))
                .event(new CourseCreated(courseId, "Axon Framework 5: Be a PRO", 2))
                .when()
                .command(new SubscribeStudentToCourse(studentId, courseId))
                .then()
                .events(new StudentSubscribedToCourse(studentId, courseId));
    }

    @Test
    void studentAlreadySubscribed() {
        var courseId = CourseId.random();
        var studentId = StudentId.random();

        fixture.given()
                .event(new StudentEnrolledInFaculty(studentId, "Allard", "Buijze"))
                .event(new CourseCreated(courseId, "Axon Framework 5: Be a PRO", 2))
                .event(new StudentSubscribedToCourse(studentId, courseId))
                .when()
                .command(new SubscribeStudentToCourse(studentId, courseId))
                .then()
                .exceptionSatisfies(thrown -&gt; assertThat(thrown)
                        .hasMessageContaining("Student already subscribed to this course")
                );
    }

    @Test
    void studentAlreadySubscribedAnotherCourse() {
        var courseId = CourseId.random();
        var anotherCourseId = CourseId.random();
        var studentId = StudentId.random();

        fixture.given()
                .event(new StudentEnrolledInFaculty(studentId, "Allard", "Buijze"))
                .event(new CourseCreated(courseId, "Axon Framework 5: Be a PRO", 2))
                .event(new StudentSubscribedToCourse(studentId, anotherCourseId))
                .when()
                .command(new SubscribeStudentToCourse(studentId, courseId))
                .then()
                .events(new StudentSubscribedToCourse(studentId, courseId));
    }

    @Test
    void studentSubscribedIfAnotherOneAlreadySubscribed() {
        var courseId = CourseId.random();
        var studentId = StudentId.random();
        var anotherStudentId = StudentId.random();

        fixture.given()
                .event(new StudentEnrolledInFaculty(studentId, "Allard", "Buijze"))
                .event(new StudentEnrolledInFaculty(anotherStudentId, "Marc", "Gathier"))
                .event(new CourseCreated(courseId, "Axon Framework 5: Be a PRO", 2))
                .event(new StudentSubscribedToCourse(anotherStudentId, courseId))
                .when()
                .command(new SubscribeStudentToCourse(studentId, courseId))
                .then()
                .events(new StudentSubscribedToCourse(studentId, courseId));
    }

    @Test
    void courseFullyBooked() {
        var courseId = CourseId.random();
        var student1Id = StudentId.random();
        var student2Id = StudentId.random();
        var student3Id = StudentId.random();

        fixture.given()
                .event(new StudentEnrolledInFaculty(student1Id, "Mateusz", "Nowak"))
                .event(new StudentEnrolledInFaculty(student2Id, "Steven", "van Beelen"))
                .event(new StudentEnrolledInFaculty(student3Id, "Mitchell", "Herrijgers"))
                .event(new CourseCreated(courseId, "Event Sourcing Masterclass", 2))
                .event(new StudentSubscribedToCourse(student1Id, courseId))
                .event(new StudentSubscribedToCourse(student2Id, courseId))
                .when()
                .command(new SubscribeStudentToCourse(student3Id, courseId))
                .then()
                .exceptionSatisfies(thrown -&gt; assertThat(thrown)
                        .hasMessageContaining("Course is fully booked")
                );
    }

    @Test
    void studentSubscribedToTooManyCourses() {
        var studentId = StudentId.random();
        var course1Id = CourseId.random();
        var course2Id = CourseId.random();
        var course3Id = CourseId.random();
        var targetCourseId = CourseId.random();

        fixture.given()
                .event(new StudentEnrolledInFaculty(studentId, "Milan", "Savic"))
                .event(new CourseCreated(targetCourseId, "Programming", 10))
                .event(new CourseCreated(course1Id, "Course 1", 10))
                .event(new CourseCreated(course2Id, "Course 2", 10))
                .event(new CourseCreated(course3Id, "Course 3", 10))
                .event(new StudentSubscribedToCourse(studentId, course1Id))
                .event(new StudentSubscribedToCourse(studentId, course2Id))
                .event(new StudentSubscribedToCourse(studentId, course3Id))
                .when()
                .command(new SubscribeStudentToCourse(studentId, targetCourseId))
                .then()
                .noEvents()
                .exceptionSatisfies(thrown -&gt; assertThat(thrown)
                        .hasMessageContaining("Student subscribed to too many courses")
                );
    }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>These tests demonstrate the behavior we want to implement, checking both successful and error cases.
For these tests we need to implement the command handler for <code>SubscribeStudentToCourse</code> command.
As you&#8217;ve seen before, for the behavior which is based on some state (so we have something in a Given phase of the test), we need to have State for our command handler to validate commands against it.
Let&#8217;s make it right away!</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/io/axoniq/demo/university/faculty/write/subscribestudent/SubscribeStudentToCourse.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">class SubscribeStudentToCourseCommandHandler {

    private static final int MAX_COURSES_PER_STUDENT = 3; <i class="conum" data-value="1"></i><b>(1)</b>

    @CommandHandler
    void handle(
            SubscribeStudentToCourse command,
            @InjectEntity State state, <i class="conum" data-value="2"></i><b>(2)</b>
            EventAppender eventAppender
    ) {
        var events = decide(command, state); <i class="conum" data-value="3"></i><b>(3)</b>
        eventAppender.append(events); <i class="conum" data-value="4"></i><b>(4)</b>
    }

    private List&lt;StudentSubscribedToCourse&gt; decide(SubscribeStudentToCourse command, State state) {
        // Check business rules implementation will be added in the following sections
        return List.of(new StudentSubscribedToCourse(command.studentId(), command.courseId()));
    }

    @EventSourcedEntity <i class="conum" data-value="5"></i><b>(5)</b>
    static class State {
        // State definition will be built incrementally in the following sections
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>For the sample simplicity, we hardcoded the maximum number of courses per student.
Each student can subscribe up to 3 courses at the same time.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We use <code>@InjectEntity</code> to inject the state object.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>This is your domain model invocation.
You may keep it in the command handler as on the example or make the function unaware of the infrastructure like Axon Framework.
This function resembles the <code>Decider</code> pattern.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>We use the <code>EventAppender</code> to stage events to be published after the successful command handling.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Before we defined a <code>tagKey</code> in <code>@EventSourcedEntity</code> annotation. Now we cannot do that, because we require events about every subscription of a student and every subscription to the course. So we have multiple business concepts related to a business process!
In a few paragraphs you will see how to do that with the <code>EventCriteria</code> API.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>We always need a single, unique identifier to load the state, because the <code>@InjectEntity</code> annotation needs to know how to identify the entity to load.
In this case it&#8217;s more challenging, because the <code>SubscribeStudentToCourse</code> business process is identified by the command type and also the <code>courseId</code> and <code>studentId</code>.
When you subscribe to the course and want to validate the business rules, you need to be aware of all the subscriptions for the given course and all subscriptions for the given student.
Hence, similar to traditional databases, we need to introduce a type for composite key to identify the entity.
We&#8217;re going to use the <code>SubscriptionId</code> class and define it as an <code>TargetEntityId</code> in the <code>SubscribeStudentToCourse</code> command.</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/io/axoniq/demo/university/faculty/write/subscribestudent/SubscriptionId.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">record SubscriptionId(CourseId courseId, StudentId studentId) {

}</code></pre>
</div>
</div>
<div class="listingblock">
<div class="title">src/main/java/io/axoniq/demo/university/faculty/write/subscribestudent/SubscribeStudentToCourse.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public record SubscribeStudentToCourse(StudentId studentId, CourseId courseId) {

    @TargetEntityId
    private SubscriptionId subscriptionId() { <i class="conum" data-value="1"></i><b>(1)</b>
        return new SubscriptionId(courseId, studentId);
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>@TargetEntityId</code> annotated method/property can even be  private, because it&#8217;s just for internal usage for the Axon Framework.
Based on the <code>SubscriptionId</code> we can load the events to build the <code>State</code> object.
We will use the value to define the <code>EventCriteria</code> later in this section.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>As you can see, there are two parts left to implement in the <code>SubscribeStudentToCourseCommandHandler</code> code.
Now we need to validate the business rules, and there are quite a few of them.
The student can subscribe to a course only if they adhere to the domain invariants of the operation.
We will list them along with the assertion function, as well as show what&#8217;s needed in the State object to validate them.</p>
</div>
<div class="paragraph">
<p><strong>Rule #1: The student is enrolled in the faculty </strong></p>
</div>
<div class="paragraph">
<p>When a student is enrolled in the faculty it has an assigned <code>StudentId</code>, so we add it to the State:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/io/axoniq/demo/university/faculty/write/subscribestudent/SubscribeStudentToCourse.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">class SubscribeStudentToCourseCommandHandler {

    // rest omitted for brevity

    @EventSourcedEntity
    static class State {

        private StudentId studentId;

        @EntityCreator
        public State() {
        }

        @EventSourcingHandler
        void evolve(StudentEnrolledInFaculty event) {
            this.studentId = event.studentId();
        }
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>In the business rule assertion function, we throw an exception if the rule is not satisfied.
This is a different approach from what we used in the <code>CreateCourse</code> feature, where we returned an empty list of events when a business rule was violated.
This error will bubble up as a result of the command to the client.</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/io/axoniq/demo/university/faculty/write/subscribestudent/SubscribeStudentToCourse.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">class SubscribeStudentToCourseCommandHandler {

    // rest omitted for brevity

    private void assertStudentEnrolledInFaculty(State state) {
        var studentId = state.studentId;
        if (studentId == null) {
            throw new RuntimeException("Student with given id never enrolled the faculty");
        }
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Rule #2: The course is created </strong>
<strong>Rule #3: The student is not already subscribed to the course </strong>
<strong>Rule #4: The student is not subscribed to too many courses (max 3) </strong>
<strong>Rule #5: The course is not fully booked (based on course capacity) </strong></p>
</div>
<div class="paragraph">
<p>We&#8217;re going to implement all the remaining rules at once.
What else do we need in the <code>State</code> object to validate them?
Definitely not the course name, because it has nothing to do with the business rules, so we don&#8217;t handle, even don&#8217;t load events like <code>CourseRenamed</code> in order to process the command.</p>
</div>
<div class="paragraph">
<p>What we&#8217;d like to introduce is the minimal set of data we needed to be able to accept or reject the command.
It&#8217;s the same rule of thumb that you use while designing DDD Aggregates.</p>
</div>
<div class="paragraph">
<p>So we are going to derive:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>for Student: <code>alreadySubscribed</code> and <code>noOfCoursesStudentSubscribed</code> from <code>StudentSubscribedToCourse</code> and <code>StudentUnsubscribedFromCourse</code> events.</p>
</li>
<li>
<p>for Course: <code>courseCapacity</code> and <code>noOfStudentsSubscribedToCourse</code> from <code>CourseCreated</code>, <code>CourseCapacityChanged</code>, <code>StudentSubscribedToCourse</code> and <code>StudentUnsubscribedFromCourse</code> events.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="title">src/main/java/io/axoniq/demo/university/faculty/write/subscribestudent/SubscribeStudentToCourse.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">class SubscribeStudentToCourseCommandHandler {

    // rest omitted for brevity

    @EventSourcedEntity
    static class State {

        private CourseId courseId;
        private int courseCapacity = 0;
        private int noOfStudentsSubscribedToCourse = 0;

        private StudentId studentId;
        private int noOfCoursesStudentSubscribed = 0;
        private boolean alreadySubscribed = false;

        @EntityCreator
        public State() {
        }

        // other handlers added previously omitted for brevity

        @EventSourcingHandler
        void evolve(CourseCreated event) { <i class="conum" data-value="1"></i><b>(1)</b>
            this.courseId = event.courseId();
            this.courseCapacity = event.capacity();
        }

        @EventSourcingHandler
        void evolve(CourseCapacityChanged event) { <i class="conum" data-value="2"></i><b>(2)</b>
            this.courseCapacity = event.capacity();
        }

        @EventSourcingHandler
        void evolve(StudentSubscribedToCourse event) { <i class="conum" data-value="3"></i><b>(3)</b>
            var subscribingStudentId = event.studentId();
            var subscribedCourseId = event.courseId();
            if (subscribedCourseId.equals(courseId)) { <i class="conum" data-value="4"></i><b>(4)</b>
                noOfStudentsSubscribedToCourse++;
            }
            if (subscribingStudentId.equals(studentId)) { <i class="conum" data-value="5"></i><b>(5)</b>
                noOfCoursesStudentSubscribed++;
            }
            if (subscribingStudentId.equals(studentId) &amp;&amp; subscribedCourseId.equals(courseId)) { <i class="conum" data-value="6"></i><b>(6)</b>
                alreadySubscribed = true;
            }
        }

        @EventSourcingHandler
        void evolve(StudentUnsubscribedFromCourse event) { <i class="conum" data-value="7"></i><b>(7)</b>
            var subscribingStudentId = event.studentId();
            var subscribedCourseId = event.courseId();
            if(subscribedCourseId.equals(courseId)) {
                noOfStudentsSubscribedToCourse--;
            }
            if (subscribingStudentId.equals(studentId)) {
                noOfCoursesStudentSubscribed--;
            }
            if (subscribingStudentId.equals(studentId) &amp;&amp; subscribedCourseId.equals(courseId)) {
                alreadySubscribed = false;
            }
        }
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Same as with a student, we store the <code>courseId</code>, along with the <code>capacity</code>, from the <code>CourseCreated</code> event.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>We update the <code>capacity</code> on <code>CourseCapacityChanged</code> event.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>In this case, we&#8217;re going to evolve the State on every StudentSubscribed event related to the course or the student whose IDs are in the command. How we instruct the store to load those events will be discussed in the next paragraph.
For now, you need to be aware that you may receive events about different students and different courses. This happens because we have one event handler per event type. The handler processes all <code>StudentSubscribed</code>/<code>StudentUnsubscribed</code> events for:
<div class="ulist">
<ul>
<li>
<p>A given course (involving different students) to track how much capacity remains.</p>
</li>
<li>
<p>A given student (involving different courses) to track how many courses the student is subscribed to.</p>
</li>
</ul>
</div></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>If the <code>StudentSubscribedToCourse</code> event is related to the course, we increase the number of students subscribed to the course.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>If the <code>StudentSubscribedToCourse</code> event is related to the student, we increase the number of courses the student is subscribed to.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>If the <code>StudentSubscribedToCourse</code> event is related to the course and the student, we set the <code>alreadySubscribed</code> flag to true.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>The handler for the <code>StudentUnsubscribedFromCourse</code> event is an exact opposite of the <code>evolve</code> method for <code>StudentSubscribedToCourse</code> event. We decrease the numbers that we increased in the previous one.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>How do we ensure that we won&#8217;t load events for every student and every course?
How do we limit our Consistency Boundary to only what is really needed to validate business rules?
This is where the <code>EventCriteria</code> comes into play.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_event_criteria"><a class="anchor" href="#_event_criteria"></a>Event criteria</h2>
<div class="sectionbody">
<div class="paragraph">
<p>While implementing the <code>CreateCourse</code> feature, we defined that we want to build our state based on events that are tagged with <code>courseId</code> by using <code>@EventSourcedEntity(tagKey = "courseId")</code>.
For the <code>SubscribeStudentToCourse</code> handling, this is not enough, because, as you already know, we need to build our state based on both <code>studentId</code> and <code>courseId</code> tagged events.
We need all <code>StudentSubscribedToCourse</code> events for the given <code>courseId</code> and also all <code>StudentSubscribedToCourse</code> events for the given <code>studentId</code>.
The same applies to <code>StudentUnsubscribedFromCourse</code> events.</p>
</div>
<div class="paragraph">
<p>Whereas, for example, with <code>StudentEnrolledInFaculty</code> - we care about just one event for the given <code>studentId</code>; other students are not involved while processing this command, and there are no business rules between them.
The subscription story is different, because we have a limit of students per course and also a limit of courses per student.</p>
</div>
<div class="paragraph">
<p>Thanks to the Axon Framework&#8217;s <code>EventCriteria</code> concept, we&#8217;re able to define the events we&#8217;d like to load dynamically.
This is where the Dynamic Consistency Boundary shines.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>For Axon Framework 4 users:
Before we had to load all events for the given aggregate (from the event stream). We were defining the "tag" of events by using the <code>@TargetAggregateIdentifier</code> annotation.
Since Axon Framework 5, we can load events that are relevant for the given command using custom criteria (you choose event types and tags).
You may think about it as follows: before, an event could have just one tag—the aggregateId. Now we can have multiple tags for any given event!</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Here the situation is a bit more complicated, because we need to load events for two different entities - <code>Student</code> and <code>Course</code>. In a system based on Aggregates, you have two options.
You may load both entities and limit your accessibility, but this increases the risk of optimistic concurrency. Alternatively, you could implement a complex saga to orchestrate changes between those two entities. With this approach, you would need to duplicate the events and deal with eventual consistency.
Whereas in the domain experts' language, <code>StudentSubscribedToCourse</code> is just one fact, which influences rules around both <code>Student</code> and <code>Course</code>.</p>
</div>
<div class="paragraph">
<p>As long as we&#8217;re in a single bounded context and have all events in one storage, we can define our custom <code>EventCriteria</code> to shape our <code>State</code>, mixing properties from both <code>Student</code> and <code>Course</code>!
The operation will be also immediately consistent and transactional.
If while executing the command, any event matching the same <code>EventCriteria</code> is stored, the operation will fail with an optimistic concurrency exception.
The single responsibility of the <code>State</code> is just to give us enough information to determine if the command satisfies business rules.</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/io/axoniq/demo/university/faculty/write/subscribestudent/SubscribeStudentToCourse.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">class SubscribeStudentToCourseCommandHandler {

    // rest omitted for brevity

    @EventSourcedEntity
    static class State {

        // rest omitted for brevity

        @EventCriteriaBuilder <i class="conum" data-value="1"></i><b>(1)</b>
        private static EventCriteria resolveCriteria(SubscriptionId id) { <i class="conum" data-value="2"></i><b>(2)</b>
            var courseId = id.courseId().toString();
            var studentId = id.studentId().toString();
            return EventCriteria.either(
                    EventCriteria
                            .havingTags(Tag.of(FacultyTags.COURSE_ID, courseId)) <i class="conum" data-value="3"></i><b>(3)</b>
                            .andBeingOneOfTypes(
                                    CourseCreated.class.getName(),
                                    CourseCapacityChanged.class.getName(),
                                    StudentSubscribedToCourse.class.getName(),
                                    StudentUnsubscribedFromCourse.class.getName()
                            ),
                    EventCriteria
                            .havingTags(Tag.of(FacultyTags.STUDENT_ID, studentId))
                            .andBeingOneOfTypes(
                                    StudentEnrolledInFaculty.class.getName(),
                                    StudentSubscribedToCourse.class.getName(),
                                    StudentUnsubscribedFromCourse.class.getName()
                            )
            );
        }

    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The <code>@EventCriteriaBuilder</code> annotation marks the method as a criteria builder for the given entity. It gives you more flexibility than just using <code>tagKey</code> property on the <code>@EventSourcedEntity</code> annotation.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Thanks to the <code>SubscriptionId</code>, which is composed of <code>courseId</code> and <code>studentId</code>, we know the values of those tags we needed.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>As you may see at the highest level that we combine <code>EventCriteria</code> with <code>either</code>. But, when we define tags through <code>havingTags</code>, it means that a certain type of event requires all of them (there is an OR relation between event types, an AND relation between tags and OR between criteria).
Hence, if we do <code>.havingTags(Tag.of("courseId", courseId), Tag.of("studentId", studentId))</code> we will only receive subscription events of the given student for one given course.
This is not what we want here.
So, we split <code>StudentSubscribedToCourse</code> and <code>StudentUnsubscribedFromCourse</code> events into two separate criteria (one for student and one for course), because we need to load all events of those types for either <code>courseId</code> or <code>studentId</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>It gives us better accessibility of our system - thanks to that, as you see there is no <code>CourseRenamed</code> event in our criteria, so the Faculty administrator is still able to rename the course in the same time while processing the <code>SubscribeStudentToCourse</code> command. Because the <code>CourseRenamed</code> event doesn&#8217;t match the criteria, it&#8217;s not in our operation&#8217;s consistency boundary.
In case of Aggregates, these operations may clash, or you need to introduce a separate entity for the name to avoid concurrency access issues.
Our colleague Milan from AxonIQ (with our ex-colleague Sara) discuss those scenarios in the talk—we really encourage you to watch it <a href="https://www.youtube.com/watch?v=IgigmuHHchI">The Aggregate is dead. Long live the Aggregate! by Sara Pellegrini &amp; Milan Savic @ Spring I/O 2023</a>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Keep in mind it&#8217;s beneficial to define events types in the criteria.
Technically you can just use <code>EventCriteria.havingTags(Tag.of("courseId", courseId), Tag.of("studentId", studentId))</code> and load all events for the given tags.
But in this case, you load more than needed, and it&#8217;s possible to clash with other changes, which cause events that do not influence these certain business rules.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_summing_up"><a class="anchor" href="#_summing_up"></a>Summing up</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let&#8217;s summarize what we have done so far.
We&#8217;ve implemented the whole <code>SubscribeStudentToCourse</code> command handler using the DCB concept in practice.
It was easier than you expected, right?
If you&#8217;re not sure if you followed the tutorial correctly, you can always check the code in the repository. The command handler code is here <a href="https://github.com/AxonIQ/university-demo/blob/master/src/main/java/io/axoniq/demo/university/faculty/write/subscribestudent/SubscribeStudentToCourseCommandHandler.java">SubscribeStudentToCourseCommandHandler</a>.
If you prefer to use a different style (with multiple state classes - like <code>Course</code> and <code>Student</code> instead of just one) you may also compare it with the solution we have done in the <a href="https://github.com/AxonIQ/university-demo/tree/master/src/main/java/io/axoniq/demo/university/faculty/write/subscribestudentmulti">subscribestudentmulti</a> package.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_configuration"><a class="anchor" href="#_configuration"></a>Configuration</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Same as before, to make our tests green, the last thing to do is to configure the required infrastructure for the command handler.
To do so, let&#8217;s create a new class <code>SubscribeStudentToCourseConfiguration</code> with the following content.</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/io/axoniq/demo/university/faculty/write/createcourse/CreateCourseConfiguration.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class SubscribeStudentConfiguration {

    public static EventSourcingConfigurer configure(EventSourcingConfigurer configurer) {
        var stateEntity = EventSourcedEntityModule
                .annotated(SubscriptionId.class, SubscribeStudentToCourseCommandHandler.State.class);
        var commandHandlingModule = CommandHandlingModule
                .named("SubscribeStudent")
                .commandHandlers()
                .annotatedCommandHandlingComponent(c -&gt; new SubscribeStudentToCourseCommandHandler());
        return configurer
                .registerEntity(stateEntity)
                .registerCommandHandlingModule(commandHandlingModule);
    }

}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now we need to register the configuration in the <code>UniversityAxonApplication</code> class as follows.</p>
</div>
<div class="listingblock">
<div class="title">/src/main/java/io/axoniq/demo/university/UniversityAxonApplication.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class UniversityAxonApplication {

     public static ApplicationConfigurer configurer() {
        return configurer(c -&gt; {
            CreateCourseConfiguration.configure(c);
            SubscribeStudentConfiguration.configure(c);  <i class="conum" data-value="1"></i><b>(1)</b>
        });
    }

    // rest omitted for brevity

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>We register the <code>SubscribeStudentConfiguration</code> as a child of the <code>EventSourcingConfigurer</code>.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Now what&#8217;s better for a developer than seeing the green bar flash in your IDE after running the tests?
Let&#8217;s do it! Remember to mark the slice as completed in the Event Modeling diagram if you use this approach.</p>
</div>
</div>
</div>
        <nav class="pagination">
  <span class="prev"><a href="../implement-command-create-course/">Feature: Course Creation</a></span>
  <span class="next"><a href="../configure-axon-server/">Connecting to Axon Server</a></span>
</nav>
    </article>
  </div>
</main>
</div>
      <footer class="footer">
  <div class="primary-footer">
    <div class="footer-logo ">
      <a href="https://axoniq.io/">
        <img src="https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=90&amp;height=20&amp;name=Logo%20AxonIQ%20(2).png" alt="Logo AxonIQ" loading="lazy" srcset="https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=45&amp;height=10&amp;name=Logo%20AxonIQ%20(2).png 45w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=90&amp;height=20&amp;name=Logo%20AxonIQ%20(2).png 90w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=135&amp;height=30&amp;name=Logo%20AxonIQ%20(2).png 135w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=180&amp;height=40&amp;name=Logo%20AxonIQ%20(2).png 180w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=225&amp;height=50&amp;name=Logo%20AxonIQ%20(2).png 225w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=270&amp;height=60&amp;name=Logo%20AxonIQ%20(2).png 270w" sizes="(max-width: 90px) 100vw, 90px" width="90" height="20">
      </a>
    </div>

    <div class="footer-menu">
	    <h3>Products</h3>
	    <div>
        <ul role="menu">
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/products/axon-framework">Axon Framework</a></li>
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/products/axon-server">Axon Server</a></li>
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/products/axoniq-console">AxonIQ Console</a></li>
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/blog/protect-sensitive-data-in-an-event-sourced-application">AxonIQ Data Protection</a></li>
        </ul>
      </div>
    </div>

    <div class="footer-menu">
	    <h3>Sites</h3>
	    <div>
        <ul role="menu">
          <li><a class="ext" target="_blank" href="http://support.axoniq.io/">Customer Support Portal</a></li>
          <li><a class="ext" target="_blank" href="https://academy.axoniq.io/">AxonIQ Academy</a></li>
          <li><a class="ext" target="_blank" href="https://console.axoniq.io/">AxonIQ Console</a></li>
          <li><a class="ext" target="_blank" href="https://discuss.axoniq.io/">AxonIQ Discuss</a></li>
        </ul>
      </div>
    </div>

    <div class="footer-menu">
	    <h3>Follow us</h3>
	    <div>
        <ul role="menu">
          <li><a class="ext" target="_blank" href="https://www.youtube.com/axoniq">YouTube</a></li>
          <li><a class="ext" target="_blank" href="https://www.linkedin.com/company/axoniq">LinkedIn</a></li>
          <li><a class="ext" target="_blank" href="https://github.com/AxonIQ">GitHub</a></li>
          <li><a class="ext" target="_blank" href="https://axoniq.bsky.social/">Bluesky</a></li>
        </ul>
      </div>
    </div>

    <div class="footer-menu">
	    <h3>&nbsp;</h3>
	    <div>
        <ul role="menu">
          <li><a class="ext" target="_blank" href="https://www.instagram.com/axoniq/">Instagram</a></li>
          <li><a class="ext" target="_blank" href="https://www.facebook.com/AxonIQ.io">Facebook</a></li>
          <li><a class="ext" target="_blank" href="https://twitter.com/axon_iq">Twitter</a></li>
          <li><a class="ext" target="_blank" href="https://medium.com/axoniq">Medium</a></li>
        </ul>
      </div>
    </div>

  </div>
</footer>
<script id="site-script" src="../../_/js/site.js" data-ui-root-path="../../_"></script>
<script async src="../../_/js/vendor/highlight.js"></script>
<script async src="../../_/js/vendor/page-actions.js"></script>
<script async src="../../_/js/vendor/tabs.js" data-sync-storage-key="preferred-tab" data-sync-storage-scope="session"></script>
<script src="../../_/js/vendor/lunr.js"></script>
<script src="../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../.." data-snippet-length="100" data-stylesheet="../../_/css/search.css"></script>
<script async src="../../search-index.js"></script>
    </div>
  </body>
</html>
