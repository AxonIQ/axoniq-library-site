<!DOCTYPE html>
<html lang="en">
  <head>
        <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Feature: Send Notification To The Administrator When All Courses Are Fully Booked</title>
    <link rel="canonical" href="https://docs.axoniq.io/axon-framework-5-getting-started/implement-stateful-event-handler/">
    <meta name="generator" content="Antora 3.1.10">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <link rel="stylesheet" href="../../../_/css/vendor/tabs.css">
    <link rel="icon" href="../../../_/img/favicon.png" sizes="32x32">
    <link rel="apple-touch-icon" href="../../../_/img/favicon.png"><!-- 180×180 -->
    <link rel="manifest" href="../../../_/static/manifest.webmanifest">

        <!-- Google Tag Manager -->
        <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer','GTM-5QD58ZB');</script>
        <!-- End Google Tag Manager -->

    <script>var uiRootPath = '../../../_'</script>


<link rel="icon" href="../../../_/img/favicon.png" type="image/png">
  </head>
  <body class="article">
    <div class="header_container">
      
    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5QD58ZB"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://docs.axoniq.io">
        <img src="../../../_/img/docs-logo.png" class="header_logo"/>
      </a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-center">
        <a class="navbar-item" href="../../../home/basics/">Basics</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="../../../home/guides/">Guides</a>
          <div class="navbar-dropdown card">
            <a class="navbar-item" href="../../../home/guides/axon-framework">Axon Framework</a>
            <a class="navbar-item" href="../../../home/guides/axon-server">Axon Server</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="../../../home/reference/">Reference</a>
          <div class="navbar-dropdown card">
                <a class="navbar-item" href="../../../axon-framework-reference/5.0/">Axon Framework</a>
                <a class="navbar-item" href="../../../axon-framework-extensions/">Axon Framework Extensions</a>
                <a class="navbar-item" href="../../../axon-server-reference/development/">Axon Server</a>
                <a class="navbar-item" href="../../../synapse-reference/v0.12/">Axon Synapse</a>
                <a class="navbar-item" href="../../../axoniq-platform-reference/">Axoniq Platform</a>
          </div>
        </div>
      </div>
      <div class="navbar-end">
          <div class="navbar-item search hide-for-print">
            <div id="search-field" class="field">
              <input id="search-input" type="text" placeholder="Search AxonIQ Docs">
            </div>
          </div>
        <a class="navbar-item navbar-button" href="https://platform.axoniq.io" target="_blank">Axoniq Platform</a>
      </div>
    </div>
  </nav>
</header>
      <div class="toolbar card" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../home/" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
</nav>
<div class="page-actions">
  <button class="actions-menu-toggle" title="Show actions related to this page">Actions</button>
  <div class="actions-menu toolbar_dropdown_menu card">
      <a class="action item" href="https://github.com/AxonFramework/AxonFramework/edit/main/docs/af5-getting-started/modules/ROOT/pages/implement-stateful-event-handler.adoc">Edit this Page</a>
    
    <a class="action item" href="https://discuss.axoniq.io/search?q&#x3D;Feature%3A%20Send%20Notification%20To%20The%20Administrator%20When%20All%20Courses%20Are%20Fully%20Booked" target="discuss_search">View Discussions</a>
    <a class="action item" href="https://discuss.axoniq.io/new-topic?category&#x3D;library&amp;title&#x3D;%22Feature%3A%20Send%20Notification%20To%20The%20Administrator%20When%20All%20Courses%20Are%20Fully%20Booked%22%20Discussion&amp;body&#x3D;%3C!--%20Replace%20this%20comment%20with%20your%20comment%2Fsuggestion%2Fquestion%2F...%20--%3E%0A%0A%0A%3C!--%0AKeep%20the%20section%20below!%0ALinking%20back%20to%20the%20documentation%20URL%20not%20only%20helps%20people%20go%20to%20the%20page%0Abut%20also%20helps%20find%20relevant%20discussions%20from%20the%20documentation%20page%20via%20the%20%22View%20Discussion%22%20menu.%0A--%3E%0A%5Bdetails%3D%22Related%20library%20page%22%5D%0A%5BFeature%3A%20Send%20Notification%20To%20The%20Administrator%20When%20All%20Courses%20Are%20Fully%20Booked%5D(https%3A%2F%2Fdocs.axoniq.io%2Faxon-framework-5-getting-started%2Fmain%2Fimplement-stateful-event-handler%2F)%0A%5B%2Fdetails%5D%0A" target="discuss_add">Start new discussion</a>
  </div>
</div>


<div class="page-versions">
  <button class="version-menu-toggle" title="Show other versions of page">main</button>
  <div class="version-menu toolbar_dropdown_menu card">
    <a class="version item" href="../../implement-stateful-event-handler/">master</a>
    <a class="version item is-current" href="./">main</a>
  </div>
</div>
</div>
    </div>
    <div class="content_container">
      <div class="body">
<div class="nav-container" data-component="axon-framework-5-getting-started" data-version="main">
</div>
<main class="article">
    <div class="page_content">
        <aside class="toc sidebar" data-title="Page content" data-levels="2">
  <div class="toc-menu"></div>
</aside>
          <article class="doc">
                <h1 class="page">Feature: Send Notification To The Administrator When All Courses Are Fully Booked</h1>
            <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>In this example, we will implement a stateful event handler that monitors course availability and sends a notification to the administrator when all courses become fully booked.
This enables administrators to take immediate action such as opening additional course sections, adjusting capacity, or coordinating with other faculties to meet student demand.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_what_is_a_stateful_event_handler"><a class="anchor" href="#_what_is_a_stateful_event_handler"></a>What is a stateful event handler?</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A stateful event handler is a component that reacts to events while maintaining internal state between event processing.
Unlike stateless handlers that simply perform actions in response to single events, stateful handlers accumulate information from multiple events to make decisions.</p>
</div>
<div class="paragraph">
<p>Common use cases for stateful event handlers include:
- Building read models and projections, like dashboards or reprorting views
- Triggering actions when conditions are met across time, like in Saga or Process Manager</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_understanding_the_administrator_notification_feature"><a class="anchor" href="#_understanding_the_administrator_notification_feature"></a>Understanding the administrator notification feature</h2>
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="../_images/EventModeling_WhenAllCoursesFullyBookedThenSendNotification.jpg" alt="EventModeling WhenAllCoursesFullyBookedThenSendNotification">
</div>
</div>
<div class="paragraph">
<p>The diagram shows an Event Modeling flow with an <strong>Automation pattern</strong>. The gear symbol (⚙️) represents an automated process that monitors the system state and triggers actions when conditions are met. In Event Modeling terminology, this automation works like a "todo list that a process goes and does and marks items as done" - it continuously evaluates whether all courses are fully booked and sends notifications when needed.
The stateful handler implements this automation pattern by monitoring multiple events to determine when all courses are fully booked, then triggering the notification to the administrator.</p>
</div>
<div class="paragraph">
<p>This is a perfect example of a stateful operation because:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><strong>State tracking required</strong> - We need to monitor capacity and enrollment across all courses</p>
</li>
<li>
<p><strong>Multiple event types</strong> - We react to course creation, capacity changes, and student subscriptions</p>
</li>
<li>
<p><strong>Conditional logic</strong> - Notification is sent only when all courses are fully booked</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_setting_up_the_stateful_event_handler"><a class="anchor" href="#_setting_up_the_stateful_event_handler"></a>Setting up the stateful event handler</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We&#8217;ll build upon the notification infrastructure from the previous tutorial, so make sure you have the <code>NotificationService</code> configured.</p>
</div>
<div class="sect2">
<h3 id="_step_1_define_the_command_and_event"><a class="anchor" href="#_step_1_define_the_command_and_event"></a>Step 1: Define the command and event</h3>
<div class="paragraph">
<p>First, let&#8217;s define the command that will be sent internally and the event that tracks notification status:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/io/axoniq/demo/university/faculty/automation/allcoursesfullybookednotifier/SendAllCoursesFullyBookedNotification.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public record SendAllCoursesFullyBookedNotification(String facultyId) { <i class="conum" data-value="1"></i><b>(1)</b>
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Simple command to trigger the notification sending - contains faculty ID for targeting</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">src/main/java/io/axoniq/demo/university/faculty/events/AllCoursesFullyBookedNotificationSent.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public record AllCoursesFullyBookedNotificationSent( <i class="conum" data-value="1"></i><b>(1)</b>
        @EventTag(key = FacultyTags.FACULTY_ID) <i class="conum" data-value="2"></i><b>(2)</b>
        String facultyId
) {
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Event indicating that the notification has been sent</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Tagged with faculty ID for proper event stream organization</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_step_2_implement_the_stateful_event_handler"><a class="anchor" href="#_step_2_implement_the_stateful_event_handler"></a>Step 2: Implement the stateful event handler</h3>
<div class="paragraph">
<p>Now let&#8217;s create the main stateful event handler with its internal state management:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/io/axoniq/demo/university/faculty/automation/allcoursesfullybookednotifier/WhenAllCoursesFullyBookedThenSendNotification.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class WhenAllCoursesFullyBookedThenSendNotification {

    private static final String FACULTY_ID = "ONLY_FACULTY_ID"; <i class="conum" data-value="1"></i><b>(1)</b>

    @EventSourcedEntity <i class="conum" data-value="2"></i><b>(2)</b>
    record State(Map&lt;CourseId, Course&gt; courses, boolean notified) {

        record Course(int capacity, int students) { <i class="conum" data-value="3"></i><b>(3)</b>

            Course capacity(int newCapacity) {
                return new Course(newCapacity, this.students);
            }

            Course studentSubscribed() {
                return new Course(this.capacity, this.students + 1);
            }

            Course studentUnsubscribed() {
                return new Course(this.capacity, this.students - 1);
            }

            boolean isFullyBooked() { <i class="conum" data-value="4"></i><b>(4)</b>
                return students &gt;= capacity;
            }
        }

        @EntityCreator <i class="conum" data-value="5"></i><b>(5)</b>
        State() {
            this(new HashMap&lt;&gt;(), false);
        }

        @EventSourcingHandler <i class="conum" data-value="6"></i><b>(6)</b>
        State evolve(CourseCreated event) {
            courses.put(event.courseId(), new Course(event.capacity(), 0));
            return new State(courses, notified);
        }

        @EventSourcingHandler
        State evolve(CourseCapacityChanged event) {
            courses.computeIfPresent(event.courseId(), (id, course) -&gt; course.capacity(event.capacity()));
            return new State(courses, notified);
        }

        @EventSourcingHandler
        State evolve(StudentSubscribedToCourse event) {
            courses.computeIfPresent(event.courseId(), (id, course) -&gt; course.studentSubscribed());
            return new State(courses, notified);
        }

        @EventSourcingHandler
        State evolve(StudentUnsubscribedFromCourse event) {
            courses.computeIfPresent(event.courseId(), (id, course) -&gt; course.studentUnsubscribed());
            return new State(courses, notified);
        }

        @EventSourcingHandler
        State evolve(AllCoursesFullyBookedNotificationSent event) { <i class="conum" data-value="7"></i><b>(7)</b>
            return new State(courses, true);
        }
    }

    // Command and Event handlers will be added in next steps...
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Simplified to use a single faculty ID for this tutorial</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Event-sourced entity that maintains state across multiple events</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Inner record representing individual course state with capacity and current enrollment</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Business logic to determine if a course is fully booked</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Default constructor creating empty state</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Event sourcing handlers that evolve state based on different event types</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Handler to track when notification has already been sent - allows you to track it in your EventStore instead of external systems</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_step_3_add_command_handler_for_notification"><a class="anchor" href="#_step_3_add_command_handler_for_notification"></a>Step 3: Add command handler for notification</h3>
<div class="paragraph">
<p>Now let&#8217;s add the command handler that actually sends the notification:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/io/axoniq/demo/university/faculty/automation/allcoursesfullybookednotifier/WhenAllCoursesFullyBookedThenSendNotification.java (continued)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    static class AutomationCommandHandler { <i class="conum" data-value="1"></i><b>(1)</b>

        @CommandHandler
        public void decide(
                SendAllCoursesFullyBookedNotification command,
                @InjectEntity(idProperty = FacultyTags.FACULTY_ID) State state, <i class="conum" data-value="2"></i><b>(2)</b>
                ProcessingContext context
        ) {
            var canNotify = state != null &amp;&amp; !state.notified(); <i class="conum" data-value="3"></i><b>(3)</b>
            if (canNotify) {
                var notification = new NotificationService.Notification("admin", "All courses are fully booked now."); <i class="conum" data-value="4"></i><b>(4)</b>
                context.component(NotificationService.class).sendNotification(notification);
                var eventAppender = EventAppender.forContext(context); <i class="conum" data-value="5"></i><b>(5)</b>
                eventAppender.append(new AllCoursesFullyBookedNotificationSent(command.facultyId()));
            }
        }
    }</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Internal command handler class for better organization</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Inject the current state to check if we can send notification</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Only send if we haven&#8217;t notified already</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Create and send the notification to admin</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Record that we&#8217;ve sent the notification by emitting an event</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_step_4_add_event_handlers_for_state_monitoring"><a class="anchor" href="#_step_4_add_event_handlers_for_state_monitoring"></a>Step 4: Add event handlers for state monitoring</h3>
<div class="paragraph">
<p>Finally, let&#8217;s add event handlers that monitor course state changes and trigger notifications:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/io/axoniq/demo/university/faculty/automation/allcoursesfullybookednotifier/WhenAllCoursesFullyBookedThenSendNotification.java (continued)</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">    static class AutomationEventHandler { <i class="conum" data-value="1"></i><b>(1)</b>

        CompletableFuture&lt;?&gt; react(
                StudentSubscribedToCourse event, <i class="conum" data-value="2"></i><b>(2)</b>
                CommandDispatcher commandDispatcher,
                ProcessingContext context
        ) {
            var state = context.component(StateManager.class).loadEntity(State.class, FACULTY_ID, context).join(); <i class="conum" data-value="3"></i><b>(3)</b>
            return sendNotificationIfAllCoursesFullyBooked(state, commandDispatcher);
        }

        @EventHandler
        CompletableFuture&lt;?&gt; react(
                CourseCapacityChanged event, <i class="conum" data-value="4"></i><b>(4)</b>
                CommandDispatcher commandDispatcher,
                ProcessingContext context
        ) {
            var state = context.component(StateManager.class).loadEntity(State.class, FACULTY_ID, context).join();
            return sendNotificationIfAllCoursesFullyBooked(state, commandDispatcher);
        }

        private CompletableFuture&lt;?&gt; sendNotificationIfAllCoursesFullyBooked( <i class="conum" data-value="5"></i><b>(5)</b>
                State state,
                CommandDispatcher commandDispatcher
        ) {
            var automationState = state != null ? state : new State();
            var allCoursesFullyBooked = automationState.courses.values().stream().allMatch(State.Course::isFullyBooked); <i class="conum" data-value="6"></i><b>(6)</b>
            var shouldNotify = allCoursesFullyBooked &amp;amp;&amp;amp; !automationState.notified();  <i class="conum" data-value="7"></i><b>(7)</b>
            if (!shouldNotify) {
                return CompletableFuture.completedFuture(null);
            }
            return commandDispatcher.send(new SendAllCoursesFullyBookedNotification(FACULTY_ID), Object.class); <i class="conum" data-value="8"></i><b>(8)</b>
        }

    }</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Event handler class that monitors relevant events</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>React to student subscriptions - might trigger notification if this makes all courses full</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Load current state to evaluate condition</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>React to capacity changes - might affect whether all courses are full</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Common logic to check condition and send command if needed</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Business rule: all courses must be fully booked</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Only notify if condition is met AND we haven&#8217;t notified before</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Send command to trigger notification (which goes to command handler above). The <code>CommandDispatcher</code> allows to execute the command within the current <code>ProcessingContext</code>.</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_step_5_configuration"><a class="anchor" href="#_step_5_configuration"></a>Step 5: Configuration</h3>
<div class="paragraph">
<p>Now we need to configure all the components - the event-sourced entity, command handler, and event processor:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/io/axoniq/demo/university/faculty/automation/allcoursesfullybookednotifier/AllCoursesFullyBookedNotifierConfiguration.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class AllCoursesFullyBookedNotifierConfiguration {

    public static EventSourcingConfigurer configure(EventSourcingConfigurer configurer) {
        EntityModule&lt;String, WhenAllCoursesFullyBookedThenSendNotification.State&gt; automationState = <i class="conum" data-value="1"></i><b>(1)</b>
                EventSourcedEntityModule.autodetected(String.class, WhenAllCoursesFullyBookedThenSendNotification.State.class);

        PooledStreamingEventProcessorModule automationProcessor = EventProcessorModule <i class="conum" data-value="2"></i><b>(2)</b>
                .pooledStreaming("Automation_WhenAllCoursesFullyBookedThenSendNotification_Processor")
                .eventHandlingComponents(
                        c -&gt; c.autodetected(cfg -&gt; new WhenAllCoursesFullyBookedThenSendNotification.AutomationEventHandler()) <i class="conum" data-value="3"></i><b>(3)</b>
                )
                .notCustomized();

        var commandHandlingModule = CommandHandlingModule.named("SendAllCoursesFullyBookedCommandHandler") <i class="conum" data-value="4"></i><b>(4)</b>
                .commandHandlers()
                .annotatedCommandHandlingComponent(cfg -&gt; new WhenAllCoursesFullyBookedThenSendNotification.AutomationCommandHandler()) <i class="conum" data-value="5"></i><b>(5)</b>
                .build();

        return configurer
                .componentRegistry(cr -&gt; cr.registerModule(automationState)) <i class="conum" data-value="6"></i><b>(6)</b>
                .registerCommandHandlingModule(commandHandlingModule) <i class="conum" data-value="7"></i><b>(7)</b>
                .modelling(modelling -&gt; modelling.messaging(messaging -&gt; messaging.eventProcessing(eventProcessing -&gt;
                        eventProcessing.pooledStreaming(ps -&gt; ps.processor(automationProcessor)) <i class="conum" data-value="8"></i><b>(8)</b>
                )));
    }
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Configure the event-sourced entity module for state management</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Configure the event processor for handling incoming events</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Register the event handler component</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Configure command handling module with descriptive name</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Register the command handler component</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Register the entity module for state persistence</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Register the command handling module</td>
</tr>
<tr>
<td><i class="conum" data-value="8"></i><b>8</b></td>
<td>Register the event processor module</td>
</tr>
</table>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_testing_the_stateful_event_handler"><a class="anchor" href="#_testing_the_stateful_event_handler"></a>Testing the stateful event handler</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Let&#8217;s create a comprehensive test that verifies the stateful behavior:</p>
</div>
<div class="listingblock">
<div class="title">src/test/java/io/axoniq/demo/university/faculty/automation/allcoursesfullybookednotifier/WhenAllCoursesFullyBookedThenSendNotificationTest.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class WhenAllCoursesFullyBookedThenSendNotificationAxonFixtureTest {

    private AxonTestFixture fixture;

    @BeforeEach
    void beforeEach() {
        var application = new UniversityAxonApplication();
        var sliceConfigurer = application.configurer(configurer -&gt; { <i class="conum" data-value="1"></i><b>(1)</b>
            configurer = NotificationServiceConfiguration.configure(configurer);
            return AllCoursesFullyBookedNotifierConfiguration.configure(configurer);
        });
        fixture = AxonTestFixture.with(sliceConfigurer);
    }

    @AfterEach
    void afterEach() {
        fixture.stop();
    }

    @Test
    void automationTest() {
        var studentId1 = StudentId.random();
        var studentId2 = StudentId.random();
        var courseId1 = CourseId.random();
        var courseId2 = CourseId.random();

        var expectedNotification = new NotificationService.Notification("admin", "All courses are fully booked now.");

        fixture.given()
                .events( <i class="conum" data-value="2"></i><b>(2)</b>
                        new CourseCreated(courseId1, "Course 1", 2), // Create course with capacity 2
                        new CourseCreated(courseId2, "Course 2", 2), // Create course with capacity 2
                        new StudentSubscribedToCourse(studentId1, courseId1), // Fill first course
                        new StudentSubscribedToCourse(studentId2, courseId1),
                        new StudentSubscribedToCourse(studentId1, courseId2), // Fill second course
                        new StudentSubscribedToCourse(studentId2, courseId2)  // This should trigger notification
                )
                .then()
                .await(r -&gt; r.expect(cfg -&gt; assertNotificationSent(cfg, expectedNotification)));
    }

    private void assertNotificationSent(Configuration configuration, NotificationService.Notification expectedNotification) {
        var notificationService = (RecordingNotificationService) configuration.getComponent(NotificationService.class);
        assertThat(notificationService.sent()).contains(expectedNotification); <i class="conum" data-value="3"></i><b>(3)</b>
    }

}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Configure both notification service and our stateful handler</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Sequence of events that gradually fills all courses to capacity</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td><strong>Then</strong>: Verify the notification was sent when condition was met</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_key_concepts_review"><a class="anchor" href="#_key_concepts_review"></a>Key concepts review</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_stateless_vs_stateful_event_handlers"><a class="anchor" href="#_stateless_vs_stateful_event_handlers"></a>Stateless vs stateful event handlers</h3>
<table class="tableblock frame-all grid-all stretch">
<colgroup>
<col style="width: 33.3333%;">
<col style="width: 33.3333%;">
<col style="width: 33.3334%;">
</colgroup>
<thead>
<tr>
<th class="tableblock halign-left valign-top">Aspect</th>
<th class="tableblock halign-left valign-top">Stateless Event Handler</th>
<th class="tableblock halign-left valign-top">Stateful Event Handler</th>
</tr>
</thead>
<tbody>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>State Management</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">No internal state</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Maintains state across events</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Complexity</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Simple, single-event reactions</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Complex, multi-event conditions</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Use Cases</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Notifications, logging, integrations</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Read models, Process Managers / Sagas, complex conditions, monitoring</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Performance</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Fast, no state loading</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Slower due to state management</p></td>
</tr>
<tr>
<td class="tableblock halign-left valign-top"><p class="tableblock"><strong>Concurrency</strong></p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">High parallelism possible</p></td>
<td class="tableblock halign-left valign-top"><p class="tableblock">Limited by state consistency needs</p></td>
</tr>
</tbody>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_integration_with_the_main_application"><a class="anchor" href="#_integration_with_the_main_application"></a>Integration with the main application</h2>
<div class="sectionbody">
<div class="paragraph">
<p>To use this feature in your main application, register the configuration:</p>
</div>
<div class="listingblock">
<div class="title">src/main/java/io/axoniq/demo/university/UniversityAxonApplication.java</div>
<div class="content">
<pre class="highlightjs highlight"><code class="language-java hljs" data-lang="java">public class UniversityAxonApplication {

    public static ApplicationConfigurer configurer() {
        return configurer(c -&gt; {
            // Other configurations...
            NotificationServiceConfiguration.configure(c); <i class="conum" data-value="1"></i><b>(1)</b>
            AllCoursesFullyBookedNotifierConfiguration.configure(c); <i class="conum" data-value="2"></i><b>(2)</b>
        });
    }

    // rest omitted for brevity
}</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Register the notification service infrastructure</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Register the stateful automation configuration</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_summary"><a class="anchor" href="#_summary"></a>Summary</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In this section, you learned how to implement a stateful event handler for complex condition monitoring. Key takeaways:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Stateful handlers</strong> maintain state across multiple events to implement complex business logic</p>
</li>
<li>
<p><strong>Event sourcing</strong> provides reliable state management and complete auditability for the automation logic</p>
</li>
<li>
<p><strong>Event Modeling Automation pattern</strong> provides a clear way to visualize and design automated processes that monitor system state and trigger actions</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_command_based_reactions"><a class="anchor" href="#_command_based_reactions"></a>Command-based reactions</h3>
<div class="paragraph">
<p>Notice that in this example, when the automation condition is met, we trigger a <strong>Command</strong> (<code>SendAllCoursesFullyBookedNotification</code>) rather than directly calling the notification service. This demonstrates a key principle: stateful event handlers can execute any business logic and interact with other parts of your application through the Event-Driven Architecture.</p>
</div>
<div class="paragraph">
<p>This approach provides several benefits:
- <strong>Decoupling</strong>: The automation logic is separated from the notification implementation
- <strong>Flexibility</strong>: You can trigger complex business processes, not just simple notifications
- <strong>Consistency</strong>: All business operations flow through the same command handling infrastructure
- <strong>Testability</strong>: Each part can be tested independently</p>
</div>
<div class="paragraph">
<p>This pattern enables sophisticated automation scenarios: building complex dashboards, and creating intelligent alerting systems.</p>
</div>
</div>
</div>
</div>
            </article>
  </div>
</main>
</div>
      <footer class="footer">
  <div class="secondary-footer">
    <p>Copyright © 2025 AxonIQ BV. All Rights Reserved</p>
    <img referrerpolicy="no-referrer-when-downgrade" src="https://static.scarf.sh/a.png?x-pxid=e0b2b5cb-139e-4753-acab-bae43f90c5d3" />
  </div>
</footer>
<script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
<script async src="../../../_/js/vendor/page-actions.js"></script>
<script async src="../../../_/js/vendor/tabs.js" data-sync-storage-key="preferred-tab" data-sync-storage-scope="session"></script>
<script src="../../../_/js/vendor/lunr.js"></script>
<script src="../../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../../.." data-snippet-length="100" data-stylesheet="../../../_/css/search.css"></script>
<script async src="../../../search-index.js"></script>
    </div>
  </body>
</html>
