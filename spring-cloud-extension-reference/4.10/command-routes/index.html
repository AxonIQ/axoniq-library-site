<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Discovering Command Routes</title>
    <link rel="canonical" href="https://docs.axoniq.io/spring-cloud-extension-reference/4.10/command-routes/">
    <link rel="prev" href="../">
    <link rel="next" href="../internode-commands/">
    <meta name="generator" content="Antora 3.1.9">
    <link rel="stylesheet" href="../../../_/css/site.css">
    <link rel="stylesheet" href="../../../_/css/vendor/tabs.css">
    <link rel="icon" href="../../../_/img/favicon.ico" sizes="32x32">
    <link rel="icon" href="../../../_/img/icon.svg" type="image/svg+xml" media="(prefers-color-scheme: light)">
    <link rel="icon" href="../../../_/img/icon-light.svg" type="image/svg+xml" media="(prefers-color-scheme: dark)">
    <link rel="apple-touch-icon" href="../../../_/img/apple-touch-icon.png"><!-- 180Ã—180 -->
    <link rel="manifest" href="../../../_/static/manifest.webmanifest">
        <!-- Google Tag Manager -->
        <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
        new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
        j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
        'https://www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer','GTM-5QD58ZB');</script>
        <!-- End Google Tag Manager -->

    <script>var uiRootPath = '../../../_'</script>


  </head>
  <body class="article">

    <!-- Google Tag Manager (noscript) -->
    <noscript><iframe src="https://www.googletagmanager.com/ns.html?id=GTM-5QD58ZB"
    height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
    <!-- End Google Tag Manager (noscript) -->
<header class="header">
  <nav class="navbar">
    <div class="navbar-brand">
      <a class="navbar-item" href="https://docs.axoniq.io"><img src="../../../_/img/logo-dark4x.png" class="header_logo" /></a>
      <button class="navbar-burger" data-target="topbar-nav">
        <span></span>
        <span></span>
        <span></span>
      </button>
    </div>
    <div id="topbar-nav" class="navbar-menu">
      <div class="navbar-end">
        <a class="navbar-item" href="../../../home/basics/">Basics</a>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="../../../home/guides/">Guides</a>
          <div class="navbar-dropdown card">
            <a class="navbar-item" href="../../../home/guides/axon-framework">Axon Framework</a>
            <a class="navbar-item" href="../../../home/guides/axon-server">Axon Server</a>
          </div>
        </div>
        <div class="navbar-item has-dropdown is-hoverable">
          <a class="navbar-link" href="../../../home/reference/">Reference</a>
          <div class="navbar-dropdown card">
                <a class="navbar-item" href="../../../axon-framework-reference/4.10/">Axon Framework</a>
                <a class="navbar-item" href="../../../axon-framework-extensions/">Axon Framework Extensions</a>
                <a class="navbar-item" href="../../../axon-server-reference/v2024.1/">Axon Server</a>
                <a class="navbar-item" href="../../../synapse-reference/v0.11/">Axon Synapse</a>
                <a class="navbar-item" href="../../../axoniq-console-reference/">AxonIQ Console</a>
          </div>
        </div>
      </div>
      <div class="navbar-end">
        <div class="navbar-item search hide-for-print">
          <div id="search-field" class="field">
            <input id="search-input" type="text" placeholder="Search AxonIQ Docs">
          </div>
        </div>
        <a class="navbar-item navbar-button" href="https://academy.axoniq.io" target="_blank">AxonIQ Academy</a>
        <a class="navbar-item navbar-button" href="https://discuss.axoniq.io" target="_blank">AxonIQ Discuss</a>
        <a class="navbar-item navbar-button" href="https://console.axoniq.io" target="_blank">AxonIQ Console</a>
      </div>
    </div>
  </nav>
</header>
<div class="toolbar card" role="navigation">
<button class="nav-toggle"></button>
  <a href="../../../home/" class="home-link"></a>
<nav class="breadcrumbs" aria-label="breadcrumbs">
  <ul>
    <li><a href="../">Spring Cloud Extension Guide </a></li>
    <li><a href="./">Discovering Command Routes</a></li>
  </ul>
</nav>
<div class="page-actions">
  <button class="actions-menu-toggle" title="Show actions related to this page">Actions</button>
  <div class="actions-menu toolbar_dropdown_menu card">
      <a class="action item" href="https://github.com/AxonFramework/extension-springcloud/edit/axon-springcloud-4.10.x/docs/reference/modules/ROOT/pages/command-routes.adoc">Edit this Page</a>
    
    <a class="action item" href="https://discuss.axoniq.io/search?q&#x3D;Discovering%20Command%20Routes" target="discuss_search">View Discussions</a>
    <a class="action item" href="https://discuss.axoniq.io/new-topic?category&#x3D;library&amp;title&#x3D;%22Discovering%20Command%20Routes%22%20Discussion&amp;body&#x3D;%3C!--%20Replace%20this%20comment%20with%20your%20comment%2Fsuggestion%2Fquestion%2F...%20--%3E%0A%0A%0A%3C!--%0AKeep%20the%20section%20below!%0ALinking%20back%20to%20the%20documentation%20URL%20not%20only%20helps%20people%20go%20to%20the%20page%0Abut%20also%20helps%20find%20relevant%20discussions%20from%20the%20documentation%20page%20via%20the%20%22View%20Discussion%22%20menu.%0A--%3E%0A%5Bdetails%3D%22Related%20library%20page%22%5D%0A%5BDiscovering%20Command%20Routes%5D(https%3A%2F%2Fdocs.axoniq.io%2Fspring-cloud-extension-reference%2F4.10%2Fcommand-routes%2F)%0A%5B%2Fdetails%5D%0A" target="discuss_add">Start new discussion</a>
  </div>
</div>


</div>
<div class="body">
<div class="nav-container" data-component="spring-cloud-extension-reference" data-version="4.10">
  <aside class="nav card">
    <div class="panels">
<div class="nav-panel-menu is-active" data-panel="menu">
  <nav class="nav-menu">
    <h3 class="title"><a href="../">Spring Cloud Extension Guide</a></h3>

<ul class="nav-list">
  <li class="nav-item" data-depth="0">
<ul class="nav-list">
  <li class="nav-item is-current-page" data-depth="1">
    <a class="nav-link" href="./">Discovering Command Routes</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../internode-commands/">Sending Commands between Nodes</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../config/">Configuring This Extension</a>
  </li>
  <li class="nav-item" data-depth="1">
    <a class="nav-link" href="../release-notes/">Release notes</a>
  </li>
</ul>
  </li>
</ul>
  </nav>
</div>
    </div>
  </aside>
</div>
<main class="article">
    <div class="content">
        <aside class="toc sidebar" data-title="Contents" data-levels="2">
  <div class="toc-menu"></div>
</aside>
          <article class="doc">
            <h1 class="page">Discovering Command Routes</h1>
            <div class="paragraph">
<p>The <code>SpringCloudCommandRouter</code> uses Spring Cloud&#8217;s discovery mechanism to find the other nodes in the cluster. To that end it uses the <code>DiscoveryClient</code> and <code>Registration</code> from Spring Cloud. These are respectively used to gather remote command routing information and maintain local information. The most straightforward way to retrieve both is by annotating your application with <code>@EnableDiscoveryClient</code>.</p>
</div>
<div class="paragraph">
<p>Gathering and storing the command routing information revolves around Spring Cloud&#8217;s <code>ServiceInstances</code>. A <code>Registration</code> is just the local <code>ServiceInstance</code>, whereas the <code>DiscoveryClient</code> provides the API to find remote <code>ServiceInstances</code>. Furthermore, it is the <code>ServiceInstance</code> which provides us with the required information (for example, the URI) to retrieve a node&#8217;s capabilities.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Spring Cloud&#8217;s Heartbeat Requirement</div>
<div class="paragraph">
<p>When using the <code>SpringCloudCommandRouter</code>, make sure your Spring application has heartbeat events enabled. The heartbeat events published by a Spring Cloud application are the trigger to check if the set of <code>ServiceInstances</code> from the <code>DiscoveryClient</code> has been changed. Additionally, it is used to validate whether the command routing capabilities for known nodes has been altered.</p>
</div>
<div class="paragraph">
<p>Thus, if heartbeat events are disabled, your instance will no longer be updated with the current command routing capabilities. If so, this will cause issues during command routing.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The logic to store the local capabilities and discovering the remote capabilities of a <code>ServiceInstance</code> is maintained in the <code>CapabilityDiscoveryMode</code>. It is thus the <code>CapabilityDiscoveryMode</code> which provides us the means to actually retrieve a <code>ServiceInstance</code> 's set of commands it can handle (if any). The sole full implementation provided of the <code>CapabilityDiscoveryMode</code>, is the <code>RestCapabilityDiscoveryMode</code>, using a <code>RestTemplate</code> and the <code>ServiceInstance</code> URI to invoke a configurable endpoint. This endpoint leads to the <code>MemberCapabilitiesController</code> which in turn exposes the <code>MemberCapabilities</code> on the <code>RestCapabilityDiscoveryMode</code> of that instance.</p>
</div>
<div class="paragraph">
<p>There are decorators present for the <code>CapabilityDiscoveryMode</code>, providing two additional features:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><code>IgnoreListingDiscoveryMode</code> - a <code>CapabilityDiscoveryMode</code> decorator which on failure of retrieving the <code>MemberCapabilities</code> will place the given <code>ServiceInstance</code> on a list to be ignored for future validation. It thus effectively removes discoverable <code>ServiceInstances</code> from the set.</p>
</li>
<li>
<p><code>AcceptAllCommandsDiscoveryMode</code> - a <code>CapabilityDiscoveryMode</code> decorator which regardless of what this instance can handle as commands, state it can handle anything. This decorator comes in handy if the nodes in the system are homogeneous (aka, everybody can handle the same set of commands).</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>The <code>Registration</code>, <code>DiscoveryClient</code> and <code>CapabilityDiscoveryMode</code> are arguably the heart of the <code>SpringCloudCommandRouter</code>. There are, however, a couple of additional things you can configure for this router, which are the following:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>RoutingStrategy</code> - The component in charge of deciding which of the nodes receives the commands consistently. By default, a <code>AnnotationRoutingStrategy</code> is used (see <a href="../../../axon-framework-reference/4.10/axon-framework-commands/infrastructure/#DistributedCommandBus" class="xref page">Distributing the Command Bus</a> for more).</p>
</li>
<li>
<p>A <code>ServiceInstance</code> filter - This <code>Predicate</code> is used to filter out <code>ServiceInstance</code> retrieved through the <code>DiscoveryClient</code>. For example, it allows the removal of instances which are known to not handle any command messages. This might be useful if you have several services within the Spring Cloud Discovery Service set up, which you do not ever want to take into account for command handling.</p>
</li>
<li>
<p><code>ConsistentHashChangeListener</code> - Adding a consistent hash change listener provides you with the opportunity to perform a specific task if new nodes have been added to the known command handlers set.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="title">Differing Command Capabilities per Node</div>
<div class="paragraph">
<p>It is not required for all nodes to have the same set of command handlers. You may use different segments for different command types altogether. The Distributed Command Bus will always choose a node to dispatch a command to the one that has support for that specific type of command.</p>
</div>
</td>
</tr>
</table>
</div>
        <nav class="pagination">
  <span class="prev"><a href="../">Spring Cloud Extension Guide</a></span>
  <span class="next"><a href="../internode-commands/">Sending Commands between Nodes</a></span>
</nav>
    </article>
  </div>
</main>
</div>
<footer class="footer">
  <div class="primary-footer">
    <div class="footer-logo ">
      <a href="https://axoniq.io/">
        <img src="https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=90&amp;height=20&amp;name=Logo%20AxonIQ%20(2).png" alt="Logo AxonIQ" loading="lazy" srcset="https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=45&amp;height=10&amp;name=Logo%20AxonIQ%20(2).png 45w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=90&amp;height=20&amp;name=Logo%20AxonIQ%20(2).png 90w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=135&amp;height=30&amp;name=Logo%20AxonIQ%20(2).png 135w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=180&amp;height=40&amp;name=Logo%20AxonIQ%20(2).png 180w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=225&amp;height=50&amp;name=Logo%20AxonIQ%20(2).png 225w, https://www.axoniq.io/hs-fs/hubfs/Logo%20AxonIQ%20(2).png?width=270&amp;height=60&amp;name=Logo%20AxonIQ%20(2).png 270w" sizes="(max-width: 90px) 100vw, 90px" width="90" height="20">
      </a>
    </div>

    <div class="footer-menu">
	    <h3>Products</h3>
	    <div>
        <ul role="menu">
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/products/axon-framework">Axon Framework</a></li>
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/products/axon-server">Axon Server</a></li>
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/products/axoniq-cloud">AxonIQ Cloud</a></li>
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/products/axoniq-console">AxonIQ Console</a></li>
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/products/axon-synapse">Axon Synapse</a></li>
          <li><a class="ext" target="_blank" href="https://www.axoniq.io/blog/protect-sensitive-data-in-an-event-sourced-application">AxonIQ Data Protection</a></li>
        </ul>
      </div>
    </div>

    <div class="footer-menu">
	    <h3>Sites</h3>
	    <div>
        <ul role="menu">
          <li><a class="ext" target="_blank" href="http://support.axoniq.io/">Customer Support Portal</a></li>
          <li><a class="ext" target="_blank" href="https://academy.axoniq.io/">AxonIQ Academy</a></li>
          <li><a class="ext" target="_blank" href="https://console.axoniq.io/">AxonIQ Console</a></li>
          <li><a class="ext" target="_blank" href="https://discuss.axoniq.io/">AxonIQ Discuss</a></li>
          <li><a class="ext" target="_blank" href="https://console.cloud.axoniq.io">AxonIQ Cloud</a></li>
        </ul>
      </div>
    </div>

    <div class="footer-menu">
	    <h3>Follow us</h3>
	    <div>
        <ul role="menu">
          <li><a class="ext" target="_blank" href="https://www.youtube.com/axoniq">YouTube</a></li>
          <li><a class="ext" target="_blank" href="https://www.linkedin.com/company/axoniq">LinkedIn</a></li>
          <li><a class="ext" target="_blank" href="https://www.facebook.com/AxonIQ.io">Facebook</a></li>
          <li><a class="ext" target="_blank" href="https://twitter.com/axon_iq">Twitter</a></li>
          <li><a class="ext" target="_blank" href="https://github.com/AxonIQ">GitHub</a></li>
          <li><a class="ext" target="_blank" href="https://medium.com/axoniq">Medium</a></li>
        </ul>
      </div>
    </div>
  </div>
</footer>
<script id="site-script" src="../../../_/js/site.js" data-ui-root-path="../../../_"></script>
<script async src="../../../_/js/vendor/highlight.js"></script>
<script async src="../../../_/js/vendor/page-actions.js"></script>
<script async src="../../../_/js/vendor/tabs.js" data-sync-storage-key="preferred-tab" data-sync-storage-scope="session"></script>
<script src="../../../_/js/vendor/lunr.js"></script>
<script src="../../../_/js/search-ui.js" id="search-ui-script" data-site-root-path="../../.." data-snippet-length="100" data-stylesheet="../../../_/css/search.css"></script>
<script async src="../../../search-index.js"></script>
  </body>
</html>
